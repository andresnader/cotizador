<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Cotización v12 (Google API)</title> <!-- v12 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <!-- --- GOOGLE API --- -->
    <!-- Scripts movidos al final del body -->
    <!-- --- FIN GOOGLE API --- -->

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        #logoPreview {
            max-width: 200px;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 40px;
        	height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: 1px solid #ddd;
            border-radius: 50%;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-Aceptada { background-color: #dcfce7; color: #166534; }
        .status-Pendiente { background-color: #fef9c3; color: #854d0e; }
        .status-Rechazada { background-color: #fee2e2; color: #991b1b; }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #4f46e5;
            animation: spin 1s ease infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* --- ESTILOS PARA EL MODAL PERSONALIZADO --- */
        .modal-overlay {
            visibility: hidden;
            opacity: 0;
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: opacity 0.2s ease-in-out, visibility 0.2s ease-in-out;
        }
        .modal-overlay.visible {
            visibility: visible;
            opacity: 1;
        }
        .modal-container {
            background-color: white;
            padding: 2rem;
            border-radius: 0.75rem;
            box-shadow: 0 20px 25px -5px rgb(0 0 0 / 0.1), 0 8px 10px -6px rgb(0 0 0 / 0.1);
            width: 100%;
            max-width: 450px;
            transform: scale(0.95);
            opacity: 0;
            transition: all 0.2s ease-in-out;
        }
        .modal-overlay.visible .modal-container {
            transform: scale(1);
            opacity: 1;
        }
        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 0.75rem;
        }
        .modal-body {
            font-size: 0.95rem;
            color: #4b5563;
            margin-bottom: 1.5rem;
            white-space: pre-wrap; /* Respeta saltos de línea en el mensaje */
        }
        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }
        .modal-button {
            padding: 0.6rem 1.2rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: all 0.2s;
            cursor: pointer;
            border: none;
        }
        .modal-button-primary {
            background-color: #4f46e5;
            color: white;
        }
        .modal-button-primary:hover {
            background-color: #4338ca;
        }
        .modal-button-secondary {
            background-color: #e5e7eb;
            color: #374151;
        }
        .modal-button-secondary:hover {
            background-color: #d1d5db;
        }
        /* --- FIN ESTILOS MODAL --- */

        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- --- GOOGLE API --- -->
    <!-- Pantalla de Bloqueo MODIFICADA para Google Sign-In -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-gray-800 mb-4">Acceso al Cotizador</h2>
            <p class="text-gray-600 mb-6">Inicia sesión con tu cuenta de Google para acceder a los datos.</p>
            <!-- Botón deshabilitado hasta que las APIs estén listas -->
            <button id="google-login-btn" disabled class="bg-blue-600 text-white py-3 px-6 rounded-lg hover:bg-blue-700 transition duration-300 font-semibold flex items-center justify-center w-full disabled:opacity-50 disabled:cursor-not-allowed">
                <i class="fab fa-google mr-3"></i>
                Iniciar Sesión con Google
            </button>
            <div id="loading-spinner" class="spinner mx-auto mt-6" style="display: none;"></div>
            <p id="auth-status" class="text-sm text-gray-500 mt-4">Cargando APIs de Google...</p>
        </div>
    </div>
    <!-- --- FIN GOOGLE API --- -->


    <!-- Contenido Principal de la App (inicialmente oculto) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8" style="display: none;">
        
        <header class="flex justify-between items-center mb-8">
            <div>
                <h1 class="text-4xl font-bold text-gray-900">Herramienta de Cotización y Gestión</h1>
                <p class="text-lg text-gray-600 mt-2">Conectado a Google Drive</p>
            </div>
            <div class="no-print">
                <p id="user-email" class="text-sm text-gray-600"></p>
                <button id="google-logout-btn" class="text-sm text-blue-600 hover:underline">Cerrar Sesión</button>
            </div>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6 border-b border-gray-200 no-print">
            <nav class="flex flex-wrap -mb-px space-x-2 md:space-x-4" aria-label="Tabs">
                <button class="tab-button active text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'cotizador')"><i class="fas fa-file-invoice-dollar mr-2"></i>Cotizador</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'dashboard')"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'historial')"><i class="fas fa-history mr-2"></i>Historial</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'contratos')"><i class="fas fa-file-signature mr-2"></i>Contratos</button>
                 <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'portal')"><i class="fas fa-user-check mr-2"></i>Portal Cliente</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'clientes')"><i class="fas fa-users mr-2"></i>Clientes</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'servicios')"><i class="fas fa-concierge-bell mr-2"></i>Servicios</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'configuracion')"><i class="fas fa-cog mr-2"></i>Configuración</button>
            </nav>
        </div>

        <!-- Contenido de las Pestañas -->
        <main>
            <!-- Pestaña: Cotizador -->
            <div id="cotizador" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Crear Nueva Cotización</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><label for="quoteClient" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente</label><select id="quoteClient" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <div><label for="quoteRUC" class="block text-sm font-medium text-gray-700 mb-1">RUC / C.I.</label><input type="text" id="quoteRUC" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                            <div><label for="quoteNumber" class="block text-sm font-medium text-gray-700 mb-1">Nº Cotización (previsualización)</label><input type="text" id="quoteNumber" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                            <div><label for="quoteDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Validez</label><input type="date" id="quoteDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-end gap-4 mb-6">
                            <div class="flex-grow"><label for="serviceSelect" class="block text-sm font-medium text-gray-700 mb-1">Añadir Servicio</label><select id="serviceSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <button onclick="addServiceToQuote()" class="w-full md:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-sm"><i class="fas fa-plus mr-2"></i>Añadir</button>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio / Descripción</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Cantidad</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Unitario</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th></tr></thead><tbody id="quoteItems" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                        <div class="mt-6">
                            <label for="quoteNotes" class="block text-sm font-medium text-gray-700">Notas Adicionales para esta Cotización</label>
                            <textarea id="quoteNotes" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Términos y condiciones, detalles específicos del proyecto..."></textarea>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Resumen</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600">Subtotal:</span><span id="subtotal" class="font-semibold text-gray-900">$0.00</span></div>
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600">IVA (15%):</span><span id="iva" class="font-semibold text-gray-900">$0.00</span></div>
                            <hr>
                            <div class="flex justify-between items-center text-2xl font-bold"><span id="total-label" class="text-indigo-600">TOTAL:</span><span id="total" class="text-indigo-600">$0.00</span></div>
                        </div>
                        <div class="mt-8">
                            <button onclick="generatePrintableQuote(false)" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg text-lg font-semibold mb-3">
                                <i class="fas fa-print mr-2"></i>Generar, Guardar y Imprimir
                            </button>
                            <button onclick="generatePrintableQuote(true)" class="w-full bg-blue-600 text-white px-4 py-3 rounded-lg hover:bg-blue-700 transition duration-300 shadow-lg text-lg font-semibold">
                                <i class="fab fa-google-drive mr-2"></i>Generar y Guardar en Drive
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Dashboard -->
            <div id="dashboard" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Dashboard de Ventas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-green-100 p-4 rounded-lg text-center"><p class="text-sm text-green-800 font-semibold">VENTAS (ACEPTADAS)</p><p id="total-sales" class="text-3xl font-bold text-green-600">$0.00</p></div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-sm text-blue-800 font-semibold">TICKET PROMEDIO</p><p id="average-sale" class="text-3xl font-bold text-blue-600">$0.00</p></div>
                        <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-sm text-yellow-800 font-semibold">PRODUCTO MÁS VENDIDO</p><p id="best-seller" class="text-xl md:text-2xl font-bold text-yellow-600">-</p></div>
                        <div class="bg-indigo-100 p-4 rounded-lg text-center"><p class="text-sm text-indigo-800 font-semibold">COTIZACIONES TOTALES</p><p id="total-quotes" class="text-3xl font-bold text-indigo-600">0</p></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Ventas por Mes</h3>
                        <div id="sales-chart-container" class="w-full h-80 bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Historial -->
            <div id="historial" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Historial de Cotizaciones (Desde Google Sheets)</h2>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº Cotización</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="quotesHistoryList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>

            <!-- Pestaña: Contratos -->
            <div id="contratos" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Gestión de Contratos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <label for="contract-client-select" class="block text-sm font-medium text-gray-700 mb-1">1. Seleccione un Cliente</label>
                            <select id="contract-client-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                            <label for="contract-quote-select" class="block text-sm font-medium text-gray-700 mt-4 mb-1">2. Seleccione Cotización Aceptada</label>
                            <select id="contract-quote-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                             <label for="contract-text" class="block text-sm font-medium text-gray-700 mb-1">3. Redacte el contrato (se guardará en Google Docs)</label>
                             <textarea id="contract-text" rows="10" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Contenido del contrato..."></textarea>
                             <button id="save-contract-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition" disabled>Guardar Contrato en Google Docs</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña: Portal Cliente -->
            <div id="portal" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Vista Portal Cliente</h2>
                    <div class="max-w-md mb-6">
                        <label for="portal-client-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccione un cliente para ver su portal</label>
                        <select id="portal-client-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div id="client-portal-content" class="mt-4 border-t pt-4">
                        <p class="text-gray-500">Seleccione un cliente para empezar.</p>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Clientes -->
            <div id="clientes" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Añadir/Editar Cliente</h2>
                        <form id="clientForm" class="space-y-4"><input type="hidden" id="clientId">
                            <!-- --- GOOGLE API --- -->
                            <!-- 'clientId' ahora será el 'rowId' de Google Sheets para saber qué fila editar -->
                            <input type="hidden" id="clientRowId">
                            <!-- --- FIN GOOGLE API --- -->
                            <!-- CAMPO ELIMINADO: Código de Cliente (no está en tu Sheet) -->
                            <div><label for="clientName" class="block text-sm font-medium text-gray-700">Razón Social</label><input type="text" id="clientName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <div><label for="clientRUC" class="block text-sm font-medium text-gray-700">RUC / C.I. (Identificación No.)</label><input type="text" id="clientRUC" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <div><label for="clientContact" class="block text-sm font-medium text-gray-700">Contacto (Email o Teléfono)</label><input type="text" id="clientContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <!-- CAMPO IGNORADO: clientCode (no se usa) -->
                            <input type="hidden" id="clientCode">
                            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Cliente en Google Sheets</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Lista de Clientes (Desde Google Sheets)</h2>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">RUC / C.I.</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Razón Social</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contacto</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="clientList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Servicios -->
            <div id="servicios" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Añadir/Editar Servicio</h2>
                        <form id="serviceForm" class="space-y-4">
                            <input type="hidden" id="serviceId">
                            <!-- --- GOOGLE API --- -->
                            <input type="hidden" id="serviceRowId">
                            <!-- --- FIN GOOGLE API --- -->
                            <!-- Campo serviceName se mapeará a 'description' en el Sheet -->
                            <div><label for="serviceName" class="block text-sm font-medium text-gray-700">Nombre/Descripción del Servicio</label><input type="text" id="serviceName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <!-- Campo Oculto: serviceDescription (no está en tu sheet) -->
                            <textarea id="serviceDescription" rows="4" class="hidden"></textarea>
                            <div><label for="servicePrice" class="block text-sm font-medium text-gray-700">Precio Unitario ($)</label><input type="number" step="0.01" id="servicePrice" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Servicio en Google Sheets</button></form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Lista de Servicios (Desde Google Sheets)</h2>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servicio (Descripción)</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="serviceList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Configuración -->
            <div id="configuracion" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Configuración de la Empresa y Cotización</h2>
                    <p class="text-sm text-gray-600 mb-4">Esta configuración se sigue guardando localmente en tu navegador. Puedes moverla a una hoja de "Configuración" de Google Sheets si lo deseas.</p>
                    <form id="configForm" class="space-y-6">
                        <div><label for="companyName" class="block text-sm font-medium text-gray-700">Nombre de la Empresa</label><input type="text" id="companyName" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyAddress" class="block text-sm font-medium text-gray-700">Dirección</label><input type="text" id="companyAddress" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyContact" class="block text-sm font-medium text-gray-700">Contacto (Email/Teléfono)</label><input type="text" id="companyContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyWebsite" class="block text-sm font-medium text-gray-700">Sitio Web (URL)</label><input type="url" id="companyWebsite" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="https://www.suempresa.com"></div>
                        <div><label for="companyWhatsapp" class="block text-sm font-medium text-gray-700">Número de WhatsApp</label><input type="tel" id="companyWhatsapp" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="593991234567"><p class="text-xs text-gray-500 mt-1">Incluir el código de país, sin el signo '+'. Ej: 593991234567</p></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="logoUpload" class="block text-sm font-medium text-gray-700">Logo de la Empresa</label>
                                <input type="file" id="logoUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Vista Previa</label>
                                <img id="logoPreview" src="https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo" alt="Vista previa del logo" class="mt-2 object-contain bg-gray-50 p-2">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Colores Corporativos</label>
                            <div class="flex items-center gap-4 mt-2">
                                <div>
                                    <label for="primaryColor" class="block text-xs font-medium text-gray-500">Primario</label>
                                    <input type="color" id="primaryColor">
                                </div>
                                <div>
                                    <label for="accentColor" class="block text-xs font-medium text-gray-500">Acento</label>
                                    <input type="color" id="accentColor">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Configuración Local</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Área de Impresión (oculta por defecto) -->
    <div id="print-area" class="p-10 bg-white"></div>

    <!-- --- INICIO MODAL PERSONALIZADO --- -->
    <div id="custom-modal-overlay" class="modal-overlay">
        <div class="modal-container">
            <h3 id="custom-modal-title" class="modal-title">Confirmación</h3>
            <p id="custom-modal-body" class="modal-body">¿Estás seguro?</p>
            <div class="modal-actions">
                <button id="custom-modal-btn-cancel" class="modal-button modal-button-secondary">Cancelar</button>
                <button id="custom-modal-btn-confirm" class="modal-button modal-button-primary">Confirmar</button>
            </div>
        </div>
    </div>
    <!-- --- FIN MODAL PERSONALIZADO --- -->


    <!-- --- GOOGLE API SCRIPT --- -->
    <script>
        // --- 1. CONFIGURACIÓN DE GOOGLE API ---
        
        // ID de Cliente (El tuyo)
        const CLIENT_ID = "1005993441268-4sle7juetquq55efkqehm252ebtml4tv.apps.googleusercontent.com";
        
        // Define los "scopes" o permisos que tu app necesita.
        const SCOPES = [
            'https://www.googleapis.com/auth/userinfo.email', // Para ver el email del usuario
            'https://www.googleapis.com/auth/userinfo.profile', // Para ver el nombre del usuario
            'https://www.googleapis.com/auth/spreadsheets', // Para leer/escribir en Google Sheets
            'https://www.googleapis.com/auth/drive' // Para crear/modificar archivos en Google Drive (Docs)
        ].join(' ');

        // *** IDs DE TUS ARCHIVOS (ACTUALIZADOS) ***
        
        // ID de tu Hoja de Clientes
        const CLIENTS_SHEET_ID = '1JnowPVvio2tSjNSmQH6z8drqejmiwwVthmkFj2eGf2g';
        // Rango de Clientes: Columnas A (RUC) a F (Email)
        const CLIENTS_SHEET_RANGE = 'Hoja 1!A2:F'; 
        
        // ID de tu Hoja de Servicios/Productos
        const SERVICES_SHEET_ID = '19FdGfh7wtznlOHsnp5Ntd9ZF2fSZLd11yUD40VP0VNI';
        // Rango de Servicios: Columnas A (id) a E (updated_at)
        const SERVICES_SHEET_RANGE = 'Hoja 1!A2:E'; 

        // IDs INSERTADOS DESDE LAS IMÁGENES
        // ID de tu Hoja de Historial de Cotizaciones
        const QUOTES_SHEET_ID = '153s8Lhum68zConWSbbFQtbR3dYzkafHy-4YQJ1HpvLk';
        // Asegúrate que esta hoja tenga una pestaña llamada 'Hoja 1' y las columnas correctas
        const QUOTES_SHEET_RANGE = 'Hoja 1!A2:K'; // Asume A=ID, B=Numero, C=Fecha Emisión, D=Fecha Validez, E=Cliente JSON, F=Items JSON, G=Total, H=Estado, I=Notas, J=Google Doc ID, K=Google PDF ID

        // ID de tu Plantilla de Contrato en Google Docs
        const CONTRACT_TEMPLATE_ID = '1MNE19Ymp40dTZ4Ulv31An3EWVRc8SW-ktD2H-dOFSa4';

        // Carpeta donde se almacenarán los documentos y PDFs generados
        const QUOTES_DRIVE_FOLDER_ID = '1mTsrPMrcLzSDapMs4m3fG_d5Q8EguEoX';


        let tokenClient;
        // let gapiInited = false; // Ya no se usan como flags globales simples
        // let gisInited = false;

        // --- DECLARACIÓN DE VARIABLES GLOBALES DE ELEMENTOS DEL DOM ---
        let loginOverlay, appContainer, authStatus, loginButton, logoutButton, loadingSpinner;
        let clientForm, clientList, clientRowIdInput, clientNameInput, clientRUCInput, clientContactInput;
        let serviceForm, serviceList, serviceRowIdInput, serviceNameInput, serviceDescriptionInput, servicePriceInput, serviceIdInput;
        let quotesHistoryList;
        let quoteClientSelect, quoteRUCInput, serviceSelect, quoteItemsBody, quoteNumberInput, quoteNotesInput, quoteDate;
        let configForm, companyNameInput, companyAddressInput, companyContactInput, companyWebsiteInput, companyWhatsappInput, logoUploadInput, logoPreview, primaryColorInput, accentColorInput;
        let contractClientSelect, contractQuoteSelect, contractText, saveContractBtn;
        let portalClientSelect, clientPortalContent;

        // --- INICIO: LÓGICA DE MODAL PERSONALIZADO ---
        let modalOverlay, modalTitle, modalBody, modalBtnConfirm, modalBtnCancel;
        let confirmCallback = null;

        function initModal() {
            modalOverlay = document.getElementById('custom-modal-overlay');
            modalTitle = document.getElementById('custom-modal-title');
            modalBody = document.getElementById('custom-modal-body');
            modalBtnConfirm = document.getElementById('custom-modal-btn-confirm');
            modalBtnCancel = document.getElementById('custom-modal-btn-cancel');

            if (modalOverlay) {
                modalOverlay.addEventListener('click', (e) => {
                    if (e.target === modalOverlay) {
                        hideModal();
                    }
                });
            }
            if (modalBtnCancel) {
                modalBtnCancel.addEventListener('click', hideModal);
            }
            if (modalBtnConfirm) {
                modalBtnConfirm.addEventListener('click', () => {
                    if (typeof confirmCallback === 'function') {
                        confirmCallback();
                    }
                    hideModal();
                });
            }
        }

        function hideModal() {
            if (modalOverlay) modalOverlay.classList.remove('visible');
            confirmCallback = null; // Limpiar callback
        }

        /**
         * Muestra una alerta no bloqueante.
         * @param {string} message El mensaje a mostrar.
         * @param {string} [title='Alerta'] El título opcional del modal.
         */
        function showAlert(message, title = 'Alerta') {
            if (!modalOverlay || !modalTitle || !modalBody || !modalBtnConfirm || !modalBtnCancel) {
                console.error("Modal no inicializado, usando alert() como fallback.");
                alert(message); // Fallback si el modal no existe
                return;
            }
            modalTitle.innerText = title;
            modalBody.innerText = message;
            modalBtnConfirm.innerText = 'Aceptar';
            modalBtnCancel.style.display = 'none'; // Ocultar botón de cancelar
            confirmCallback = null; // Es una alerta, no hay callback de confirmación
            modalOverlay.classList.add('visible');
        }

        /**
         * Muestra una confirmación no bloqueante.
         * @param {string} message El mensaje de confirmación.
         * @param {function} onConfirm El callback que se ejecutará si el usuario confirma.
         * @param {string} [title='Confirmación'] El título opcional del modal.
         */
        function showConfirm(message, onConfirm, title = 'Confirmación') {
            if (!modalOverlay || !modalTitle || !modalBody || !modalBtnConfirm || !modalBtnCancel) {
                console.error("Modal no inicializado, cancelando acción.");
                // No podemos usar confirm() aquí porque esperamos un callback.
                // Lo más seguro es no ejecutar la acción.
                return;
            }
            modalTitle.innerText = title;
            modalBody.innerText = message;
            modalBtnConfirm.innerText = 'Confirmar';
            modalBtnCancel.style.display = 'inline-block'; // Mostrar botón de cancelar
            confirmCallback = onConfirm; // Asignar el callback
            modalOverlay.classList.add('visible');
        }
        // --- FIN: LÓGICA DE MODAL PERSONALIZADO ---

        function arrayBufferToBase64(buffer) {
            if (!buffer) return '';
            if (typeof buffer === 'string') {
                return btoa(buffer);
            }
            let binary = '';
            const bytes = buffer instanceof ArrayBuffer ? new Uint8Array(buffer) : new Uint8Array(buffer.buffer || buffer);
            const chunkSize = 0x8000;
            for (let i = 0; i < bytes.length; i += chunkSize) {
                const chunk = bytes.subarray(i, i + chunkSize);
                binary += String.fromCharCode.apply(null, chunk);
            }
            return btoa(binary);
        }

        async function savePdfToDriveFromDoc(docId, pdfName) {
            if (!docId) return null;
            if (!gapi?.client?.drive) {
                throw new Error('API de Google Drive no está lista para exportar el PDF.');
            }
            if (!QUOTES_DRIVE_FOLDER_ID) {
                console.warn('QUOTES_DRIVE_FOLDER_ID no está configurado. Se omitirá el guardado del PDF.');
                return null;
            }

            const exportResponse = await gapi.client.request({
                path: `/drive/v3/files/${docId}/export`,
                method: 'GET',
                params: { mimeType: 'application/pdf' },
                responseType: 'arraybuffer'
            });

            const pdfData = exportResponse.body;
            if (!pdfData) {
                console.warn('No se recibió contenido al exportar el documento a PDF.');
                return null;
            }

            const metadata = {
                name: pdfName,
                mimeType: 'application/pdf',
                parents: [QUOTES_DRIVE_FOLDER_ID]
            };

            const boundary = '-------314159265358979323846';
            const delimiter = `\r\n--${boundary}\r\n`;
            const closeDelimiter = `\r\n--${boundary}--`;
            const base64Data = arrayBufferToBase64(pdfData);

            const multipartRequestBody =
                delimiter + 'Content-Type: application/json; charset=UTF-8\r\n\r\n' +
                JSON.stringify(metadata) +
                delimiter + 'Content-Type: application/pdf\r\n' +
                'Content-Transfer-Encoding: base64\r\n\r\n' +
                base64Data +
                closeDelimiter;

            const uploadResponse = await gapi.client.request({
                path: '/upload/drive/v3/files',
                method: 'POST',
                params: { uploadType: 'multipart' },
                headers: { 'Content-Type': `multipart/related; boundary=${boundary}` },
                body: multipartRequestBody
            });

            return uploadResponse.result?.id || null;
        }

        async function trashDriveFile(fileId) {
            if (!fileId || !gapi?.client?.drive) return;
            try {
                await gapi.client.drive.files.update({
                    fileId,
                    resource: { trashed: true }
                });
            } catch (error) {
                console.error('Error enviando archivo a la papelera en Drive:', error);
            }
        }


        // --- FUNCIÓN PARA ASIGNAR ELEMENTOS DEL DOM ---
        function assignDOMElements() {
            // ... (asignaciones iguales que antes)...
            loginOverlay = document.getElementById('login-overlay');
            appContainer = document.getElementById('app-container');
            authStatus = document.getElementById('auth-status');
            loginButton = document.getElementById('google-login-btn');
            logoutButton = document.getElementById('google-logout-btn');
            loadingSpinner = document.getElementById('loading-spinner');
            
            clientForm = document.getElementById('clientForm');
            clientList = document.getElementById('clientList');
            clientRowIdInput = document.getElementById('clientRowId'); 
            clientNameInput = document.getElementById('clientName');
            clientRUCInput = document.getElementById('clientRUC');
            clientContactInput = document.getElementById('clientContact');
            
            serviceForm = document.getElementById('serviceForm');
            serviceList = document.getElementById('serviceList');
            serviceRowIdInput = document.getElementById('serviceRowId');
            serviceIdInput = document.getElementById('serviceId'); // Asignar serviceIdInput
            serviceNameInput = document.getElementById('serviceName');
            serviceDescriptionInput = document.getElementById('serviceDescription');
            servicePriceInput = document.getElementById('servicePrice');
            
            quotesHistoryList = document.getElementById('quotesHistoryList');
            
            quoteClientSelect = document.getElementById('quoteClient');
            quoteRUCInput = document.getElementById('quoteRUC');
            serviceSelect = document.getElementById('serviceSelect');
            quoteItemsBody = document.getElementById('quoteItems');
            quoteNumberInput = document.getElementById('quoteNumber');
            quoteNotesInput = document.getElementById('quoteNotes');
            quoteDate = document.getElementById('quoteDate'); // Asignar quoteDate
            
            configForm = document.getElementById('configForm');
            companyNameInput = document.getElementById('companyName');
            companyAddressInput = document.getElementById('companyAddress');
            companyContactInput = document.getElementById('companyContact');
            companyWebsiteInput = document.getElementById('companyWebsite');
            companyWhatsappInput = document.getElementById('companyWhatsapp');
            logoUploadInput = document.getElementById('logoUpload');
            logoPreview = document.getElementById('logoPreview');
            primaryColorInput = document.getElementById('primaryColor');
            accentColorInput = document.getElementById('accentColor');
            
            contractClientSelect = document.getElementById('contract-client-select');
            contractQuoteSelect = document.getElementById('contract-quote-select');
            contractText = document.getElementById('contract-text');
            saveContractBtn = document.getElementById('save-contract-btn');
            
            portalClientSelect = document.getElementById('portal-client-select');
            clientPortalContent = document.getElementById('client-portal-content');

            // --- AÑADIR EVENT LISTENERS ---
             // Añadir listeners SOLO si el elemento existe para evitar errores
            if (loginButton) loginButton.addEventListener('click', handleAuthClick);
            if (logoutButton) logoutButton.addEventListener('click', handleSignoutClick);
            if (clientForm) clientForm.addEventListener('submit', handleClientFormSubmit);
            if (serviceForm) serviceForm.addEventListener('submit', handleServiceFormSubmit);
            if (saveContractBtn) saveContractBtn.addEventListener('click', handleSaveContractClick);
            if (configForm) configForm.addEventListener('submit', handleConfigFormSubmit);
            if (logoUploadInput) logoUploadInput.addEventListener('change', handleLogoUploadChange);
            if (quoteClientSelect) quoteClientSelect.addEventListener('change', handleQuoteClientChange);
            if (contractClientSelect) contractClientSelect.addEventListener('change', handleContractClientChange);
            if (contractQuoteSelect) contractQuoteSelect.addEventListener('change', handleContractQuoteChange);
            if (portalClientSelect) portalClientSelect.addEventListener('change', handlePortalClientChange);
        }

        // --- 2. LÓGICA DE AUTENTICACIÓN (AUTH) - REESTRUCTURADA ---

        // Función principal para inicializar GAPI y GIS
        async function initializeApp() {
            console.log("initializeApp: Iniciando...");
            if (authStatus) authStatus.innerText = 'Cargando Google API Client (GAPI)...';

            // Cargar GAPI Client
            await new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = 'https://apis.google.com/js/api.js';
                script.async = true;
                script.defer = true;
                script.onload = () => {
                    console.log("GAPI script cargado.");
                    // Ahora cargar la biblioteca 'client' de GAPI
                    gapi.load('client', {
                         callback: async () => {
                             console.log("GAPI 'client' library cargada.");
                             try {
                                 await gapi.client.init({
                                     // No se necesita apiKey si solo usamos OAuth
                                     discoveryDocs: [
                                         'https://sheets.googleapis.com/$discovery/rest?version=v4',
                                         'https://www.googleapis.com/discovery/v1/apis/drive/v3/rest',
                                         'https://docs.googleapis.com/$discovery/rest?version=v1'
                                     ],
                                 });
                                 console.log("GAPI client inicializado.");
                                 resolve(); // Resuelve la promesa GAPI
                             } catch (err) {
                                  console.error("Error inicializando GAPI client:", err);
                                  if (authStatus) authStatus.innerText = `Error GAPI: ${err.message || 'Desconocido'}`;
                                  reject(err);
                              }
                         },
                         onerror: (err) => {
                              console.error("Error cargando GAPI 'client' library:", err);
                              if (authStatus) authStatus.innerText = 'Error cargando GAPI client library.';
                              reject(err);
                          }
                     });
                };
                 script.onerror = (err) => {
                     console.error("Error cargando script api.js:", err);
                     if (authStatus) authStatus.innerText = 'Error al cargar GAPI script.';
                     reject(err);
                 };
                document.body.appendChild(script);
            });

            // GAPI está listo, ahora inicializar GIS
             if (authStatus) authStatus.innerText = 'Cargando Google Sign-In (GIS)...';
             console.log("Inicializando GIS...");

            await new Promise((resolve, reject) => {
                 const script = document.createElement('script');
                 script.src = 'https://accounts.google.com/gsi/client';
                 script.async = true;
                 script.defer = true;
                 script.onload = () => {
                     console.log("GIS script cargado.");
                     try {
                         tokenClient = google.accounts.oauth2.initTokenClient({
                             client_id: CLIENT_ID,
                             scope: SCOPES,
                             callback: tokenCallback, // Función que se llama después de que el usuario inicia sesión
                         });
                         console.log("GIS tokenClient inicializado.");
                         resolve(); // Resuelve la promesa GIS
                     } catch (err) {
                          console.error("Error inicializando GIS tokenClient:", err);
                          if (authStatus) authStatus.innerText = `Error GIS: ${err.message || 'Desconocido'}`;
                          reject(err);
                      }
                 };
                 script.onerror = (err) => {
                     console.error("Error cargando script gsi/client:", err);
                     if (authStatus) authStatus.innerText = 'Error al cargar GIS script.';
                     reject(err);
                 };
                 document.body.appendChild(script);
            });

            // Ambas bibliotecas están listas
            console.log("GAPI y GIS listos.");
            if (authStatus) authStatus.innerText = "Listo para iniciar sesión.";
            if (loginButton) loginButton.disabled = false; // Habilitar el botón
        }

        // Se llama cuando el usuario hace clic en "Iniciar Sesión"
        function handleAuthClick() {
            if (loadingSpinner) loadingSpinner.style.display = 'block';
            if (authStatus) authStatus.innerText = 'Abriendo ventana de Google...';
            if (tokenClient) {
                console.log("Solicitando token de acceso...");
                // Solicitar token. El callback 'tokenCallback' se ejecutará si tiene éxito.
                tokenClient.requestAccessToken({prompt: 'consent'}); // Forzar consentimiento la primera vez o si expira
            } else {
                console.error("handleAuthClick: TokenClient no está listo.");
                if (authStatus) authStatus.innerText = 'Error: Cliente de Google no inicializado.';
                 if (loadingSpinner) loadingSpinner.style.display = 'none';
            }
        }

        // Se llama cuando el usuario hace clic en "Cerrar Sesión"
        function handleSignoutClick() {
            const token = gapi.client?.getToken(); // Usar optional chaining
            if (token && token.access_token) {
                console.log("Revocando token...");
                google.accounts.oauth2.revoke(token.access_token, () => {
                    console.log("Token revocado.");
                    gapi.client.setToken(null); // Limpiar token de GAPI
                    // Ocultar app, mostrar login
                    if (appContainer) appContainer.style.display = 'none';
                    if (loginOverlay) loginOverlay.style.display = 'flex';
                    // Limpiar email
                    const userEmailEl = document.getElementById('user-email');
                    if (userEmailEl) userEmailEl.innerText = '';
                    // Limpiar datos de la aplicación
                    clearAppData();
                     if (authStatus) authStatus.innerText = 'Sesión cerrada. Listo para iniciar sesión.';
                     if (loginButton) loginButton.disabled = false; // Asegurarse que el botón esté habilitado
                });
            } else {
                 console.warn("handleSignoutClick: No hay token para revocar o GAPI no listo.");
                 // Aún así, forzar el estado de cierre de sesión visualmente
                 if (appContainer) appContainer.style.display = 'none';
                 if (loginOverlay) loginOverlay.style.display = 'flex';
                 const userEmailEl = document.getElementById('user-email');
                 if (userEmailEl) userEmailEl.innerText = '';
                 clearAppData();
                 if (authStatus) authStatus.innerText = 'Listo para iniciar sesión.';
                 if (loginButton) loginButton.disabled = false;
             }
        }
        
        // Función para limpiar datos al cerrar sesión
        function clearAppData() {
             clients = [];
             services = [];
             quotesHistory = [];
             contracts = [];
             quoteItemsData = [];
             if(clientList) clientList.innerHTML = ''; // Limpiar tablas visualmente
             if(serviceList) serviceList.innerHTML = '';
             if(quotesHistoryList) quotesHistoryList.innerHTML = '';
             if(quoteItemsBody) quoteItemsBody.innerHTML = '';
             // Resetear selects si existen
             if(quoteClientSelect) quoteClientSelect.innerHTML = '<option value="">-- Seleccione --</option>';
             if(serviceSelect) serviceSelect.innerHTML = '<option value="">-- Seleccione --</option>';
             // Podrías resetear más elementos si es necesario
             console.log("Datos de la aplicación limpiados.");
        }

        // Callback principal después de que el usuario inicia sesión exitosamente.
        async function tokenCallback(tokenResponse) {
             console.log("tokenCallback recibido:", tokenResponse);
            if (tokenResponse.error) {
                console.error("Error en la respuesta del token:", tokenResponse.error);
                if (authStatus) authStatus.innerText = `Error: ${tokenResponse.error_description || tokenResponse.error}`;
                if (loadingSpinner) loadingSpinner.style.display = 'none';
                if (loginButton) loginButton.disabled = false; // Habilitar botón si falla
                return;
            }
            
            // Guardar el token en GAPI para usar las APIs
            gapi.client.setToken(tokenResponse);
            console.log("Token de acceso establecido en GAPI.");

            if (authStatus) authStatus.innerText = 'Autenticado. Obteniendo info de usuario...';
            
            // Obtener info del usuario (opcional pero útil)
            try {
                const userInfoResponse = await fetch('https://www.googleapis.com/oauth2/v3/userinfo', {
                    headers: { 'Authorization': `Bearer ${tokenResponse.access_token}` }
                });
                if (!userInfoResponse.ok) {
                     throw new Error(`Error ${userInfoResponse.status}: ${await userInfoResponse.text()}`);
                 }
                const userData = await userInfoResponse.json();
                console.log("Información del usuario:", userData);
                const userEmailEl = document.getElementById('user-email');
                 if (userEmailEl) userEmailEl.innerText = userData.email || 'Usuario';
            } catch (err) {
                console.warn("No se pudo obtener info del usuario:", err);
                 const userEmailEl = document.getElementById('user-email');
                 // Poner un placeholder si falla
                 if (userEmailEl) userEmailEl.innerText = 'Usuario (email no disponible)'; 
            }
            
            // Ocultar login, mostrar app
            if (loginOverlay) loginOverlay.style.display = 'none';
            if (appContainer) appContainer.style.display = 'block';
            if (loadingSpinner) loadingSpinner.style.display = 'none'; // Ocultar spinner

            // Cargar datos iniciales desde Google Sheets/Drive
            if (authStatus) authStatus.innerText = 'Cargando datos iniciales...';
            await initializeDataFromGoogle();
        }

        // Función para verificar si falta alguna configuración
        function checkSheetConfig() {
            let missing = [];
            if (!CLIENTS_SHEET_ID || CLIENTS_SHEET_ID === 'ID_DE_TU_HOJA_DE_CLIENTES') missing.push("Clientes");
            if (!SERVICES_SHEET_ID || SERVICES_SHEET_ID === 'ID_DE_TU_HOJA_DE_SERVICIOS') missing.push("Servicios");
            if (!QUOTES_SHEET_ID || QUOTES_SHEET_ID === 'ID_DE_TU_HOJA_DE_COTIZACIONES') missing.push("Historial Cotizaciones");
            if (!CONTRACT_TEMPLATE_ID || CONTRACT_TEMPLATE_ID === 'ID_DE_TU_PLANTILLA_DE_CONTRATO_EN_GOOGLE_DOCS') missing.push("Plantilla Contrato");

            if (missing.length > 0) {
                 const message = `CONFIGURACIÓN INCOMPLETA.\n\nFalta configurar los IDs para: ${missing.join(', ')}.\nEdita el archivo index.html y rellena las constantes correspondientes en la sección <script>.`;
                 console.warn(message);
                 showAlert(message, "Error de Configuración"); // REEMPLAZO DE ALERT
                 return false; // Indicar que falta configuración
            }
            return true; // Configuración completa
        }

        // --- 3. LÓGICA DE DATOS (GOOGLE SHEETS) ---

        // Constantes y Estado de la Aplicación
        const IVA_RATE = 0.15;
        let clients = []; 
        let services = []; 
        let quotesHistory = []; 
        let contracts = []; // Podría usarse para cachear contratos cargados
        let quoteItemsData = [];
        let quoteCounter = 1; 
        
        let companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
            name: 'Tu Empresa S.A.', address: 'Tu Dirección, Guayaquil', contact: 'tuemail@empresa.com', logo: 'https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo', primaryColor: '#1a202c', accentColor: '#4f46e5', website: '', whatsapp: ''
        };

        // Función principal de inicialización de datos (llamada después del login)
        async function initializeDataFromGoogle() {
            // No continuar si falta configuración esencial (Sheets IDs)
            if (!checkSheetConfig()) { 
                if (authStatus) authStatus.innerText = 'Error: Configuración incompleta.';
                return; 
            } 

            if (authStatus) authStatus.innerText = 'Cargando Clientes...';
            await loadClientsFromSheet();
            
            if (authStatus) authStatus.innerText = 'Cargando Servicios...';
            await loadServicesFromSheet();
            
            if (authStatus) authStatus.innerText = 'Cargando Historial...';
            await loadQuotesHistoryFromSheet(); // Esto también actualiza quoteCounter
            
             if (authStatus) authStatus.innerText = 'Datos cargados. Listo.';

            // Renderizar UI con los datos cargados
            renderClients();
            renderServices();
            renderQuoteItems(); // Renderiza la tabla de items (vacía inicialmente)
            updateQuoteNumberPreview(); // Calcula el número de cotización
            loadSettings(); // Carga config. local (nombre empresa, logo, etc.)
            renderQuotesHistory(); // Renderiza la tabla de historial
            renderDashboard(); // Calcula estadísticas
            
            // Asegurar que la primera pestaña esté activa visualmente
            const firstTabButton = document.querySelector('.tab-button');
            const firstTabContent = document.querySelector('.tab-content');
            if (firstTabButton && firstTabContent) {
                 document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
                 document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
                 firstTabButton.classList.add('active');
                 firstTabContent.classList.add('active');
             } else {
                  console.warn("No se encontró la primera pestaña o contenido para activar.");
              }
        }

        // --- LÓGICA DE CLIENTES (GOOGLE SHEETS) ---
        
        async function loadClientsFromSheet() {
             // Verificar que gapi.client y gapi.client.sheets existan
             if (!gapi?.client?.sheets) { 
                 console.error("loadClientsFromSheet: API de Sheets no está lista."); 
                 showAlert("Error: La API de Google Sheets no está lista. Intenta recargar.", "Error de API"); // REEMPLAZO DE ALERT
                 return; 
             }
            try {
                console.log(`Cargando clientes desde ${CLIENTS_SHEET_ID} rango ${CLIENTS_SHEET_RANGE}`);
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: CLIENTS_SHEET_ID,
                    range: CLIENTS_SHEET_RANGE,
                });
                console.log("Respuesta de Sheets (Clientes):", response.result);
                // Mapeo cuidadoso, verificando si response.result.values existe
                clients = (response.result.values || []).map((row, index) => {
                    // Añadir chequeos por si una fila es más corta de lo esperado
                    const ruc = row[0] || '';
                    const name = row[1] || '';
                    const contact = row[5] || row[4] || ''; // Prioriza email (F) sobre teléfono (E)
                    return {
                        rowId: index + 2, // Fila real en la hoja (A2 es fila 2)
                        id: ruc || `client_row_${index + 2}`, // Usar RUC como ID si existe, sino un ID basado en fila
                        code: ruc,             
                        name: name,             
                        ruc: ruc,            
                        contact: contact    
                    };
                }).filter(client => client.ruc || client.name); // Filtrar filas completamente vacías

                console.log(`Clientes cargados: ${clients.length}`);
            } catch (err) {
                console.error("Error cargando clientes:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al cargar clientes: ${errorMsg}\nAsegúrate de que la hoja exista, tengas permiso y el rango sea correcto.`, "Error de Carga"); // REEMPLAZO DE ALERT
                clients = []; // Resetear si falla
            }
        }
        
        // Renderizar Clientes 
        function renderClients() {
             if (!clientList) {console.warn("Elemento clientList no encontrado para renderizar."); return;} 
            clientList.innerHTML = ''; // Limpiar tabla
            if (clients.length === 0) {
                clientList.innerHTML = `<tr><td colspan="4" class="text-center py-4 text-gray-500">No hay clientes para mostrar. Añade uno o revisa la conexión con Google Sheets.</td></tr>`;
            } else {
                // Ordenar por nombre antes de renderizar
                [...clients].sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(client => {
                    const row = document.createElement('tr');
                    // Usamos client.id (RUC) para editar y client.rowId para borrar
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-sm">${client.ruc || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${client.name || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${client.contact || ''}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editClient('${client.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Editar Cliente"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteClient('${client.rowId}')" class="text-red-600 hover:text-red-900" title="Eliminar Cliente (limpia la fila)"><i class="fas fa-trash"></i></button>
                        </td>`;
                    clientList.appendChild(row);
                });
            }
            updateClientDropdowns(); // Actualizar los <select> que usan clientes
        }

        // Guardar/Actualizar Cliente 
        async function handleClientFormSubmit(e) {
            e.preventDefault();
             // Chequeo robusto de elementos
             if (!clientRowIdInput || !clientRUCInput || !clientNameInput || !clientContactInput || !clientForm || !gapi?.client?.sheets) {
                 showAlert("Error: Faltan elementos del formulario o la API de Sheets no está lista.", "Error de Formulario"); // REEMPLAZO
                 return; 
             }
            const rowId = clientRowIdInput.value; // ID de fila para saber si es update o append
            const ruc = clientRUCInput.value.trim();
            const name = clientNameInput.value.trim();
            const contact = clientContactInput.value.trim();

            if (!ruc || !name) {
                 showAlert("El RUC/CI y la Razón Social son obligatorios.", "Datos Incompletos"); // REEMPLAZO
                 return;
             }

            // Mapeo a columnas A-F
            const isEmail = contact.includes('@');
            const clientData = [
                ruc,       // Col A: Identificación No.
                name,      // Col B: Razón Social
                name,      // Col C: Nombre Comercial (default)
                '',        // Col D: Dirección (vacía)
                isEmail ? '' : contact, // Col E: Teléfono
                isEmail ? contact : ''  // Col F: E-mail
            ];

            // Deshabilitar botón mientras guarda
            const submitButton = clientForm.querySelector('button[type="submit"]');
            if (submitButton) submitButton.disabled = true;
            if (authStatus) authStatus.innerText = rowId ? 'Actualizando cliente...' : 'Guardando nuevo cliente...';

            try {
                if (rowId) {
                    // --- ACTUALIZAR (UPDATE) ---
                    const range = `Hoja 1!A${rowId}:F${rowId}`;
                    console.log(`Actualizando cliente en ${CLIENTS_SHEET_ID} rango ${range}`);
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: CLIENTS_SHEET_ID,
                        range: range,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [clientData] }
                    });
                    showAlert('Cliente actualizado.'); // REEMPLAZO
                } else {
                    // --- CREAR (APPEND) ---
                     console.log(`Añadiendo cliente a ${CLIENTS_SHEET_ID}`);
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: CLIENTS_SHEET_ID,
                        range: 'Hoja 1!A:F', // Apuntar al rango completo para append
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS', 
                        resource: { values: [clientData] }
                    });
                    showAlert('Nuevo cliente guardado.'); // REEMPLAZO
                }
                
                clientForm.reset();
                clientRowIdInput.value = ''; // Limpiar ID de fila
                await loadClientsFromSheet(); // Recargar datos
                renderClients(); // Actualizar tabla
                if (authStatus) authStatus.innerText = 'Listo.';

            } catch (err) {
                console.error("Error guardando cliente:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al guardar cliente: ${errorMsg}\nRevisa la consola.`, "Error al Guardar"); // REEMPLAZO
                 if (authStatus) authStatus.innerText = 'Error al guardar.';
            } finally {
                 // Rehabilitar botón
                 if (submitButton) submitButton.disabled = false;
             }
        }

        // Editar Cliente (carga datos en el formulario)
        function editClient(id) {
            const client = clients.find(c => c.id === id);
            // Chequeo robusto
            if (!client || !clientRowIdInput || !clientNameInput || !clientRUCInput || !clientContactInput) {
                 console.error("editClient: No se encontró el cliente o faltan elementos del form. ID:", id);
                 showAlert("No se encontró el cliente para editar."); // REEMPLAZO
                 return; 
            }
            console.log("Editando cliente:", client);
            clientRowIdInput.value = client.rowId; // Guardar la fila para el update
            clientNameInput.value = client.name;
            clientRUCInput.value = client.ruc;
            clientContactInput.value = client.contact;
             // Cambiar a la pestaña de clientes
             const tabButton = document.querySelector('.tab-button[onclick*="clientes"]');
             if (tabButton) {
                 changeTab({currentTarget: tabButton}, 'clientes');
             }
            clientNameInput.focus(); // Poner foco en el primer campo editable
            window.scrollTo(0, 0); // Ir al inicio de la página para ver el formulario
        }

        // Borrar Cliente (limpia la fila)
        async function deleteClient(rowId) {
             if (!gapi?.client?.sheets) {
                 showAlert("Error: API de Sheets no lista para borrar.", "Error de API"); // REEMPLAZO
                 return;
             }
             
             // REEMPLAZO DE CONFIRM
             showConfirm(`¿Estás seguro de ELIMINAR los datos del cliente en la fila ${rowId}?\nEsta acción limpiará las celdas en Google Sheets.`, async () => {
                if (authStatus) authStatus.innerText = `Eliminando fila ${rowId}...`;

                try {
                    const range = `Hoja 1!A${rowId}:F${rowId}`; // Rango a limpiar
                     console.log(`Borrando datos en ${CLIENTS_SHEET_ID} rango ${range}`);
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: CLIENTS_SHEET_ID,
                        range: range,
                    });
                    showAlert('Datos del cliente eliminados de la fila.'); // REEMPLAZO
                    
                    // Quitar de la lista local y recargar/renderizar
                    clients = clients.filter(c => c.rowId !== parseInt(rowId)); // Actualizar array local
                    renderClients(); // Redibujar tabla
                    if (authStatus) authStatus.innerText = 'Listo.';

                } catch (err) {
                    console.error("Error borrando cliente:", err);
                    const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                    showAlert(`Error al eliminar cliente: ${errorMsg}\nRevisa la consola.`, "Error al Eliminar"); // REEMPLAZO
                     if (authStatus) authStatus.innerText = 'Error al eliminar.';
                     // Opcional: Recargar todo si falla para asegurar consistencia
                     // await loadClientsFromSheet(); renderClients();
                 }
             });
        }

        // --- LÓGICA DE SERVICIOS (GOOGLE SHEETS) ---
        
        async function loadServicesFromSheet() {
             if (!gapi?.client?.sheets) { console.error("loadServicesFromSheet: API de Sheets no lista."); return; }
            try {
                console.log(`Cargando servicios desde ${SERVICES_SHEET_ID} rango ${SERVICES_SHEET_RANGE}`);
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: SERVICES_SHEET_ID,
                    range: SERVICES_SHEET_RANGE, // A2:E
                });
                console.log("Respuesta de Sheets (Servicios):", response.result);
                services = (response.result.values || []).map((row, index) => {
                    const id = row[0] || '';
                    const name = row[2] || ''; // Col C: description
                    const priceStr = row[3] || '0'; // Col D: price
                    // Limpieza robusta del precio
                    const price = parseFloat(String(priceStr).replace(/[^0-9.-]+/g,"")) || 0; 
                    return {
                        rowId: index + 2,
                        id: id || `service_row_${index + 2}`, // Usar ID de Col A si existe
                        name: name,             
                        description: name, // Usar descripción como ambos por ahora       
                        price: price 
                    };
                }).filter(service => service.id || service.name); // Filtrar filas vacías

                console.log(`Servicios cargados: ${services.length}`);
            } catch (err) {
                console.error("Error cargando servicios:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al cargar servicios: ${errorMsg}\nAsegúrate de que la hoja exista, tengas permiso y el rango sea correcto.`, "Error de Carga"); // REEMPLAZO
                services = []; // Resetear si falla
            }
        }

        function renderServices() {
             if (!serviceList) {console.warn("Elemento serviceList no encontrado."); return;}
            serviceList.innerHTML = ''; // Limpiar
             if (services.length === 0) {
                 serviceList.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay servicios para mostrar. Añade uno o revisa la conexión con Google Sheets.</td></tr>`;
             } else {
                 // Ordenar por nombre
                 [...services].sort((a,b) => (a.name || '').localeCompare(b.name || '')).forEach(service => {
                    const row = document.createElement('tr');
                    // Usar service.id para editar, service.rowId para borrar
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap">${service.name || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">$${(service.price || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="editService('${service.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3" title="Editar Servicio"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteService('${service.rowId}')" class="text-red-600 hover:text-red-900" title="Eliminar Servicio (limpia la fila)"><i class="fas fa-trash"></i></button>
                        </td>`;
                    serviceList.appendChild(row);
                });
            }
            updateServiceDropdown(); // Actualizar el <select> del cotizador
        }

        async function handleServiceFormSubmit(e) {
            e.preventDefault();
             // Chequeo robusto
             if (!serviceRowIdInput || !serviceIdInput || !serviceNameInput || !servicePriceInput || !serviceForm || !gapi?.client?.sheets) {
                 showAlert("Error: Faltan elementos del formulario de servicios o API no lista.", "Error de Formulario"); // REEMPLAZO
                 return;
             }
            const rowId = serviceRowIdInput.value;
            const name = serviceNameInput.value.trim();
            const price = parseFloat(servicePriceInput.value);

             if (!name || isNaN(price) || price < 0) {
                 showAlert("El nombre y un precio válido (mayor o igual a 0) son obligatorios.", "Datos Incompletos"); // REEMPLAZO
                 return;
              }

            // Mapeo a columnas A-E
            const serviceIdValue = rowId ? serviceIdInput.value : `service_${new Date().getTime()}`; // Generar nuevo ID si no existe
            const serviceData = [
                serviceIdValue,         // Col A: id
                '',                     // Col B: code (vacío)
                name,                   // Col C: description
                price,                  // Col D: price
                new Date().toISOString() // Col E: updated_at
            ];
            
            // Deshabilitar botón
            const submitButton = serviceForm.querySelector('button[type="submit"]');
            if (submitButton) submitButton.disabled = true;
            if (authStatus) authStatus.innerText = rowId ? 'Actualizando servicio...' : 'Guardando nuevo servicio...';

            try {
                if (rowId) {
                    // --- ACTUALIZAR (UPDATE) ---
                    const range = `Hoja 1!A${rowId}:E${rowId}`;
                    console.log(`Actualizando servicio en ${SERVICES_SHEET_ID} rango ${range}`);
                    await gapi.client.sheets.spreadsheets.values.update({
                        spreadsheetId: SERVICES_SHEET_ID,
                        range: range,
                        valueInputOption: 'USER_ENTERED',
                        resource: { values: [serviceData] }
                    });
                    showAlert('Servicio actualizado.'); // REEMPLAZO
                } else {
                    // --- CREAR (APPEND) ---
                     console.log(`Añadiendo servicio a ${SERVICES_SHEET_ID}`);
                    await gapi.client.sheets.spreadsheets.values.append({
                        spreadsheetId: SERVICES_SHEET_ID,
                        range: 'Hoja 1!A:E', 
                        valueInputOption: 'USER_ENTERED',
                        insertDataOption: 'INSERT_ROWS',
                        resource: { values: [serviceData] }
                    });
                    showAlert('Nuevo servicio guardado.'); // REEMPLAZO
                }
                
                serviceForm.reset();
                serviceRowIdInput.value = '';
                serviceIdInput.value = ''; // Limpiar ID oculto
                await loadServicesFromSheet(); // Recargar
                renderServices(); // Actualizar tabla
                if (authStatus) authStatus.innerText = 'Listo.';

            } catch (err) {
                console.error("Error guardando servicio:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al guardar servicio: ${errorMsg}\nRevisa la consola.`, "Error al Guardar"); // REEMPLAZO
                 if (authStatus) authStatus.innerText = 'Error al guardar.';
            } finally {
                 if (submitButton) submitButton.disabled = false; // Rehabilitar
             }
        }

        function editService(id) {
            const service = services.find(s => s.id === id);
            // Chequeo robusto
            if (!service || !serviceRowIdInput || !serviceIdInput || !serviceNameInput || !serviceDescriptionInput || !servicePriceInput) {
                console.error("editService: No se encontró servicio o faltan elementos del form. ID:", id);
                showAlert("No se encontró el servicio para editar."); // REEMPLAZO
                 return;
            }
            console.log("Editando servicio:", service);
            serviceRowIdInput.value = service.rowId; // Guardar fila para update
            serviceIdInput.value = service.id; // Guardar ID existente
            serviceNameInput.value = service.name; // description -> name input
            serviceDescriptionInput.value = service.description; // Llenar campo oculto (por si acaso)
            servicePriceInput.value = service.price;
             // Cambiar a pestaña
             const tabButton = document.querySelector('.tab-button[onclick*="servicios"]');
             if (tabButton) {
                 changeTab({currentTarget: tabButton}, 'servicios');
             }
            serviceNameInput.focus(); // Foco
            window.scrollTo(0, 0); // Ir arriba
        }

        async function deleteService(rowId) {
             if (!gapi?.client?.sheets) {
                 showAlert("Error: API de Sheets no lista para borrar.", "Error de API"); // REEMPLAZO
                 return;
             }

             // REEMPLAZO DE CONFIRM
             showConfirm(`¿Estás seguro de ELIMINAR los datos del servicio en la fila ${rowId}?\nEsto limpiará las celdas en Google Sheets.`, async () => {
                if (authStatus) authStatus.innerText = `Eliminando fila ${rowId}...`;

                try {
                    const range = `Hoja 1!A${rowId}:E${rowId}`; // Rango A-E
                     console.log(`Borrando datos en ${SERVICES_SHEET_ID} rango ${range}`);
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: SERVICES_SHEET_ID,
                        range: range,
                    });
                    showAlert('Datos del servicio eliminados de la fila.'); // REEMPLAZO
                    
                    // Actualizar localmente
                    services = services.filter(s => s.rowId !== parseInt(rowId)); 
                    renderServices(); // Redibujar
                    if (authStatus) authStatus.innerText = 'Listo.';

                } catch (err) {
                    console.error("Error borrando servicio:", err);
                    const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                    showAlert(`Error al eliminar servicio: ${errorMsg}\nRevisa la consola.`, "Error al Eliminar"); // REEMPLAZO
                     if (authStatus) authStatus.innerText = 'Error al eliminar.';
                     // Opcional: Recargar todo
                     // await loadServicesFromSheet(); renderServices();
                 }
             });
        }

        // --- LÓGICA DE HISTORIAL (GOOGLE SHEETS) ---
        
        async function loadQuotesHistoryFromSheet() {
             // Verificar si el ID es el placeholder o si la API no está lista
             if (!QUOTES_SHEET_ID || QUOTES_SHEET_ID === 'ID_DE_TU_HOJA_DE_COTIZACIONES' || !gapi?.client?.sheets) { 
                 console.warn("loadQuotesHistoryFromSheet: ID de hoja no configurado o API no lista. Saltando carga.");
                 quotesHistory = []; // Asegurar que esté vacío
                 quoteCounter = 1;
                 renderQuotesHistory(); // Mostrar mensaje de "no cargado"
                 return; 
             }
            
            try {
                console.log(`Cargando historial desde ${QUOTES_SHEET_ID} rango ${QUOTES_SHEET_RANGE}`);
                const response = await gapi.client.sheets.spreadsheets.values.get({
                    spreadsheetId: QUOTES_SHEET_ID,
                    range: QUOTES_SHEET_RANGE, // A2:J
                });
                console.log("Respuesta de Sheets (Historial):", response.result);
                
                quotesHistory = (response.result.values || []).map((row, index) => {
                    // Validar longitud mínima de fila (hasta Estado - Col H)
                    if (row.length < 8) { 
                         console.warn(`Fila ${index + 2} incompleta en Historial (longitud ${row.length}):`, row);
                         return null; // Ignorar fila incompleta
                     }
                    try {
                        // Parsear JSON con cuidado
                        const clientData = JSON.parse(row[4] || '{}');
                        const itemsData = JSON.parse(row[5] || '[]');
                        
                        // Validar que items sea un array
                         if (!Array.isArray(itemsData)) {
                             console.warn(`Items en fila ${index + 2} no es un array:`, row[5]);
                             throw new Error("Formato de items inválido."); // Lanzar error para que se filtre
                          }

                        return {
                            rowId: index + 2,
                            id: row[0] || `quote_row_${index + 2}`, // Col A
                            number: row[1] || 'N/A', // Col B
                            issueDate: row[2] || 'N/A', // Col C
                            validityDate: row[3] || 'N/A', // Col D
                            client: clientData, // Col E (JSON)
                            items: itemsData, // Col F (JSON Array)
                            total: parseFloat(row[6]) || 0, // Col G
                            status: row[7] || 'Pendiente', // Col H
                            notes: row[8] || '', // Col I
                            googleDocId: row[9] || null, // Col J
                            googlePdfId: row[10] || null // Col K
                        }
                    } catch(e) {
                         // Capturar errores de JSON.parse u otros
                         console.error(`Error procesando fila ${index + 2} de Historial:`, e.message, "Fila:", row);
                         return null; // Marcar fila como inválida
                     }
                }).filter(q => q !== null); // Filtrar filas nulas (incompletas o con error)

                quoteCounter = quotesHistory.length + 1; // Contador basado en filas válidas
                 console.log(`Historial cargado: ${quotesHistory.length} registros válidos.`);
            } catch (err) {
                 console.error("Error fatal cargando historial:", err);
                 const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                 showAlert(`Error CRÍTICO al cargar el historial: ${errorMsg}\nRevisa permisos, ID de hoja y rango. La app podría no funcionar correctamente.`, "Error Crítico"); // REEMPLAZO
                 quotesHistory = []; // Resetear si falla gravemente
                 quoteCounter = 1;
             }
             // Renderizar siempre para mostrar estado (vacío, error o datos)
             renderQuotesHistory();
        }

        // Renderizar tabla de historial
        function renderQuotesHistory() {
            if (!quotesHistoryList) {console.warn("Elemento quotesHistoryList no encontrado."); return;}
            quotesHistoryList.innerHTML = ''; // Limpiar
            if (quotesHistory.length === 0) {
                quotesHistoryList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay cotizaciones registradas en Google Sheets o no se pudieron cargar.</td></tr>`;
            } else {
                // Mostrar las más recientes primero
                [...quotesHistory].reverse().forEach(quote => {
                    const row = document.createElement('tr');
                    // Usar fallbacks si client o name no existen
                    const clientName = quote.client?.name || 'Cliente Desconocido'; 
                    const docLinkHtml = quote.googleDocId
                        ? `<a href="https://docs.google.com/document/d/${quote.googleDocId}/edit" target="_blank" class="text-blue-600 hover:text-blue-900" title="Ver Documento en Google Drive"><i class="fas fa-link"></i></a>`
                        : '';
                    const pdfLinkHtml = quote.googlePdfId
                        ? `<a href="https://drive.google.com/file/d/${quote.googlePdfId}/view" target="_blank" class="text-red-600 hover:text-red-800 ml-2" title="Abrir PDF en Google Drive"><i class="fas fa-file-pdf"></i></a>`
                        : '';

                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-xs">${quote.number || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${clientName}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${quote.issueDate || 'N/A'}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-semibold">$${(quote.total || 0).toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <select onchange="updateQuoteStatus('${quote.id}', this.value, ${quote.rowId})" 
                                    class="p-1 rounded-md border-gray-300 text-xs focus:ring-indigo-500 focus:border-indigo-500 status-${quote.status || 'Pendiente'}" 
                                    aria-label="Estado de la cotización ${quote.number}">
                                <option value="Pendiente" ${quote.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Aceptada" ${quote.status === 'Aceptada' ? 'selected' : ''}>Aceptada</option>
                                <option value="Rechazada" ${quote.status === 'Rechazada' ? 'selected' : ''}>Rechazada</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="loadQuoteForEdit('${quote.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Cargar cotización para editarla"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="reprintQuote('${quote.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2" title="Ver / Reimprimir cotización"><i class="fas fa-eye"></i></button>
                            ${docLinkHtml}
                            ${pdfLinkHtml}
                            <button onclick="deleteQuote('${quote.id}', ${quote.rowId}, '${quote.googleDocId || ''}', '${quote.googlePdfId || ''}')" class="text-red-500 hover:text-red-700 ml-2" title="Eliminar cotización"><i class="fas fa-trash"></i></button>
                        </td>`;
                    quotesHistoryList.appendChild(row);
                });
            }
        }

        // Actualizar estado de cotización en Google Sheet
        async function updateQuoteStatus(quoteId, newStatus, rowId) {
            // Revalidar ID y API
            if (!QUOTES_SHEET_ID || QUOTES_SHEET_ID === 'ID_DE_TU_HOJA_DE_COTIZACIONES' || !rowId || !gapi?.client?.sheets) {
                showAlert("Error: ID de Hoja de Cotizaciones no configurado, fila inválida o API no lista.", "Error de Configuración"); // REEMPLAZO
                // Revertir visualmente el select si es posible
                 const selectElement = event?.target; // Intentar obtener el select que disparó el evento
                  if (selectElement) {
                       const originalQuote = quotesHistory.find(q => q.id === quoteId);
                       if (originalQuote) selectElement.value = originalQuote.status;
                   }
                 return;
             }
            
             if (authStatus) authStatus.innerText = `Actualizando estado fila ${rowId}...`;

            try {
                // Col H = Estado (Índice 7 en base 0)
                const range = `Hoja 1!H${rowId}`; 
                 console.log(`Actualizando estado en ${QUOTES_SHEET_ID} rango ${range} a ${newStatus}`);
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: QUOTES_SHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: [[newStatus]] }
                });

                // Actualizar localmente si la API tuvo éxito
                const quoteIndex = quotesHistory.findIndex(q => q.id === quoteId);
                if (quoteIndex > -1) {
                    quotesHistory[quoteIndex].status = newStatus;
                    renderQuotesHistory(); // Redibujar tabla historial
                    renderDashboard(); // Actualizar dashboard
                     if (authStatus) authStatus.innerText = 'Estado actualizado.';
                } else {
                     console.warn("Cotización no encontrada localmente tras actualizar estado:", quoteId);
                     // Si no se encontró localmente (raro), forzar recarga completa
                     if (authStatus) authStatus.innerText = 'Estado actualizado en Sheet, recargando historial local...';
                     await loadQuotesHistoryFromSheet(); 
                 }
            } catch(err) {
                console.error("Error actualizando estado:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al actualizar estado: ${errorMsg}\nRevisa la consola.`, "Error al Actualizar"); // REEMPLAZO
                 if (authStatus) authStatus.innerText = 'Error al actualizar estado.';
                  // Revertir visualmente el select si falla la API
                  const selectElement = event?.target;
                  if (selectElement) {
                       const originalQuote = quotesHistory.find(q => q.id === quoteId);
                       if (originalQuote) selectElement.value = originalQuote.status;
                   }
             }
        }
        
        // Cargar datos de una cotización antigua en el formulario
        function loadQuoteForEdit(quoteId) {
            const quote = quotesHistory.find(q => q.id === quoteId);
            if (!quote) {
                 showAlert("Cotización no encontrada en el historial cargado."); // REEMPLAZO
                 return;
             }
             
             // Chequeos de elementos DOM
             if (!quoteClientSelect || !quoteNotesInput || !quoteItemsBody) {
                 console.error("loadQuoteForEdit: Faltan elementos del formulario.");
                 return;
              }
             console.log("Cargando para editar:", quote);

            // Seleccionar cliente (si existe en la lista actual)
            if(quote.client && quote.client.id && quoteClientSelect.querySelector(`option[value="${quote.client.id}"]`)) {
                 quoteClientSelect.value = quote.client.id;
            } else {
                console.warn("Cliente de la cotización no encontrado en la lista actual:", quote.client?.id);
                 quoteClientSelect.value = ''; // Resetear si no está
             }
            
            // Cargar items (asegurando que sea un array)
            quoteItemsData = Array.isArray(quote.items) ? JSON.parse(JSON.stringify(quote.items)) : []; // Clonar items
            quoteNotesInput.value = quote.notes || ''; // Cargar notas
            
            // Disparar evento change en cliente para actualizar RUC y número preview
            const event = new Event('change');
            quoteClientSelect.dispatchEvent(event); // Esto llama a handleQuoteClientChange -> updateQuoteNumberPreview
            
            renderQuoteItems(); // Dibujar tabla de items
            
            // Cambiar a la pestaña del cotizador
            const tabButton = document.querySelector('.tab-button[onclick*="cotizador"]');
             if (tabButton) {
                 changeTab({currentTarget: tabButton}, 'cotizador');
             }
            showAlert(`Cotización ${quote.number} cargada.\nPuedes modificarla y generar una NUEVA cotización.\nLos cambios NO sobrescribirán la original.`, "Cotización Cargada"); // REEMPLAZO
             window.scrollTo(0, 0); // Ir arriba
        }


        // --- LÓGICA DE CONTRATOS ---
        async function handleSaveContractClick() {
            const quoteId = contractQuoteSelect ? contractQuoteSelect.value : null;
            const text = contractText ? contractText.value : null;
            if (!quoteId || text === null || text.trim() === '') {
                showAlert("Selecciona una cotización aceptada y escribe el contenido del contrato.", "Datos Incompletos"); // REEMPLAZO
                return;
            }
            const quote = quotesHistory.find(q => q.id === quoteId);
            if (!quote) {
                showAlert("Cotización seleccionada no encontrada."); // REEMPLAZO
                return;
            }
            
            // Comprobar si ya existe un Doc y qué hacer
            if (quote.googleDocId) {
                // REEMPLAZO DE CONFIRM
                showConfirm(`Esta cotización YA TIENE un Google Doc asociado.\n\n¿Deseas reemplazar su contenido con el texto actual?\n¡ESTA ACCIÓN NO SE PUEDE DESHACER!`, async () => {
                    // TODO: Implementar UPDATE de Google Doc (requiere borrar contenido anterior e insertar nuevo)
                    showAlert("La función para ACTUALIZAR un Google Doc existente aún no está implementada.", "Función no Disponible"); // REEMPLAZO
                    console.warn("Intento de actualizar Doc existente no implementado:", quote.googleDocId);
                });
                return; 
            }

            // --- Lógica para CREAR un nuevo Google Doc ---
            if (!gapi?.client?.drive || !gapi?.client?.docs) {
                showAlert("Error: APIs de Drive o Docs no listas.", "Error de API"); // REEMPLAZO
                return;
            }
            if (!CONTRACT_TEMPLATE_ID || CONTRACT_TEMPLATE_ID === 'ID_DE_TU_PLANTILLA_DE_CONTRATO_EN_GOOGLE_DOCS') {
                showAlert("Error: Falta configurar el ID de la Plantilla de Contrato.", "Error de Configuración"); // REEMPLAZO
                return;
            }

            if (authStatus) authStatus.innerText = 'Creando documento de contrato...';
            saveContractBtn.disabled = true; // Deshabilitar mientras crea

            try {
                // 1. Crear título para el nuevo Doc
                const docTitle = `Contrato - Cotización ${quote.number} - ${quote.client?.name || 'Cliente'}`;

                // 2. Copiar la plantilla
                console.log(`Copiando plantilla ${CONTRACT_TEMPLATE_ID} para crear contrato: ${docTitle}`);
                const copyResponse = await gapi.client.drive.files.copy({
                    fileId: CONTRACT_TEMPLATE_ID,
                    resource: { name: docTitle }
                });
                const newDocId = copyResponse.result.id;
                console.log("Plantilla copiada, nuevo ID de contrato:", newDocId);

                // 3. Reemplazar placeholders básicos (igual que en cotización) + insertar texto principal
                console.log("Reemplazando placeholders básicos en contrato...");
                const basicRequests = [
                    { replaceAllText: { containsText: { text: '{{CLIENTE_NOMBRE}}', matchCase: false }, replaceText: quote.client?.name || '' } },
                    { replaceAllText: { containsText: { text: '{{CLIENTE_RUC}}', matchCase: false }, replaceText: quote.client?.ruc || '' } },
                    { replaceAllText: { containsText: { text: '{{COTIZACION_NUMERO}}', matchCase: false }, replaceText: quote.number || '' } },
                    { replaceAllText: { containsText: { text: '{{FECHA_EMISION}}', matchCase: false }, replaceText: quote.issueDate || '' } },
                    { replaceAllText: { containsText: { text: '{{TOTAL}}', matchCase: false }, replaceText: `$${(quote.total || 0).toFixed(2)}` } },
                    // Añadir más placeholders básicos si los tienes en la plantilla
                ];
                await gapi.client.docs.documents.batchUpdate({
                    documentId: newDocId,
                    resource: { requests: basicRequests }
                });
                console.log("Placeholders básicos reemplazados.");

                // 4. Insertar el texto principal del contrato (esto es más complejo, requiere encontrar dónde insertarlo)
                // Solución simple: Reemplazar un placeholder específico como '{{CONTENIDO_CONTRATO}}'
                 console.log("Intentando reemplazar {{CONTENIDO_CONTRATO}}...");
                 const contentRequest = [{ 
                     replaceAllText: { 
                         containsText: { text: '{{CONTENIDO_CONTRATO}}', matchCase: false }, 
                         replaceText: text // El texto del textarea
                     } 
                 }];
                 await gapi.client.docs.documents.batchUpdate({
                     documentId: newDocId,
                     resource: { requests: contentRequest }
                 });
                 console.log("Placeholder de contenido reemplazado.");
                 // NOTA: Si {{CONTENIDO_CONTRATO}} no existe, el texto no se insertará. Asegúrate de que esté en tu plantilla.

                // 5. Actualizar la hoja de Historial con el ID del nuevo Doc (Col J)
                console.log(`Actualizando Sheet ${QUOTES_SHEET_ID} fila ${quote.rowId} Col J con Doc ID ${newDocId}`);
                const range = `Hoja 1!J${quote.rowId}`;
                await gapi.client.sheets.spreadsheets.values.update({
                    spreadsheetId: QUOTES_SHEET_ID,
                    range: range,
                    valueInputOption: 'USER_ENTERED',
                    resource: { values: [[newDocId]] }
                });
                console.log("Sheet actualizado con Doc ID.");

                // 6. Actualizar el registro local
                quote.googleDocId = newDocId;
                renderQuotesHistory(); // Redibujar historial para mostrar el nuevo enlace
                
                showAlert(`Contrato creado exitosamente en Google Drive.\nID: ${newDocId}\nSe ha guardado el enlace en el historial.`, "Contrato Creado"); // REEMPLAZO
                if (authStatus) authStatus.innerText = 'Contrato guardado.';
                // Limpiar textarea y deshabilitar botón? Opcional.
                // contractText.value = '';
                // saveContractBtn.disabled = true;

            } catch (err) {
                 console.error("Error guardando contrato:", err);
                 const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                 showAlert(`Error al guardar el contrato en Google Drive/Sheets: ${errorMsg}\nRevisa la consola.`, "Error al Guardar"); // REEMPLAZO
                 if (authStatus) authStatus.innerText = 'Error al guardar contrato.';
            } finally {
                 saveContractBtn.disabled = false; // Rehabilitar botón
             }
        }

        
        // --- LÓGICA DE GENERACIÓN (PRINT / GOOGLE DOCS) ---
        async function generatePrintableQuote(saveToDrive = false) {
             // Revalidar IDs cruciales antes de proceder
             let configOk = true;
             // Usar IDs reales en la comprobación
             if (!QUOTES_SHEET_ID || QUOTES_SHEET_ID === 'ID_DE_TU_HOJA_DE_COTIZACIONES') { 
                 showAlert("Falta configurar el ID de la Hoja de Historial (QUOTES_SHEET_ID).", "Error de Configuración"); // REEMPLAZO
                 configOk = false;
             }
             if (saveToDrive && (!CONTRACT_TEMPLATE_ID || CONTRACT_TEMPLATE_ID === 'ID_DE_TU_PLANTILLA_DE_CONTRATO_EN_GOOGLE_DOCS')) { 
                 showAlert("Falta configurar el ID de la Plantilla de Contrato (CONTRACT_TEMPLATE_ID) para guardar en Drive.", "Error de Configuración"); // REEMPLAZO
                 configOk = false;
             }
             if (!configOk) return;

             // Chequeos de elementos y datos
             if (!quoteClientSelect || !quoteItemsData || !quoteNotesInput || !quoteDate) {
                 showAlert("Error: Faltan elementos del formulario de cotización.", "Error de Formulario"); // REEMPLAZO
                 return;
              }
            const client = clients.find(c => c.id === quoteClientSelect.value);
            if (!client) { showAlert('Por favor, seleccione un cliente.'); return; } // REEMPLAZO
            if (quoteItemsData.length === 0) { showAlert('Por favor, añada al menos un servicio a la cotización.'); return; } // REEMPLAZO

            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            // Usa el contador actual del historial + 1 para el secuencial
            const sequential = (quotesHistory.length + 1).toString().padStart(4, '0'); 
            const finalQuoteNumber = `${client.code}-${dateStr}${timeStr}-${sequential}`;

            const quoteDateValue = quoteDate.value; // Ya asignado en assignDOMElements
            const validityDate = quoteDateValue ? new Date(quoteDateValue + 'T00:00:00Z').toLocaleDateString('es-EC') : 'Indefinida'; // Usar T00:00:00Z para UTC
            const issueDate = now.toLocaleDateString('es-EC');

            const subtotal = quoteItemsData.reduce((acc, item) => {
                const itemPrice = parseFloat(item.price) || 0;
                const itemQuantity = parseFloat(item.quantity) || 1;
                return acc + (itemPrice * itemQuantity);
            }, 0);
            const iva = parseFloat((subtotal * IVA_RATE).toFixed(2));
            const total = parseFloat((subtotal + iva).toFixed(2));
            
            // Crear el objeto de registro de cotización
            const quoteRecord = {
                id: `quote_${now.getTime()}`, // ID único basado en timestamp
                number: finalQuoteNumber,
                issueDate: issueDate,
                validityDate: validityDate,
                client: JSON.parse(JSON.stringify(client)), // Clonar
                items: JSON.parse(JSON.stringify(quoteItemsData)), // Clonar
                subtotal: subtotal,
                iva: iva,
                total: total,
                notes: quoteNotesInput.value,
                status: 'Pendiente',
                googleDocId: null, // Se llenará si se guarda en Drive
                googlePdfId: null
            };
            // Añadir compañía actual para la impresión offline
             quoteRecord.companySettingsForPrint = { ...companySettings };

            // Deshabilitar botones mientras procesa
             const printButton = document.querySelector('button[onclick="generatePrintableQuote(false)"]');
             const driveButton = document.querySelector('button[onclick="generatePrintableQuote(true)"]');
             if(printButton) printButton.disabled = true;
             if(driveButton) driveButton.disabled = true;
             if(authStatus) authStatus.innerText = saveToDrive ? 'Generando y guardando...' : 'Generando para imprimir...';


            try {
                if (saveToDrive) {
                    if (authStatus) authStatus.innerText = 'Creando documento en Google Drive...';
                     console.log("Intentando crear Doc para cotización:", quoteRecord);
                    const driveAssets = await createQuoteAsGoogleDoc(quoteRecord);
                    const docIdFromDrive = driveAssets?.docId || null;
                    const pdfIdFromDrive = driveAssets?.pdfId || null;
                    quoteRecord.googleDocId = docIdFromDrive;
                    quoteRecord.googlePdfId = pdfIdFromDrive;
                    let successMessage = 'Documento creado/actualizado exitosamente en Google Drive.';
                    if (docIdFromDrive) successMessage += `\nID de documento: ${docIdFromDrive}`;
                    if (pdfIdFromDrive) successMessage += `\nPDF almacenado con ID: ${pdfIdFromDrive}`;
                    showAlert(`${successMessage}\nSe guardará el enlace en el historial.`, "Documento Creado"); // REEMPLAZO
                }

                // Preparar datos para Google Sheets (columnas A-K)
                const sheetRowData = [
                    quoteRecord.id,
                    quoteRecord.number,
                    quoteRecord.issueDate,
                    quoteRecord.validityDate,
                    JSON.stringify(quoteRecord.client), // Cliente como texto JSON
                    JSON.stringify(quoteRecord.items), // Items como texto JSON
                    quoteRecord.total,
                    quoteRecord.status,
                    quoteRecord.notes,
                    quoteRecord.googleDocId, // ID del Doc o null
                    quoteRecord.googlePdfId // ID del PDF o null
                ];

                 if (authStatus) authStatus.innerText = 'Guardando registro en Google Sheets...';
                 console.log("Guardando en Sheet:", sheetRowData);
                // Guardar en Google Sheets (Historial)
                await gapi.client.sheets.spreadsheets.values.append({
                    spreadsheetId: QUOTES_SHEET_ID,
                    range: 'Hoja 1!A:K', // Rango correcto A-K
                    valueInputOption: 'USER_ENTERED',
                    insertDataOption: 'INSERT_ROWS',
                    resource: { values: [sheetRowData] }
                });
                 console.log("Registro guardado en Sheet.");

                // Actualizar UI localmente DESPUÉS de guardar en Sheets
                // Encontrar la fila recién insertada para obtener el rowId correcto
                 const newRowIndex = quotesHistory.length + 2; // Asume que se insertó al final
                 quoteRecord.rowId = newRowIndex; // Asignar rowId al registro local
                quotesHistory.push(quoteRecord); // Añadir al array local
                renderQuotesHistory(); // Redibujar tabla de historial
                quoteCounter = quotesHistory.length + 1; // Actualizar contador
                
                // Imprimir si no se guardó en Drive
                if (!saveToDrive) {
                     if (authStatus) authStatus.innerText = 'Preparando impresión...';
                    const printArea = document.getElementById('print-area');
                     if (printArea) {
                          // Pasar la configuración actual para imprimir
                          printArea.innerHTML = buildPrintableHtml({...quoteRecord, companySettings: companySettings }); 
                          setTimeout(() => {
                               window.print();
                               if (authStatus) authStatus.innerText = 'Listo.'; // Actualizar estado después de imprimir
                           }, 500); // Dar tiempo a renderizar
                     } else {
                          console.error("Elemento 'print-area' no encontrado.");
                           if (authStatus) authStatus.innerText = 'Error: Área de impresión no encontrada.';
                      }
                } else {
                     if (authStatus) authStatus.innerText = 'Cotización generada y guardada.';
                 }

                // Limpiar formulario para la siguiente cotización
                updateQuoteNumberPreview(); // Actualizar número de previsualización
                quoteItemsData = []; // Vaciar items
                if (quoteNotesInput) quoteNotesInput.value = ''; // Limpiar notas
                renderQuoteItems(); // Limpiar tabla de items en UI

            } catch (err) {
                console.error("Error generando/guardando cotización:", err);
                const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                showAlert(`Error al generar/guardar la cotización: ${errorMsg}\nRevisa la consola.`, "Error al Guardar"); // REEMPLAZO
                 if (authStatus) authStatus.innerText = 'Error al generar/guardar.';
            } finally {
                 // Rehabilitar botones
                 if(printButton) printButton.disabled = false;
                 if(driveButton) driveButton.disabled = false;
             }
        }

        // --- FUNCIÓN PARA CREAR/ACTUALIZAR GOOGLE DOCS ---
        async function createQuoteAsGoogleDoc(quoteData) {
            // Extraer datos necesarios, con fallbacks por si algo falta
            const clientName = quoteData.client?.name || 'Cliente Desconocido';
            const clientRuc = quoteData.client?.ruc || 'N/A';
            const clientContact = quoteData.client?.contact || '';
            const number = quoteData.number || 'SIN NUMERO';
            const issueDate = quoteData.issueDate || 'N/A';
            const validityDate = quoteData.validityDate || 'N/A';
            const subtotal = quoteData.subtotal || 0;
            const iva = quoteData.iva || 0;
            const total = quoteData.total || 0;
            const notes = quoteData.notes || '';
            // const items = quoteData.items || []; // La inserción de tablas es compleja, omitida por ahora

            const docTitle = `Cotización ${number} - ${clientName}`;

             // Usar IDs reales en la comprobación
             if (!CONTRACT_TEMPLATE_ID || CONTRACT_TEMPLATE_ID === 'ID_DE_TU_PLANTILLA_DE_CONTRATO_EN_GOOGLE_DOCS') { 
                 throw new Error("ID de plantilla de contrato no configurado.");
             }
             if (!gapi?.client?.drive || !gapi?.client?.docs) {
                 throw new Error("APIs de Drive o Docs no listas.");
              }

            try {
                // 1. Copiar la plantilla
                 console.log(`Copiando plantilla ${CONTRACT_TEMPLATE_ID} para crear ${docTitle}`);
                const copyResource = { name: docTitle };
                if (QUOTES_DRIVE_FOLDER_ID) {
                    copyResource.parents = [QUOTES_DRIVE_FOLDER_ID];
                }
                const copyResponse = await gapi.client.drive.files.copy({
                    fileId: CONTRACT_TEMPLATE_ID,
                    resource: copyResource
                });
                const newDocId = copyResponse.result.id;
                 console.log("Documento copiado, nuevo ID:", newDocId);

                // 2. Preparar las solicitudes de reemplazo de texto
                const requests = [
                    { replaceAllText: { containsText: { text: '{{CLIENTE_NOMBRE}}', matchCase: false }, replaceText: clientName } },
                    { replaceAllText: { containsText: { text: '{{CLIENTE_RUC}}', matchCase: false }, replaceText: clientRuc } },
                    { replaceAllText: { containsText: { text: '{{CLIENTE_CONTACTO}}', matchCase: false }, replaceText: clientContact } },
                    { replaceAllText: { containsText: { text: '{{COTIZACION_NUMERO}}', matchCase: false }, replaceText: number } },
                    { replaceAllText: { containsText: { text: '{{FECHA_EMISION}}', matchCase: false }, replaceText: issueDate } },
                    { replaceAllText: { containsText: { text: '{{FECHA_VALIDEZ}}', matchCase: false }, replaceText: validityDate } },
                    { replaceAllText: { containsText: { text: '{{SUBTOTAL}}', matchCase: false }, replaceText: `$${subtotal.toFixed(2)}` } },
                    { replaceAllText: { containsText: { text: '{{IVA}}', matchCase: false }, replaceText: `$${iva.toFixed(2)}` } },
                    { replaceAllText: { containsText: { text: '{{TOTAL}}', matchCase: false }, replaceText: `$${total.toFixed(2)}` } },
                    { replaceAllText: { containsText: { text: '{{NOTAS}}', matchCase: false }, replaceText: notes } },
                ];

                // 3. Ejecutar el batchUpdate para reemplazar texto
                 console.log("Ejecutando batchUpdate en Doc ID:", newDocId);
                await gapi.client.docs.documents.batchUpdate({
                    documentId: newDocId,
                    resource: { requests }
                });
                 console.log("batchUpdate completado.");

                let newPdfId = null;
                try {
                    newPdfId = await savePdfToDriveFromDoc(newDocId, `${docTitle}.pdf`);
                    if (newPdfId) {
                        console.log('PDF generado y guardado en Drive con ID:', newPdfId);
                    }
                } catch (pdfError) {
                    console.error('Error generando o guardando el PDF en Drive:', pdfError);
                    showAlert('La cotización se guardó como documento en Drive, pero ocurrió un problema al generar el PDF. Puedes intentarlo nuevamente desde el historial.', 'Advertencia al generar PDF');
                }

                return { docId: newDocId, pdfId: newPdfId }; // Devolver ambos IDs

            } catch (err) {
                 console.error("Error creando Google Doc:", err);
                 const errorMsg = err.result?.error?.message || err.message || "Error desconocido.";
                 // REEMPLAZO DE ALERT
                 showAlert(`Error al crear el documento en Google Drive: ${errorMsg}\nRevisa la consola para más detalles.`, "Error en Google Drive");
                 throw err; // Relanzar el error
             }
        }


        // --- LÓGICA DE PESTAÑAS ---
        function changeTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            const tabElement = document.getElementById(tabName);
             if (tabElement) tabElement.classList.add('active');
             // Asegurarse de que event.currentTarget exista
             if (event && event.currentTarget) {
                 event.currentTarget.classList.add('active');
              } else {
                   // Fallback si el evento no está bien formado (ej, llamado programáticamente sin evento)
                   const currentButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
                   if (currentButton) currentButton.classList.add('active');
               }
            
            // Llamar a funciones de renderizado específicas de la pestaña
            if (tabName === 'dashboard') renderDashboard();
            if (tabName === 'contratos') renderContractsPage();
            if (tabName === 'portal') renderClientPortalPage();
        }

        // --- LÓGICA DEL COTIZADOR ---
        function updateQuoteNumberPreview() {
            // Chequeo de existencia de elementos
            if (!quoteClientSelect || !quoteNumberInput) return; 
            
            const selectedClientId = quoteClientSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            const clientCode = client ? client.code : 'CLIENTE'; // client.code es el RUC/ID
            // Usa el contador actual del historial + 1
            const sequential = (quotesHistory.length + 1).toString().padStart(4, '0'); 
            const now = new Date();
            // Formato YYYYMMDD
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            quoteNumberInput.value = `${clientCode}-${dateStr}-${sequential}`;
        }

        function updateClientDropdowns() {
            const selects = [quoteClientSelect, contractClientSelect, portalClientSelect];
            selects.forEach(select => {
                 if (!select) return; // Chequear si el select existe en el DOM
                const currentValue = select.value; // Guardar valor actual si existe
                select.innerHTML = '<option value="">-- Seleccione un cliente --</option>'; // Opción por defecto más clara
                // Ordenar clientes alfabéticamente por nombre
                [...clients].sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(client => { // Añadir fallback para name
                    const option = document.createElement('option');
                    option.value = client.id; // client.id es el RUC/ID
                    option.textContent = `${client.name || 'Sin Nombre'} (${client.ruc || 'Sin RUC'})`; // Añadir fallback
                    select.appendChild(option);
                });
                 // Intentar restaurar valor si es posible
                 if (currentValue && select.querySelector(`option[value="${currentValue}"]`)) {
                     select.value = currentValue;
                 }
            });
        }
        
        // Manejador para el cambio en el select de cliente del cotizador
        function handleQuoteClientChange() {
             if (!quoteClientSelect || !quoteRUCInput) return; // Chequeo
            const selectedClientId = quoteClientSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            quoteRUCInput.value = client ? client.ruc : ''; // Poner RUC en el campo RUC
            updateQuoteNumberPreview(); // Actualizar número de cotización
        }
        
        // Actualizar el dropdown de servicios
        function updateServiceDropdown() {
             if (!serviceSelect) return; // Chequeo
             const currentValue = serviceSelect.value;
            serviceSelect.innerHTML = '<option value="">-- Seleccione un servicio --</option>';
            // Ordenar servicios alfabéticamente
            [...services].sort((a, b) => (a.name || '').localeCompare(b.name || '')).forEach(service => { // Añadir fallback
                const option = document.createElement('option');
                option.value = service.id; // service.id es de Col A
                option.textContent = `${service.name || 'Sin Nombre'} - $${(service.price || 0).toFixed(2)}`; // Añadir fallback
                serviceSelect.appendChild(option);
            });
             if (currentValue && serviceSelect.querySelector(`option[value="${currentValue}"]`)) {
                 serviceSelect.value = currentValue;
             }
        }

        // Añadir servicio a la tabla temporal de la cotización
        function addServiceToQuote() {
             if (!serviceSelect) return; // Chequeo
            const serviceId = serviceSelect.value;
            if (!serviceId) { showAlert('Por favor, seleccione un servicio.'); return; } // REEMPLAZO
            const service = services.find(s => s.id === serviceId);
            if (!service) { showAlert('Servicio seleccionado no encontrado en la lista cargada.'); return; } // REEMPLAZO
            
            // Buscar si ya existe en la cotización actual
            const existingItemIndex = quoteItemsData.findIndex(item => item.id === serviceId);
            if (existingItemIndex > -1) {
                // Si existe, incrementar cantidad
                quoteItemsData[existingItemIndex].quantity++;
            } else {
                // Si no existe, añadirlo con cantidad 1
                quoteItemsData.push({ 
                    id: service.id, 
                    name: service.name, 
                    description: service.description, // Aunque no se muestra, guardarlo
                    price: service.price, 
                    quantity: 1 
                });
            }
            renderQuoteItems(); // Redibujar la tabla de items
        }
        
        // Dibujar la tabla de items de la cotización actual
        function renderQuoteItems() {
             if (!quoteItemsBody) return; // Chequeo
            quoteItemsBody.innerHTML = ''; // Limpiar tabla
            if (quoteItemsData.length === 0) {
                quoteItemsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Añada servicios a la cotización.</td></tr>`;
            } else {
                quoteItemsData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    const itemPrice = parseFloat(item.price) || 0; // Fallback numérico
                    const itemQuantity = parseFloat(item.quantity) || 1; // Fallback numérico
                    const totalPrice = (itemPrice * itemQuantity).toFixed(2);
                    // Input de cantidad ahora llama a updateQuantity con 'index' y 'this'
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-normal align-top">
                            <div class="font-medium text-gray-800">${item.name || 'N/A'}</div>
                        </td>
                        <td class="px-4 py-3 align-top">
                            <input type="number" min="1" value="${itemQuantity}" onchange="updateQuantity(${index}, this)" class="w-20 p-1 border border-gray-300 rounded-md text-center">
                        </td>
                        <td class="px-4 py-3 align-top text-right">
                            <input type="number" min="0" step="0.01" value="${itemPrice.toFixed(2)}" onchange="updatePrice(${index}, this)" class="w-24 p-1 border border-gray-300 rounded-md text-right">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap font-medium align-top text-right">$${totalPrice}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right align-top">
                            <button onclick="removeQuoteItem(${index})" class="text-red-600 hover:text-red-900" title="Quitar Item"><i class="fas fa-trash"></i></button>
                        </td>`;
                    quoteItemsBody.appendChild(row);
                });
            }
            calculateTotals(); // Recalcular totales cada vez que se redibuja
        }

        // Actualizar cantidad de un item
        function updateQuantity(index, inputElement) {
             if (!inputElement) return; // Chequeo
             // Validar que el índice es válido
             if (index < 0 || index >= quoteItemsData.length) {
                 console.error("Índice inválido para actualizar cantidad:", index);
                 inputElement.value = 1; // Resetear input a 1 si el índice es malo
                 return;
             }
            const newQuantity = parseInt(inputElement.value);
            // Validar que la cantidad sea un número positivo
            if (isNaN(newQuantity) || newQuantity < 1) {
                 showAlert("La cantidad debe ser un número mayor o igual a 1."); // REEMPLAZO
                 inputElement.value = quoteItemsData[index].quantity; // Restaurar valor anterior válido
                 return;
            }
            quoteItemsData[index].quantity = newQuantity;
            renderQuoteItems(); // Redibujar para actualizar total del item y resumen
        }

        function updatePrice(index, inputElement) {
            if (!inputElement) return;
            if (index < 0 || index >= quoteItemsData.length) {
                console.error('Índice inválido para actualizar precio:', index);
                inputElement.value = quoteItemsData[index]?.price?.toFixed?.(2) || '0.00';
                return;
            }
            const newPrice = parseFloat(inputElement.value);
            if (isNaN(newPrice) || newPrice < 0) {
                showAlert('El precio debe ser un número mayor o igual a 0.');
                inputElement.value = (quoteItemsData[index].price || 0).toFixed(2);
                return;
            }
            quoteItemsData[index].price = parseFloat(newPrice.toFixed(2));
            inputElement.value = quoteItemsData[index].price.toFixed(2);
            renderQuoteItems();
        }

        // Quitar un item de la cotización
        function removeQuoteItem(index) {
             if (index < 0 || index >= quoteItemsData.length) {
                 console.error("Índice inválido para quitar item:", index);
                 return;
             }
            // Quitar el item del array
            const removedItem = quoteItemsData.splice(index, 1); 
            console.log("Item quitado:", removedItem[0]?.name);
            renderQuoteItems(); // Redibujar la tabla
        }

        // Calcular y mostrar Subtotal, IVA y Total
        function calculateTotals() {
            // Usar fallbacks en reduce
            const subtotal = quoteItemsData.reduce((acc, item) => {
                const itemPrice = parseFloat(item.price) || 0;
                const itemQuantity = parseFloat(item.quantity) || 1;
                return acc + (itemPrice * itemQuantity);
            }, 0);
            const iva = parseFloat((subtotal * IVA_RATE).toFixed(2));
            const total = parseFloat((subtotal + iva).toFixed(2));
            
            // Actualizar elementos del DOM (con chequeos)
            const subtotalEl = document.getElementById('subtotal');
            const ivaEl = document.getElementById('iva');
            const totalEl = document.getElementById('total');
            if(subtotalEl) subtotalEl.textContent = `$${subtotal.toFixed(2)}`;
            if(ivaEl) ivaEl.textContent = `$${iva.toFixed(2)}`;
            if(totalEl) totalEl.textContent = `$${total.toFixed(2)}`;
        }


        // --- LÓGICA DE CONFIGURACIÓN (localStorage) ---
        function loadSettings() {
             // Chequeos de elementos
             if (!companyNameInput || !companyAddressInput || !companyContactInput || !companyWebsiteInput || !companyWhatsappInput || !logoPreview || !primaryColorInput || !accentColorInput) {
                 console.warn("Faltan elementos del formulario de configuración.");
                 return;
              }
             // Usar valores por defecto si no existen en companySettings
            companyNameInput.value = companySettings.name || 'Tu Empresa S.A.';
            companyAddressInput.value = companySettings.address || 'Tu Dirección, Guayaquil';
            companyContactInput.value = companySettings.contact || 'tuemail@empresa.com';
            companyWebsiteInput.value = companySettings.website || '';
            companyWhatsappInput.value = companySettings.whatsapp || '';
            logoPreview.src = companySettings.logo || 'https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo';
            primaryColorInput.value = companySettings.primaryColor || '#1a202c';
            accentColorInput.value = companySettings.accentColor || '#4f46e5';
            
            // Aplicar color de acento a elementos relevantes
            applyAccentColor(); 
        }

         // Función para aplicar el color de acento
         function applyAccentColor() {
             const accentColor = companySettings.accentColor || '#4f46e5';
             const totalLabelEl = document.getElementById('total-label');
             const totalEl = document.getElementById('total');
             if (totalLabelEl) totalLabelEl.style.color = accentColor;
             if (totalEl) totalEl.style.color = accentColor;
         }

        // Manejador para cambio de logo
        function handleLogoUploadChange(e) {
             if (!logoPreview) return;
             if (!e.target.files || e.target.files.length === 0) return; // Chequear si hay archivos
            const file = e.target.files[0];
            
            // Validaciones
             if (!file.type.startsWith('image/')) {
                 showAlert("Por favor, selecciona un archivo de imagen válido."); // REEMPLAZO
                 e.target.value = ''; // Limpiar input
                 return;
             }
             if (file.size > 2 * 1024 * 1024) { // Límite de 2MB
                 showAlert("El archivo es muy grande (máx 2MB)."); // REEMPLAZO
                 e.target.value = ''; // Limpiar input
                 return;
              }

            const reader = new FileReader();
            reader.onload = (event) => {
                const logoBase64 = event.target.result;
                logoPreview.src = logoBase64; // Mostrar preview
                companySettings.logo = logoBase64; // Guardar en objeto
                try {
                    localStorage.setItem('companySettings', JSON.stringify(companySettings)); // Guardar en localStorage
                    console.log("Logo guardado en localStorage.");
                } catch (error) {
                    console.error("Error guardando logo en localStorage:", error);
                    showAlert("Hubo un error al guardar el logo. El almacenamiento local podría estar lleno."); // REEMPLAZO
                }
            };
             reader.onerror = (error) => {
                 console.error("Error leyendo archivo de logo:", error);
                 showAlert("Error al leer el archivo de logo seleccionado."); // REEMPLAZO
                 e.target.value = ''; // Limpiar input
             };
            reader.readAsDataURL(file);
        }

        // Manejador para guardar configuración
        function handleConfigFormSubmit(e) {
             e.preventDefault();
             // Chequeos de elementos
             if (!companyNameInput || !companyAddressInput || !companyContactInput || !companyWebsiteInput || !companyWhatsappInput || !primaryColorInput || !accentColorInput) {
                 showAlert("Error: Faltan elementos del formulario de configuración para guardar.", "Error de Formulario"); // REEMPLAZO
                 return;
              }
            // Actualizar objeto companySettings
            companySettings.name = companyNameInput.value.trim();
            companySettings.address = companyAddressInput.value.trim();
            companySettings.contact = companyContactInput.value.trim();
            companySettings.website = companyWebsiteInput.value.trim();
            companySettings.whatsapp = companyWhatsappInput.value.trim();
            companySettings.primaryColor = primaryColorInput.value;
            companySettings.accentColor = accentColorInput.value;
            // Guardar en localStorage
            try {
                localStorage.setItem('companySettings', JSON.stringify(companySettings));
                loadSettings(); // Recargar y aplicar cambios (ej. color)
                showAlert('Configuración guardada localmente.'); // REEMPLAZO
            } catch (error) {
                 console.error("Error guardando configuración en localStorage:", error);
                 showAlert("Hubo un error al guardar la configuración local."); // REEMPLAZO
             }
        }

        // --- LÓGICA DEL DASHBOARD ---
         function renderDashboard() {
            // Filtrar cotizaciones aceptadas válidas
            const acceptedQuotes = quotesHistory.filter(q => q && q.status === 'Aceptada'); 
            const totalSales = acceptedQuotes.reduce((sum, q) => sum + (q.total || 0), 0); // Usar 0 si total falta
            const averageSale = acceptedQuotes.length > 0 ? totalSales / acceptedQuotes.length : 0;
            
            // Actualizar elementos del DOM (con chequeos)
            const totalSalesEl = document.getElementById('total-sales');
            const averageSaleEl = document.getElementById('average-sale');
            const totalQuotesEl = document.getElementById('total-quotes');
            const bestSellerEl = document.getElementById('best-seller');

             if (totalSalesEl) totalSalesEl.textContent = `$${totalSales.toFixed(2)}`;
             if (averageSaleEl) averageSaleEl.textContent = `$${averageSale.toFixed(2)}`;
             // Contar todas las cotizaciones válidas
             if (totalQuotesEl) totalQuotesEl.textContent = quotesHistory.filter(q => q).length; 

            // Calcular producto más vendido
            const salesByProduct = {};
            acceptedQuotes.forEach(q => {
                (q.items || []).forEach(item => { 
                    if (item && item.name) { // Asegurarse que item y name existan
                        if (!salesByProduct[item.name]) {
                            salesByProduct[item.name] = 0;
                        }
                        salesByProduct[item.name] += (item.quantity || 1); // Usar 1 si quantity falta
                    }
                });
            });

            let bestSeller = '-';
            let maxQuantity = 0;
            for (const productName in salesByProduct) {
                if (salesByProduct[productName] > maxQuantity) {
                    maxQuantity = salesByProduct[productName];
                    bestSeller = productName;
                }
            }
             if (bestSellerEl) bestSellerEl.textContent = bestSeller;

            // Calcular ventas por mes
            const salesByMonth = {};
            acceptedQuotes.forEach(q => {
                 // Validar fecha antes de procesar
                 if (q.issueDate && typeof q.issueDate === 'string') {
                     const parts = q.issueDate.split('/');
                     if (parts.length === 3) {
                         const [day, month, year] = parts;
                          // Validar que sean números
                          if (!isNaN(parseInt(day)) && !isNaN(parseInt(month)) && !isNaN(parseInt(year))) {
                             const monthYear = `${year}-${month.padStart(2, '0')}`; // Asegurar formato YYYY-MM
                             if (!salesByMonth[monthYear]) salesByMonth[monthYear] = 0;
                             salesByMonth[monthYear] += (q.total || 0); // Usar 0 si total falta
                           } else {
                               console.warn("Fecha inválida en historial:", q.issueDate);
                           }
                     } else {
                          console.warn("Formato de fecha inesperado:", q.issueDate);
                      }
                 }
            });

            // Preparar datos para el gráfico y ordenarlos
            const chartData = Object.keys(salesByMonth).map(key => ({
                month: key, // Formato YYYY-MM
                sales: salesByMonth[key]
            })).sort((a, b) => {
                 // Ordenar por fecha YYYY-MM
                 const [yearA, monthA] = a.month.split('-');
                 const [yearB, monthB] = b.month.split('-');
                 return new Date(yearA, monthA - 1) - new Date(yearB, monthB - 1);
             });
            
            drawSalesChart(chartData); // Dibujar el gráfico
        }

        // Dibujar gráfico de barras con D3
        function drawSalesChart(data) {
            const container = d3.select("#sales-chart-container");
             if (container.empty()) { console.error("Contenedor del gráfico no encontrado."); return; } // Chequeo
            container.selectAll("*").remove(); // Limpiar contenido anterior

            if (!data || data.length === 0) {
                container.append("div").attr("class", "flex items-center justify-center h-full text-gray-500").text("No hay datos de ventas aceptadas para mostrar.");
                return;
            }

            const margin = {top: 20, right: 30, bottom: 70, left: 80}; // Ajustar márgenes
            try {
                const containerNode = container.node();
                if (!containerNode) return; 
                // Asegurar dimensiones mínimas
                const width = Math.max(containerNode.getBoundingClientRect().width - margin.left - margin.right, 200);
                const height = Math.max(containerNode.getBoundingClientRect().height - margin.top - margin.bottom, 150);

                const svg = container.append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);
                
                // Eje X (Meses)
                const x = d3.scaleBand()
                    .range([0, width])
                    .domain(data.map(d => d.month)) // Usa YYYY-MM como dominio
                    .padding(0.3); // Aumentar padding

                svg.append("g")
                    .attr("transform", `translate(0,${height})`)
                    .call(d3.axisBottom(x))
                    .selectAll("text")
                    .attr("transform", "translate(-10,5)rotate(-45)") // Ajustar rotación y posición
                    .style("text-anchor", "end")
                    .style("font-size", "10px"); // Tamaño de fuente más pequeño

                // Eje Y (Ventas en $)
                const yMax = d3.max(data, d => d.sales);
                const y = d3.scaleLinear()
                    .domain([0, yMax > 0 ? yMax * 1.1 : 1]) // Dar un poco de espacio arriba, evitar dominio 0
                    .range([height, 0]);

                svg.append("g")
                    .call(d3.axisLeft(y).ticks(5).tickFormat(d => `$${d.toLocaleString('es-EC', { maximumFractionDigits: 0 })}`)) // Formato de moneda local sin decimales
                    .style("font-size", "10px");

                // Barras
                svg.selectAll(".bar")
                    .data(data)
                    .enter()
                    .append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d.month))
                    .attr("y", d => y(d.sales))
                    .attr("width", x.bandwidth())
                    .attr("height", d => Math.max(0, height - y(d.sales))) // Asegurar altura >= 0
                    .attr("fill", companySettings.accentColor || '#4f46e5') // Usar color de acento
                     // Tooltip básico (opcional)
                    .append("title") 
                    .text(d => `${d.month}: $${d.sales.toFixed(2)}`);

            } catch(e) {
                 console.error("Error dibujando gráfico D3:", e);
                 container.html('<p class="text-red-500 text-center p-4">Error al renderizar el gráfico.</p>'); // Mostrar error en UI
             }
        }

        // --- LÓGICA DE CONTRATOS Y PORTAL ---
         function renderContractsPage() {
             // Disparar evento change en el select de cliente para actualizar las cotizaciones
             if (contractClientSelect) {
                 handleContractClientChange(); // Llamar directamente a la función que actualiza
             }
        }

        // Manejador de cambio en select de cliente (pestaña Contratos)
        function handleContractClientChange() {
             // Chequeos robustos
             if (!contractClientSelect || !contractQuoteSelect || !contractText || !saveContractBtn) {
                 console.warn("Faltan elementos en la pestaña de Contratos.");
                 return;
              }
            const clientId = contractClientSelect.value;
            contractQuoteSelect.innerHTML = '<option value="">-- Seleccione cotización --</option>'; // Limpiar y poner default
            contractText.value = ''; // Limpiar área de texto
            saveContractBtn.disabled = true; // Deshabilitar botón de guardar

            if (clientId) {
                // Filtrar cotizaciones del cliente seleccionado que estén 'Aceptada'
                const clientQuotes = quotesHistory.filter(q => q && q.client && q.client.id === clientId && q.status === 'Aceptada');
                if (clientQuotes.length > 0) {
                    clientQuotes.forEach(q => {
                        const option = document.createElement('option');
                        option.value = q.id;
                        option.textContent = q.number; // Mostrar número de cotización
                        contractQuoteSelect.appendChild(option);
                    });
                } else {
                     contractQuoteSelect.innerHTML = '<option value="">-- No hay cotizaciones aceptadas --</option>';
                 }
            }
        }

        function deleteQuote(quoteId, rowId, googleDocId = '', googlePdfId = '') {
            if (!quoteId || !rowId) {
                showAlert('No se pudo determinar qué cotización eliminar.', 'Error al eliminar');
                return;
            }
            if (!QUOTES_SHEET_ID || QUOTES_SHEET_ID === 'ID_DE_TU_HOJA_DE_COTIZACIONES') {
                showAlert('Falta configurar el ID de la hoja de historial antes de eliminar.', 'Error de Configuración');
                return;
            }
            if (!gapi?.client?.sheets) {
                showAlert('La API de Google Sheets no está lista. Intenta nuevamente en unos segundos.', 'API no disponible');
                return;
            }

            const sanitizedDocId = (googleDocId && googleDocId !== 'null' && googleDocId !== 'undefined') ? googleDocId : '';
            const sanitizedPdfId = (googlePdfId && googlePdfId !== 'null' && googlePdfId !== 'undefined') ? googlePdfId : '';

            showConfirm('¿Deseas eliminar esta cotización del historial?\nEsta acción limpiará la fila en Google Sheets y enviará a la papelera los archivos relacionados en Drive.', async () => {
                try {
                    if (authStatus) authStatus.innerText = `Eliminando cotización en la fila ${rowId}...`;
                    const range = `Hoja 1!A${rowId}:K${rowId}`;
                    await gapi.client.sheets.spreadsheets.values.clear({
                        spreadsheetId: QUOTES_SHEET_ID,
                        range
                    });

                    if (sanitizedDocId) {
                        await trashDriveFile(sanitizedDocId);
                    }
                    if (sanitizedPdfId) {
                        await trashDriveFile(sanitizedPdfId);
                    }

                    quotesHistory = quotesHistory.filter(q => q.id !== quoteId);
                    quoteCounter = quotesHistory.length + 1;
                    renderQuotesHistory();
                    renderDashboard();
                    showAlert('Cotización eliminada correctamente.', 'Cotización eliminada');
                } catch (error) {
                    console.error('Error al eliminar la cotización:', error);
                    const errorMsg = error.result?.error?.message || error.message || 'Error desconocido.';
                    showAlert(`No se pudo eliminar la cotización: ${errorMsg}`, 'Error al eliminar');
                } finally {
                    if (authStatus) authStatus.innerText = 'Listo.';
                }
            }, 'Eliminar cotización');
        }
        
         // Manejador de cambio en select de cotización (pestaña Contratos)
         function handleContractQuoteChange() {
             // Chequeos
             if (!contractQuoteSelect || !contractText || !saveContractBtn) return;
             
             const quoteId = contractQuoteSelect.value;
             contractText.value = ''; // Limpiar siempre al cambiar
             saveContractBtn.disabled = !quoteId; // Habilitar botón solo si se selecciona una cotización válida

             if (quoteId) {
                 contractText.placeholder = "Escribe aquí el contenido del contrato o carga desde Doc existente...";
                 // TODO: Si la cotización tiene googleDocId, ofrecer cargar su contenido
                 // const quote = quotesHistory.find(q => q.id === quoteId);
                 // if(quote && quote.googleDocId) { ... }
             } else {
                 contractText.placeholder = "Selecciona una cotización aceptada para redactar el contrato...";
              }
         }

        // Renderizar página del portal cliente
        function renderClientPortalPage() {
             if (portalClientSelect) {
                 handlePortalClientChange();
             }
        }
        
        // Manejador de cambio en select de cliente (pestaña Portal)
        function handlePortalClientChange() {
             // Chequeos
             if (!portalClientSelect || !clientPortalContent) {
                 console.warn("Faltan elementos en la pestaña Portal Cliente.");
                 return;
              }
             
            const clientId = portalClientSelect.value;
            clientPortalContent.innerHTML = '<p class="text-gray-500 animate-pulse">Cargando...</p>'; 

            if (!clientId) {
                clientPortalContent.innerHTML = '<p class="text-gray-500">Seleccione un cliente para ver su historial.</p>';
                return;
            }

            // Filtrar cotizaciones válidas del cliente
            const clientQuotes = quotesHistory.filter(q => q && q.client && q.client.id === clientId);
            
            if (clientQuotes.length === 0) {
                clientPortalContent.innerHTML = '<p class="text-gray-500">Este cliente no tiene cotizaciones registradas.</p>';
                return;
            }
            
            // Construir HTML
            let contentHtml = '';
            [...clientQuotes].reverse().forEach(quote => {
                const docLinkHtml = quote.googleDocId
                    ? `<a href="https://docs.google.com/document/d/${quote.googleDocId}/edit" target="_blank" class="text-sm text-blue-600 hover:underline ml-4"><i class="fas fa-link mr-1"></i>Ver Documento</a>`
                    : '';
                const pdfLinkHtml = quote.googlePdfId
                    ? `<a href="https://drive.google.com/file/d/${quote.googlePdfId}/view" target="_blank" class="text-sm text-red-600 hover:underline ml-2"><i class="fas fa-file-pdf mr-1"></i>Ver PDF</a>`
                    : '';
                contentHtml += `
                    <div class="mb-6 pb-4 border-b border-gray-200 last:border-b-0">
                        <div class="flex flex-wrap justify-between items-center gap-2 mb-1">
                            <h3 class="text-lg font-semibold text-gray-800">${quote.number || 'N/A'}</h3>
                            <span class="status-badge status-${quote.status || 'Pendiente'}">${quote.status || 'Pendiente'}</span>
                        </div>
                        <p class="text-sm text-gray-600">
                            <span class="mr-3">Emitida: ${quote.issueDate || 'N/A'}</span> |
                            <span class="mx-3">Total: <b class="text-gray-900">$${(quote.total || 0).toFixed(2)}</b></span>
                            ${docLinkHtml}
                            ${pdfLinkHtml}
                        </p>
                    </div>
                `;
            });
            clientPortalContent.innerHTML = contentHtml; 
        }

        // --- LÓGICA DE IMPRESIÓN ---
        function buildPrintableHtml(quoteData) {
            // Validación robusta de datos de entrada
            if (!quoteData || !quoteData.companySettings || !quoteData.client || !Array.isArray(quoteData.items)) {
                 console.error("buildPrintableHtml: Datos incompletos o inválidos:", quoteData);
                 return '<p style="color: red; font-weight: bold; text-align: center; padding: 20px;">Error: No se pueden generar los datos de la cotización para imprimir.</p>';
             }
            
            const { companySettings: cs, client, items, number, issueDate, validityDate, subtotal, iva, total, notes } = quoteData;
            
            // Usar valores por defecto o 'N/A' si faltan datos
            const logoHtml = cs.logo ? `<img src="${cs.logo}" alt="Logo ${cs.name || ''}" style="max-height: 80px; width: auto; object-fit: contain;">` : '';
            const companyName = cs.name || 'Nombre Empresa N/A';
            const companyAddress = cs.address || '';
            const companyContact = cs.contact || '';
            const clientName = client.name || 'Cliente N/A';
            const clientRuc = client.ruc || 'RUC/CI N/A';
            const clientContact = client.contact || '';
            const quoteNumber = number || 'N/A';
            const quoteIssueDate = issueDate || 'N/A';
            const quoteValidityDate = validityDate || 'N/A';
            const quoteSubtotal = subtotal || 0;
            const quoteIva = iva || 0;
            const quoteTotal = total || 0;
            const quoteNotes = notes || '';
            const primaryColor = cs.primaryColor || '#1a202c'; // Negro como fallback
            const accentColor = cs.accentColor || '#4f46e5'; // Indigo como fallback

            // Generar filas de la tabla de items
            const itemsHtml = items.map(item => {
                 // Validar cada item
                 const itemName = item.name || 'Servicio/Producto N/A';
                 const itemQty = item.quantity || 1;
                 const itemPrice = item.price || 0;
                 const itemTotalPrice = itemPrice * itemQty;
                 return `<tr class="border-b">
                             <td class="py-3 px-4 align-top"><p class="font-semibold">${itemName}</p></td>
                             <td class="py-3 px-4 text-center align-top">${itemQty}</td>
                             <td class="py-3 px-4 text-right align-top">$${itemPrice.toFixed(2)}</td>
                             <td class="py-3 px-4 text-right align-top">$${itemTotalPrice.toFixed(2)}</td>
                         </tr>`;
             }).join('');

            // Generar sección de notas solo si hay notas
            const notesHtml = quoteNotes ? `<div class="mt-10 pt-4 border-t"><h4 class="font-bold text-sm mb-2 uppercase">Notas Adicionales:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">${quoteNotes}</p></div>` : '';

            // Generar enlaces del footer solo si existen
            let footerLinksHtml = '';
            const websiteLink = cs.website ? `<a href="${cs.website.startsWith('http') ? cs.website : 'https://' + cs.website}" target="_blank" class="text-sm mx-2" style="color: ${primaryColor}; text-decoration: none;">${cs.website.replace(/^(https?:\/\/)?(www\.)?/, '')}</a>` : '';
            const whatsappLink = cs.whatsapp ? `<a href="https://wa.me/${cs.whatsapp.replace(/\D/g,'')}" target="_blank" class="text-sm mx-2" style="color: ${primaryColor}; text-decoration: none;"><i class="fab fa-whatsapp"></i> ${cs.whatsapp}</a>` : '';
            if (websiteLink || whatsappLink) {
                footerLinksHtml = `<div class="mb-4 text-center">${websiteLink}${websiteLink && whatsappLink ? '<span class="text-gray-400">|</span>' : ''}${whatsappLink}</div>`;
            }

            // Construir el HTML final
            return `
                <div class="p-8 max-w-4xl mx-auto bg-white font-sans text-sm">
                    <header class="flex justify-between items-start mb-10 pb-4 border-b">
                        <div class="w-1/2 pr-4">${logoHtml}</div>
                        <div class="w-1/2 text-right">
                            <h1 class="text-3xl font-bold" style="color: ${primaryColor};">COTIZACIÓN</h1>
                            <p class="text-gray-600 mt-1">Nº: <span class="font-mono">${quoteNumber}</span></p>
                        </div>
                    </header>
                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-2 uppercase text-xs tracking-wider">Cliente:</h3>
                            <p class="font-semibold text-base">${clientName}</p>
                            <p class="text-gray-600">RUC/C.I.: ${clientRuc}</p>
                            <p class="text-gray-600">${clientContact}</p>
                        </div>
                        <div class="bg-gray-50 p-4 rounded-lg border border-gray-200">
                            <h3 class="font-bold text-gray-700 mb-2 uppercase text-xs tracking-wider">De:</h3>
                            <p class="font-semibold text-base">${companyName}</p>
                            <p class="text-gray-600">${companyAddress}</p>
                            <p class="text-gray-600">${companyContact}</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-8 mb-8">
                        <div>
                             <h3 class="font-bold text-gray-700 mb-2 uppercase text-xs tracking-wider">Fechas:</h3>
                             <p><span class="font-medium">Emitida:</span> ${quoteIssueDate}</p>
                             <p><span class="font-medium">Válida hasta:</span> ${quoteValidityDate}</p>
                        </div>
                    </div>
                    <table class="w-full mb-8 text-left border-collapse">
                        <thead style="background-color: ${primaryColor}; color: white;">
                            <tr>
                                <th class="py-2 px-4 text-left font-semibold uppercase text-xs tracking-wider">Descripción</th>
                                <th class="py-2 px-4 text-center font-semibold uppercase text-xs tracking-wider">Cant.</th>
                                <th class="py-2 px-4 text-right font-semibold uppercase text-xs tracking-wider">P. Unit.</th>
                                <th class="py-2 px-4 text-right font-semibold uppercase text-xs tracking-wider">Total Item</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">${itemsHtml}</tbody>
                    </table>
                    <div class="flex justify-end">
                        <div class="w-full sm:w-1/2 lg:w-2/5">
                            <div class="flex justify-between py-1 border-t border-gray-200"><span class="font-medium text-gray-600">Subtotal:</span><span class="text-gray-800">$${quoteSubtotal.toFixed(2)}</span></div>
                            <div class="flex justify-between py-1"><span class="font-medium text-gray-600">IVA (${(IVA_RATE * 100).toFixed(0)}%):</span><span class="text-gray-800">$${quoteIva.toFixed(2)}</span></div>
                            <div class="flex justify-between py-2 mt-2 border-t-2" style="border-color: ${primaryColor};">
                                <span class="font-bold text-lg" style="color: ${accentColor};">TOTAL:</span>
                                <span class="font-bold text-lg" style="color: ${accentColor};">$${quoteTotal.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                    ${notesHtml}
                    <footer class="mt-16 pt-6 border-t text-center text-gray-500 text-xs">
                        ${footerLinksHtml}
                        <p class="mb-1">Gracias por su preferencia.</p>
                        <p>Esta cotización es un documento informativo generado por sistema.</p>
                    </footer>
                </div>
            `;
        }

        // Función para reimprimir una cotización del historial
        function reprintQuote(quoteId) {
            const quoteData = quotesHistory.find(q => q.id === quoteId);
            if (quoteData) {
                 const printArea = document.getElementById('print-area');
                 if (printArea) {
                      // Usar la config actual para reimprimir, ya que la guardada podría ser vieja
                      printArea.innerHTML = buildPrintableHtml({...quoteData, companySettings: companySettings });
                      setTimeout(() => { window.print(); }, 500); // Dar tiempo a renderizar
                 } else {
                      console.error("Elemento 'print-area' no encontrado para reimprimir.");
                  }
            } else {
                 showAlert("No se encontró la cotización en el historial para reimprimir."); // REEMPLAZO
             }
        }
        
        
        // --- INICIALIZACIÓN DE LA APP ---
        document.addEventListener('DOMContentLoaded', () => {
             console.log("DOM listo. Asignando elementos y iniciando carga de APIs...");
             assignDOMElements(); // Asigna las variables de elementos del DOM
             initModal(); // Inicializa los elementos del modal
             initializeApp().catch(err => { // Iniciar carga de GAPI/GIS
                 console.error("Fallo la inicialización general de la app:", err);
                 if(authStatus) authStatus.innerText = "Error crítico al inicializar. Recarga la página.";
                 // Podrías mostrar un mensaje más visible al usuario aquí
                 showAlert("Error crítico al inicializar las APIs de Google. Por favor, recarga la página.", "Error Crítico");
              }); 
        });

    </script>
    
    <!-- Scripts de Google SIN onload, se cargan y manejan desde initializeApp -->
    <!-- <script async defer src="https://apis.google.com/js/api.js"></script> -->
    <!-- <script async defer src="https://accounts.google.com/gsi/client"></script> -->
    <!-- Los scripts se añaden dinámicamente en initializeApp -->
    <!-- Fin del documento -->

</body>
</html>
