<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Cotización v13 (Estabilidad y Funciones Completas)</title>
    <!-- Tailwind CSS Config: Habilitar modo oscuro por clase -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class', // Habilita el modo oscuro mediante la clase 'dark'
            theme: {
                extend: {}
            }
        }
    </script>
    <!-- Carga de múltiples fuentes para selección -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Roboto:wght@400;500;700&family=Open+Sans:wght@400;600;700&family=Montserrat:wght@500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <!-- Dependencia para Selectores con Búsqueda (Tom Select) -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/tom-select/2.2.2/css/tom-select.bootstrap5.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tom-select/2.2.2/js/tom-select.complete.min.js"></script>
    <style id="dynamic-styles">
        /* Estilos generales que se adaptan con Dark Mode */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }
        body.dark {
            background-color: #1f2937; /* gray-800 */
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        .dark .tab-button.active {
            background-color: #3730a3; /* indigo-700 */
            color: white;
            border-color: #6366f1;
        }
        
        /* Estilos de elementos específicos */
        #logoPreview {
            max-width: 200px;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        .header-logo {
            max-height: 50px;
            width: auto;
            margin-right: 1rem;
        }
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 40px;
        	height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: 1px solid #ddd;
            border-radius: 50%;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-Aceptada { background-color: #dcfce7; color: #166534; }
        .status-Pendiente { background-color: #fef9c3; color: #854d0e; }
        .status-Rechazada { background-color: #fee2e2; color: #991b1b; }
        
        /* Dark mode overrides for status badges */
        .dark .status-Aceptada { background-color: #064e3b; color: #a7f3d0; }
        .dark .status-Pendiente { background-color: #713f12; color: #fde68a; }
        .dark .status-Rechazada { background-color: #7f1d1d; color: #fca5a5; }

        /* Estilos para los modales */
        .quick-modal-overlay {
            position: fixed;
            inset: 0;
            background-color: rgba(17, 24, 39, 0.75);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 60;
        }
        .dark .quick-modal-overlay > div {
            background-color: #374151; /* gray-700 for modal content */
            color: #e5e7eb;
        }
        
        /* Dark mode para inputs genéricos */
        .dark input:not([readonly]), .dark textarea:not([readonly]), .dark select:not(.ts-control) {
            background-color: #4b5563; /* gray-600 */
            border-color: #6b7280; /* gray-500 */
            color: #e5e7eb;
        }

        /* Dark mode para inputs de sólo lectura */
        .dark input[readonly], .dark textarea[readonly] {
            background-color: #374151 !important; /* gray-700 */
            border-color: #4b5563 !important; /* gray-600 */
            color: #d1d5db !important;
        }

        /* Estilos Tom Select (asegurar dark mode) */
        .dark .ts-control {
            background-color: #4b5563 !important; /* gray-600 */
            border-color: #6b7280 !important; /* gray-500 */
            color: #e5e7eb;
        }
        .dark .ts-control.focus {
             border-color: #6366f1; /* indigo-400 */
             box-shadow: 0 0 0 1px #6366f1;
        }
        .dark .ts-dropdown {
             background-color: #4b5563; /* gray-600 */
             border-color: #6b7280;
        }
        .dark .option {
             color: #e5e7eb;
        }
        .dark .option.active {
             background-color: #374151; /* gray-700 */
        }

        /* Reutilizamos estilos de cards/grids */
        .client-card-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
        }
        .client-card-detailed {
            padding: 1.5rem;
            background-color: #fff;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transition: background-color 0.3s, box-shadow 0.3s, transform 0.3s;
        }
        .dark .client-card-detailed {
            background-color: #374151; /* gray-700 */
            border-color: #4b5563;
        }
        .client-card-detailed.selected {
            box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.25), 0 4px 6px -4px rgba(79, 70, 229, 0.2);
            transform: translateY(-2px);
        }
        .dark .client-card-detailed.selected {
            box-shadow: 0 10px 15px -3px rgba(99, 102, 241, 0.35), 0 4px 6px -4px rgba(129, 140, 248, 0.25);
        }
        
        /* Estilos de tablas */
        .dark .divide-gray-200 > * {
            border-color: #4b5563; /* gray-600 */
        }
        .dark .bg-gray-50 {
            background-color: #4b5563; /* gray-600 */
        }
        .dark .bg-white {
            background-color: #374151; /* gray-700 */
        }
        .dark .text-gray-500 {
            color: #d1d5db; /* gray-300 */
        }
        .dark .text-gray-700 {
            color: #e5e7eb; /* gray-200 */
        }
        .dark .text-gray-800 {
            color: #f9fafb; /* gray-50 */
        }
        
        /* Estilos para la UX de importación */
        .file-upload-container {
            position: relative;
            overflow: hidden;
            display: inline-block;
            width: 100%;
        }
        .file-upload-input {
            position: absolute;
            top: 0;
            right: 0;
            margin: 0;
            padding: 0;
            font-size: 20px;
            cursor: pointer;
            opacity: 0;
            filter: alpha(opacity=0);
            height: 100%;
            width: 100%;
        }
        .btn-load-pending {
            background-color: #f59e0b;
            color: white;
            font-weight: 600;
        }

        #quote-drawer {
            transition: transform 0.3s ease;
        }

        .quote-drawer-panel {
            width: min(80vw, 880px);
            max-height: 90vh;
            border-radius: 1.5rem 0 0 1.5rem;
        }

        .quote-drawer-panel::-webkit-scrollbar {
            width: 8px;
        }

        .quote-drawer-panel::-webkit-scrollbar-thumb {
            background-color: rgba(79, 70, 229, 0.35);
            border-radius: 9999px;
        }

        .dark .quote-drawer-panel::-webkit-scrollbar-thumb {
            background-color: rgba(129, 140, 248, 0.45);
        }

        #quote-drawer.drawer-open .quote-drawer-panel {
            box-shadow: 0 25px 50px -12px rgba(79, 70, 229, 0.35);
        }

        #quote-drawer.drawer-open #toggleQuoteDrawer {
            box-shadow: 0 10px 25px -10px rgba(79, 70, 229, 0.4);
        }

        @media (max-width: 768px) {
            #quote-drawer {
                right: 1rem;
                left: auto;
                bottom: 1.5rem;
                top: auto;
            }

            .quote-drawer-panel {
                width: min(94vw, 100%);
                max-height: 70vh;
                border-radius: 1.25rem;
            }
        }

        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                /* Reset margins and padding for printing */
                margin: 0;
                padding: 0;
            }
            .no-print {
                display: none;
            }
            /* Ensure text contrast for dark mode elements on white paper */
            body {
                background-color: white !important;
                color: black !important;
            }
            #print-area * {
                color: black !important;
                background-color: white !important;
                box-shadow: none !important;
                text-shadow: none !important;
            }
            .quote-item-table th {
                border-bottom: 1px solid #ccc !important;
            }
            .quote-footer-table td {
                border: none !important;
            }
            .quote-footer-table .total-row {
                border-top: 2px solid #000 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 transition duration-300">

    <!-- Pantalla de Bloqueo -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm dark:bg-gray-700 dark:text-white">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6 dark:text-white">Acceso Protegido</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-2 dark:text-gray-300">Contraseña</label>
                    <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4" style="display: none;"></p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold">Entrar</button>
            </form>
        </div>
    </div>
    
    <!-- Modal de Confirmación para Importación (CSV/JSON) -->
    <div id="confirmation-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 flex items-center justify-center z-50 hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-lg dark:bg-gray-700 dark:text-white">
            <h3 id="modal-title" class="text-xl font-bold text-gray-800 mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Confirmar Importación</h3>
            <div id="modal-content" class="text-gray-700 space-y-3 mb-6 dark:text-gray-300"></div>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal('confirmation-modal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Cancelar</button>
                <button id="modal-confirm-btn" class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition">Confirmar e Importar</button>
            </div>
        </div>
    </div>
    
    <!-- MODALES EXISTENTES -->
    <div id="deleteQuoteConfirmationModal" class="quick-modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm dark:bg-gray-700 dark:text-white">
             <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                <h3 class="text-xl font-bold text-red-600"><i class="fas fa-exclamation-triangle mr-2"></i> Confirmar Eliminación</h3>
                <button onclick="closeModal('deleteQuoteConfirmationModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <div id="deleteQuoteModalContent" class="text-gray-700 space-y-3 mb-6 dark:text-gray-300">
                <p>¿Está seguro de que desea eliminar la cotización?</p>
                <p class="font-semibold" id="quoteToDeleteDetails"></p>
                <input type="hidden" id="quoteIdToDelete">
            </div>
            <div class="flex justify-end space-x-4">
                <button onclick="closeModal('deleteQuoteConfirmationModal')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-300 transition dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">No, Cancelar</button>
                <button onclick="deleteConfirmedQuote()" class="bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">Sí, Eliminar Permanentemente</button>
            </div>
        </div>
    </div>
    
    <div id="clientFormModal" class="quick-modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto dark:bg-gray-700 dark:text-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                <h3 id="clientModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Crear Nuevo Cliente</h3>
                <button onclick="closeModal('clientFormModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <form id="clientForm" class="space-y-4">
                <input type="hidden" id="clientId">
                <!-- Se actualizan las clases para Dark Mode -->
                <div><label for="clientCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Código Cliente (Nombre Comercial)</label><input type="text" id="clientCode" required class="mt-1 w-full p-2 bg-gray-100 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Se autogenerará de Razón Social" readonly></div>
                <div><label for="clientName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Razón Social *</label><input type="text" id="clientName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" oninput="this.value = this.value.toUpperCase(); document.getElementById('clientCode').value = generateClientCode(this.value)"></div>
                <div><label for="clientRUC" class="block text-sm font-medium text-gray-700 dark:text-gray-300">RUC / C.I. (Identificación No.) *</label><input type="text" id="clientRUC" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="clientContact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Email Principal</label><input type="email" id="clientContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="clientPhone" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Teléfono</label><input type="tel" id="clientPhone" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="clientAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dirección</label><input type="text" id="clientAddress" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="clientCity" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Ciudad</label><input type="text" id="clientCity" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <button type="submit" id="clientSubmitBtn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Cliente</button>
            </form>
        </div>
    </div>
    
    <div id="serviceFormModal" class="quick-modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto dark:bg-gray-700 dark:text-white">
             <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                <h3 id="serviceModalTitle" class="text-xl font-bold text-gray-800 dark:text-white">Crear Nuevo Servicio</h3>
                <button onclick="closeModal('serviceFormModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <form id="serviceForm" class="space-y-4">
                <input type="hidden" id="serviceId">
                <!-- Se actualizan las clases para Dark Mode -->
                <div><label for="serviceCode" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Código de Servicio *</label><input type="text" id="serviceCode" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="serviceName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre del Servicio *</label><input type="text" id="serviceName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="serviceCategory" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Categoría</label><input type="text" id="serviceCategory" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Ej: Diseño Web"></div>
                <div><label for="servicePrice" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Precio Unitario ($) *</label><input type="number" step="0.01" id="servicePrice" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                <div><label for="serviceCost" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Costo Interno ($)</label><input type="number" step="0.01" id="serviceCost" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" value="0.00"></div>
                <div><label for="serviceDescription" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Descripción</label><textarea id="serviceDescription" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></textarea></div>
                <button type="submit" id="serviceSubmitBtn" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Servicio</button>
            </form>
        </div>
    </div>

    <div id="clientImportModal" class="quick-modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto dark:bg-gray-700 dark:text-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white"><i class="fas fa-file-csv mr-2 text-indigo-600"></i> Importar Clientes CSV</h3>
                <button onclick="closeModal('clientImportModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Utilice este asistente para cargar clientes de manera masiva mediante un archivo CSV. Se recomienda descargar la plantilla para asegurar el formato correcto.</p>

            <div class="flex flex-col space-y-3">
                <button onclick="downloadCsvTemplate('clients')" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow-sm"><i class="fas fa-download mr-2"></i> Descargar Plantilla CSV</button>

                <div class="p-3 rounded-lg border text-sm transition duration-300 dark:border-gray-600" id="client-import-status-modal">
                    <p class="text-gray-600 dark:text-gray-400">Archivo seleccionado: <span class="font-semibold text-gray-800 dark:text-white" id="client-selected-file-modal">Ninguno</span>.</p>
                    <div id="client-structure-status-modal" class="mt-2 p-2 bg-yellow-100 text-yellow-800 rounded-md hidden dark:bg-yellow-900/50 dark:text-yellow-300">
                        <i class="fas fa-file-csv mr-2"></i> <span id="client-status-message-modal">Seleccione un archivo CSV para validar e importar.</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3">
                    <div class="file-upload-container">
                        <button id="importClientsBtnModal" class="w-full bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 transition shadow-sm">
                            <i class="fas fa-upload mr-2" id="client-upload-icon-modal"></i> 1. Archivo Seleccionado
                        </button>
                        <input type="file" id="importClientsCsvInputModal" accept=".csv" class="file-upload-input" onchange="handleFileChange(this, 'clients')">
                    </div>
                    <button id="loadClientsBtnModal" onclick="importCsvData('clients')" class="w-full bg-gray-400 text-white px-4 py-2 rounded-lg shadow-sm disabled:opacity-50">
                        2. Cargar Clientes
                    </button>
                </div>
            </div>

            <p class="text-xs text-gray-500 mt-4 dark:text-gray-400">La importación se realizará cuando haga clic en el botón "2. Cargar Clientes" y confirme en la ventana emergente.</p>
        </div>
    </div>

    <div id="serviceImportModal" class="quick-modal-overlay hidden">
        <div class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md max-h-[90vh] overflow-y-auto dark:bg-gray-700 dark:text-white">
            <div class="flex justify-between items-center mb-4 border-b pb-2 dark:border-gray-600">
                <h3 class="text-xl font-bold text-gray-800 dark:text-white"><i class="fas fa-file-csv mr-2 text-indigo-600"></i> Importar Servicios CSV</h3>
                <button onclick="closeModal('serviceImportModal')" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300"><i class="fas fa-times"></i></button>
            </div>
            <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Utilice el siguiente asistente para cargar servicios de manera masiva mediante un archivo CSV. Se recomienda descargar la plantilla.</p>

            <div class="flex flex-col space-y-3">
                <button onclick="downloadCsvTemplate('services')" class="w-full bg-blue-500 text-white px-4 py-2 rounded-lg hover:bg-blue-600 transition shadow-sm"><i class="fas fa-download mr-2"></i> Descargar Plantilla CSV</button>
                
                <div class="p-3 rounded-lg border text-sm transition duration-300 dark:border-gray-600" id="service-import-status-modal">
                    <p class="text-gray-600 dark:text-gray-400">Archivo seleccionado: <span class="font-semibold text-gray-800 dark:text-white" id="service-selected-file-modal">Ninguno</span>.</p>
                    <div id="service-structure-status-modal" class="mt-2 p-2 bg-yellow-100 text-yellow-800 rounded-md hidden dark:bg-yellow-900/50 dark:text-yellow-300">
                        <i class="fas fa-file-csv mr-2"></i> <span id="service-status-message-modal">Seleccione un archivo CSV para validar e importar.</span>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 gap-3">
                    <div class="file-upload-container">
                        <button id="importServicesBtnModal" class="w-full bg-amber-500 text-white px-4 py-2 rounded-lg hover:bg-amber-600 transition shadow-sm">
                            <i class="fas fa-upload mr-2" id="service-upload-icon-modal"></i> 1. Archivo Seleccionado
                        </button>
                        <input type="file" id="importServicesCsvInputModal" accept=".csv" class="file-upload-input" onchange="handleFileChange(this, 'services')">
                    </div>
                    <button id="loadServicesBtnModal" onclick="importCsvData('services')" class="w-full bg-gray-400 text-white px-4 py-2 rounded-lg shadow-sm disabled:opacity-50">
                        2. Cargar Servicios
                    </button>
                </div>
            </div>

            <p class="text-xs text-gray-500 mt-4 dark:text-gray-400">La importación se realizará cuando haga clic en el botón "2. Cargar Servicios" y confirme en la siguiente ventana.</p>
        </div>
    </div>


    <!-- Contenido Principal de la App (inicialmente oculto) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8" style="display: none;">
        <!-- CABECERA DE LA APLICACIÓN PERSONALIZADA -->
        <header class="text-center mb-8 border-b pb-4 no-print border-gray-200 dark:border-gray-600">
            <div class="flex items-center justify-center">
                <img id="headerLogo" class="header-logo object-contain" src="" alt="Logo de la empresa">
                <h1 id="headerCompanyName" class="text-4xl font-bold text-gray-900 dark:text-white"></h1>
            </div>
            <p class="text-lg text-gray-600 mt-2 dark:text-gray-300">Herramienta de Cotización y Gestión</p>
        </header>
        <!-- FIN CABECERA -->

        <!-- Pestañas de Navegación -->
        <div class="mb-6 border-b border-gray-200 no-print dark:border-gray-700">
            <nav class="flex flex-wrap -mb-px space-x-2 md:space-x-4" aria-label="Tabs">
                <button class="tab-button active text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'cotizador')"><i class="fas fa-file-invoice-dollar mr-2"></i>Cotizador</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'dashboard')"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'historial')"><i class="fas fa-history mr-2"></i>Historial</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'clientes')"><i class="fas fa-users mr-2"></i>Clientes</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'servicios')"><i class="fas fa-concierge-bell mr-2"></i>Servicios</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'configuracion')"><i class="fas fa-cog mr-2"></i>Configuración</button>
            </nav>
        </div>

        <!-- Contenido de las Pestañas -->
        <main>
            <!-- Pestaña: Cotizador -->
            <div id="cotizador" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg dark:bg-gray-700">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Crear Nueva Cotización</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <!-- Selector de Cliente con Buscador y Botón Modal -->
                            <div>
                                <label for="quoteClient" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Seleccionar Cliente</label>
                                <div class="flex space-x-2">
                                    <select id="quoteClient" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                    <button onclick="showClientModal('create')" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition duration-300 shadow-sm" title="Crear Cliente Rápido"><i class="fas fa-user-plus"></i></button>
                                </div>
                            </div>
                            
                            <div><label for="quoteRUC" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">RUC / C.I.</label><input type="text" id="quoteRUC" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white" readonly></div>
                            <div><label for="quoteNumber" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Nº Cotización (previsualización)</label><input type="text" id="quoteNumber" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white" readonly></div>
                            <div><label for="quoteDate" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Fecha de Validez</label><input type="date" id="quoteDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                        </div>
                        
                        <!-- SECCIÓN DE AÑADIR SERVICIO -->
                        <div class="flex flex-col gap-4 mb-6 p-4 border border-gray-200 rounded-lg bg-gray-50 dark:bg-gray-800 dark:border-gray-600">
                            <div class="grid grid-cols-3 md:grid-cols-5 gap-3 items-end">
                                <!-- Selector de Servicio con Buscador y Botón Modal -->
                                <div class="col-span-3 md:col-span-2">
                                    <label for="serviceSelect" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Seleccionar Servicio</label>
                                    <div class="flex space-x-2">
                                        <select id="serviceSelect" onchange="updateServiceDetailPreview()" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select>
                                        <button onclick="showServiceModal('create')" class="bg-indigo-500 text-white px-3 py-2 rounded-lg hover:bg-indigo-600 transition duration-300 shadow-sm" title="Crear Servicio Rápido"><i class="fas fa-plus"></i></button>
                                    </div>
                                </div>
                                <div>
                                    <label for="serviceCodePreview" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Código</label>
                                    <input type="text" id="serviceCodePreview" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg dark:bg-gray-600 dark:border-gray-500 dark:text-white" readonly>
                                </div>
                                <div>
                                    <label for="servicePricePreview" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Precio Base</label>
                                    <input type="number" step="0.01" id="servicePricePreview" class="w-full p-2 border border-gray-300 rounded-lg text-right focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="0.00">
                                </div>
                                <button onclick="addServiceToQuote()" class="w-full h-10 bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-sm disabled:opacity-50" id="addServiceBtn" disabled><i class="fas fa-plus mr-2"></i>Añadir</button>
                            </div>
                            
                            <!-- DESCRIPCIÓN Y DETALLE ADICIONAL -->
                            <div>
                                <label for="serviceDescriptionPreview" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Descripción Base del Producto/Servicio</label>
                                <textarea id="serviceDescriptionPreview" rows="2" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg text-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" readonly placeholder="Descripción completa del servicio cargado..."></textarea>
                            </div>
                            <div>
                                <label for="itemCustomDetail" class="block text-sm font-medium text-gray-700 mb-1 dark:text-gray-300">Ajuste de Descripción/Detalles (Opcional)</label>
                                <textarea id="itemCustomDetail" rows="2" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Ej: Incluye licencia por 1 año. Válido solo para clientes nuevos."></textarea>
                                <input type="hidden" id="editItemIndex">
                            </div>

                        </div>
                        <!-- FIN SECCIÓN DE AÑADIR SERVICIO -->

                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600"><thead class="bg-gray-50 dark:bg-gray-600"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Servicio / Descripción</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24 dark:text-gray-300">Cantidad</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">P. Unitario</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Total</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider dark:text-gray-300">Acción</th></tr></thead><tbody id="quoteItems" class="bg-white divide-y divide-gray-200 dark:bg-gray-700 dark:divide-gray-600 dark:text-gray-200"></tbody></table></div>
                        <div class="mt-6">
                            <label for="quoteNotes" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Notas Adicionales para esta Cotización</label>
                            <textarea id="quoteNotes" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="Ej: Términos y condiciones, detalles específicos del proyecto..."></textarea>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit dark:bg-gray-700">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2 dark:text-white dark:border-gray-600">Resumen</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600 dark:text-gray-300">Subtotal:</span><span id="subtotal" class="font-semibold text-gray-900 dark:text-white">$0.00</span></div>
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600 dark:text-gray-300">IVA (15%):</span><span id="iva" class="font-semibold text-gray-900 dark:text-white">$0.00</span></div>
                            <hr class="dark:border-gray-600">
                            <div class="flex justify-between items-center text-2xl font-bold"><span id="total-label" class="text-indigo-600">TOTAL:</span><span id="total" class="text-indigo-600">$0.00</span></div>
                        </div>
                        <div class="mt-8"><button onclick="generatePrintableQuote()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg text-lg font-semibold"><i class="fas fa-print mr-2"></i>Generar y Imprimir</button></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Dashboard (ACTUALIZADA con Filtro de Tiempo y Dark Mode) -->
            <div id="dashboard" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg dark:bg-gray-700">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 border-b pb-4 border-gray-200 dark:border-gray-600">
                        <h2 class="text-2xl font-bold dark:text-white">Dashboard de Ventas</h2>
                        <div class="flex space-x-3 mt-4 sm:mt-0 no-print">
                            <button onclick="setDashboardFilter('all')" id="dash-filter-all" class="px-3 py-1 text-sm rounded-lg bg-indigo-600 text-white transition duration-200">Todo</button>
                            <button onclick="setDashboardFilter('last30days')" id="dash-filter-last30days" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Últimos 30 días</button>
                            <button onclick="setDashboardFilter('last90days')" id="dash-filter-last90days" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Últimos 90 días</button>
                            <button onclick="setDashboardFilter('lastyear')" id="dash-filter-lastyear" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Último Año</button>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-green-100 p-4 rounded-lg text-center dark:bg-green-900/50"><p class="text-sm text-green-800 font-semibold dark:text-green-300">VENTAS (ACEPTADAS)</p><p id="total-sales" class="text-3xl font-bold text-green-600 dark:text-green-400">$0.00</p></div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center dark:bg-blue-900/50"><p class="text-sm text-blue-800 font-semibold dark:text-blue-300">TICKET PROMEDIO</p><p id="average-sale" class="text-3xl font-bold text-blue-600 dark:text-blue-400">$0.00</p></div>
                        <div class="bg-yellow-100 p-4 rounded-lg text-center dark:bg-yellow-900/50"><p class="text-sm text-yellow-800 font-semibold dark:text-yellow-300">PRODUCTO MÁS VENDIDO</p><p id="best-seller" class="text-xl md:text-2xl font-bold text-yellow-600 dark:text-yellow-400">-</p></div>
                        <div class="bg-indigo-100 p-4 rounded-lg text-center dark:bg-indigo-900/50"><p class="text-sm text-indigo-800 font-semibold dark:text-indigo-300">COTIZACIONES TOTALES</p><p id="total-quotes" class="text-3xl font-bold text-indigo-600 dark:text-indigo-400">0</p></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4 dark:text-white">Ventas por Mes</h3>
                        <div id="sales-chart-container" class="w-full h-80 bg-gray-50 p-4 rounded-lg dark:bg-gray-800"></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Historial (ACTUALIZADA con Buscador General) -->
            <div id="historial" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg dark:bg-gray-700">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-end lg:justify-between mb-4 border-b pb-4 border-gray-200 dark:border-gray-600">
                        <div class="flex-1">
                            <h2 class="text-2xl font-bold dark:text-white">Historial de Cotizaciones <span id="historyClientFilter" class="text-base font-normal text-indigo-500 dark:text-indigo-300"></span></h2>
                            <p class="text-sm text-gray-500 dark:text-gray-400">Consulta, filtra y depura cotizaciones registradas.</p>
                        </div>
                        <div class="w-full lg:w-auto flex flex-col sm:flex-row gap-2 items-stretch sm:items-center">
                            <div class="relative flex-1 sm:w-64">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-300"></i>
                                <input type="text" id="historySearchInput" oninput="renderQuotesHistory(historyClientFilterId, currentHistoryFilter)" placeholder="Buscar por N°, cliente o servicio..." class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            </div>
                            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 text-sm text-gray-600 rounded-lg dark:bg-gray-600 dark:text-gray-200">
                                <input type="checkbox" id="selectAllQuotes" class="accent-indigo-600" onchange="toggleSelectAll('quotes', this.checked)">
                                Seleccionar todo
                            </label>
                            <button id="bulkDeleteQuotesBtn" onclick="bulkDeleteQuotes()" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-trash"></i><span class="label">Eliminar Seleccionados</span>
                            </button>
                        </div>
                    </div>
                    <div class="flex space-x-3 mb-6 no-print">
                        <button onclick="setHistoryFilter('all')" id="filter-all" class="px-3 py-1 text-sm rounded-lg bg-indigo-600 text-white transition duration-200">Todo</button>
                        <button onclick="setHistoryFilter('last30days')" id="filter-last30days" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Últimos 30 días</button>
                        <button onclick="setHistoryFilter('last90days')" id="filter-last90days" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Últimos 90 días</button>
                        <button onclick="setHistoryFilter('lastyear')" id="filter-lastyear" class="px-3 py-1 text-sm rounded-lg bg-gray-200 text-gray-800 hover:bg-gray-300 transition duration-200 dark:bg-gray-600 dark:text-gray-200 dark:hover:bg-gray-500">Último Año</button>
                    </div>

                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-600">
                                <tr>
                                    <th class="px-4 py-3 text-center w-12">
                                        <span class="sr-only">Seleccionar</span>
                                    </th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Nº Cotización</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Cliente</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Fecha</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Total</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Estado</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="quotesHistoryList" class="bg-white divide-y divide-gray-200 dark:bg-gray-700 dark:divide-gray-600 dark:text-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Clientes -->
            <div id="clientes" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg dark:bg-gray-700">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6 border-b pb-4 border-gray-200 dark:border-gray-600">
                        <div class="w-full lg:w-2/3 flex flex-col sm:flex-row sm:items-center sm:gap-4">
                            <div>
                                <h2 class="text-2xl font-bold dark:text-white">Lista de Clientes</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Gestiona tus clientes y sus cotizaciones asociadas.</p>
                            </div>
                            <div class="relative flex-1 mt-3 sm:mt-0">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-300"></i>
                                <input id="clientSearchInput" type="text" placeholder="Buscar cliente por nombre, código o contacto..." oninput="handleClientSearch(this.value)" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            </div>
                        </div>
                        <div class="w-full lg:w-auto flex flex-wrap gap-2 justify-end items-center">
                            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 text-sm text-gray-600 rounded-lg dark:bg-gray-600 dark:text-gray-200">
                                <input type="checkbox" id="selectAllClients" class="accent-indigo-600" onchange="toggleSelectAll('clients', this.checked)">
                                Seleccionar todo
                            </label>
                            <button id="bulkDeleteClientsBtn" onclick="bulkDeleteClients()" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-trash"></i><span class="label">Eliminar Seleccionados</span>
                            </button>
                            <button onclick="changeClientView('compact')" id="clientViewCompactBtn" class="p-2 text-gray-600 hover:text-indigo-600 rounded-lg bg-gray-100 active dark:bg-gray-600 dark:text-gray-300"><i class="fas fa-th-list"></i></button>
                            <button onclick="changeClientView('detailed')" id="clientViewDetailedBtn" class="p-2 text-gray-400 hover:text-indigo-600 rounded-lg dark:hover:text-indigo-400"><i class="fas fa-grip-horizontal"></i></button>
                            <button onclick="showQuickModal('clientImportModal')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition shadow-md font-semibold"><i class="fas fa-file-csv mr-2"></i>Importar CSV</button>
                            <button onclick="showClientModal('create')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md font-semibold"><i class="fas fa-user-plus mr-2"></i>Agregar Cliente</button>
                        </div>
                    </div>

                    <div id="clientViewContent">
                        <!-- Contenido dinámico (tabla o cards) se renderiza aquí -->
                    </div>

                </div>
            </div>

            <!-- Pestaña: Servicios -->
            <div id="servicios" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg dark:bg-gray-700">
                    <div class="flex flex-col gap-4 lg:flex-row lg:items-center lg:justify-between mb-6 border-b pb-4 border-gray-200 dark:border-gray-600">
                        <div class="w-full lg:w-2/3 flex flex-col sm:flex-row sm:items-center sm:gap-4">
                            <div>
                                <h2 class="text-2xl font-bold dark:text-white">Lista de Servicios</h2>
                                <p class="text-sm text-gray-500 dark:text-gray-400">Controla tus servicios y precios actualizados.</p>
                            </div>
                            <div class="relative flex-1 mt-3 sm:mt-0">
                                <i class="fas fa-search absolute left-3 top-1/2 -translate-y-1/2 text-gray-400 dark:text-gray-300"></i>
                                <input id="serviceSearchInput" type="text" placeholder="Buscar servicio por nombre, código o categoría..." oninput="handleServiceSearch(this.value)" class="w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500 dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                            </div>
                        </div>
                        <div class="w-full lg:w-auto flex flex-wrap gap-2 justify-end items-center">
                            <label class="flex items-center gap-2 px-3 py-2 bg-gray-100 text-sm text-gray-600 rounded-lg dark:bg-gray-600 dark:text-gray-200">
                                <input type="checkbox" id="selectAllServices" class="accent-indigo-600" onchange="toggleSelectAll('services', this.checked)">
                                Seleccionar todo
                            </label>
                            <button id="bulkDeleteServicesBtn" onclick="bulkDeleteServices()" class="flex items-center gap-2 bg-red-600 text-white px-4 py-2 rounded-lg shadow-md transition disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                                <i class="fas fa-trash"></i><span class="label">Eliminar Seleccionados</span>
                            </button>
                            <button onclick="changeServiceView('compact')" id="serviceViewCompactBtn" class="p-2 text-gray-600 hover:text-indigo-600 rounded-lg bg-gray-100 active dark:bg-gray-600 dark:text-gray-300"><i class="fas fa-th-list"></i></button>
                            <button onclick="changeServiceView('detailed')" id="serviceViewDetailedBtn" class="p-2 text-gray-400 hover:text-indigo-600 rounded-lg dark:hover:text-indigo-400"><i class="fas fa-grip-horizontal"></i></button>
                            <button onclick="showQuickModal('serviceImportModal')" class="bg-yellow-600 text-white px-4 py-2 rounded-lg hover:bg-yellow-700 transition shadow-md font-semibold"><i class="fas fa-file-csv mr-2"></i>Importar CSV</button>
                            <button onclick="showServiceModal('create')" class="bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition shadow-md font-semibold"><i class="fas fa-plus mr-2"></i>Agregar Servicio</button>
                        </div>
                    </div>
                    
                    <div id="serviceViewContent">
                        <!-- Contenido dinámico (tabla o cards) se renderiza aquí -->
                    </div>
                </div>
            </div>

            <!-- Pestaña: Configuración (ACTUALIZADA con Esquema de Colores) -->
            <div id="configuracion" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto dark:bg-gray-700">
                    <h2 class="text-2xl font-bold mb-4 dark:text-white">Configuración de la Empresa y Cotización</h2>
                    <form id="configForm" class="space-y-6">
                        <div><label for="companyName" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Nombre de la Empresa</label><input type="text" id="companyName" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                        <div><label for="companyAddress" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Dirección</label><input type="text" id="companyAddress" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                        <div><label for="companyContact" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Contacto (Email/Teléfono)</label><input type="text" id="companyContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white"></div>
                        <div><label for="companyWebsite" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Sitio Web (URL)</label><input type="url" id="companyWebsite" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="https://www.suempresa.com"></div>
                        <div><label for="companyWhatsapp" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Número de WhatsApp</label><input type="tel" id="companyWhatsapp" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white" placeholder="593991234567"><p class="text-xs text-gray-500 mt-1 dark:text-gray-400">Incluir el código de país, sin el signo '+'. Ej: 593991234567</p></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="logoUpload" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Logo de la Empresa</label>
                                <input type="file" id="logoUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100" onchange="previewLogo(this, 'logoPreview')">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Vista Previa</label>
                                <img id="logoPreview" src="https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo" alt="Vista previa del logo" class="mt-2 object-contain bg-gray-50 p-2 dark:bg-gray-800" onerror="this.onerror=null;this.src='https://placehold.co/200x100/374151/eef2ff?text=Tu+Logo';">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Colores Corporativos</label>
                            <div class="flex items-center gap-4 mt-2">
                                <div>
                                    <label for="primaryColor" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Primario</label>
                                    <input type="color" id="primaryColor">
                                </div>
                                <div>
                                    <label for="accentColor" class="block text-xs font-medium text-gray-500 dark:text-gray-400">Acento</label>
                                    <input type="color" id="accentColor">
                                </div>
                            </div>
                        </div>
                        
                        <div>
                            <label for="typography" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Tipografía de la Interfaz</label>
                            <select id="typography" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                                <option value="Inter, sans-serif">Inter (Predeterminada)</option>
                                <option value="Roboto, sans-serif">Roboto</option>
                                <option value="'Open Sans', sans-serif">Open Sans</option>
                                <option value="Montserrat, sans-serif">Montserrat</option>
                            </select>
                        </div>
                        
                        <!-- NUEVO CAMPO: ESQUEMA DE COLORES -->
                        <div>
                            <label for="colorScheme" class="block text-sm font-medium text-gray-700 dark:text-gray-300">Esquema de Colores</label>
                            <select id="colorScheme" onchange="applyThemePreference(this.value)" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm dark:bg-gray-600 dark:border-gray-500 dark:text-white">
                                <option value="light">Claro</option>
                                <option value="dark">Oscuro</option>
                                <option value="system">Sistema</option>
                            </select>
                        </div>

                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Configuración</button>
                    </form>
                    
                    <div class="mt-8 pt-4 border-t border-gray-200 dark:border-gray-600">
                        <h2 class="text-2xl font-bold mb-4 dark:text-white">Gestión de Datos (Backup)</h2>
                        <p class="text-sm text-gray-600 mb-4 dark:text-gray-400">Exporta o importa todos los datos (clientes, servicios, historial) como un archivo JSON para respaldo.</p>
                        <div class="flex space-x-4">
                            <button onclick="exportData()" class="flex-1 bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 transition shadow-sm"><i class="fas fa-file-export mr-2"></i> Exportar JSON</button>
                            <div class="flex-1 relative file-upload-container">
                                <button id="importJsonBtn" class="w-full bg-gray-400 text-white px-4 py-2 rounded-lg hover:bg-gray-500 transition shadow-sm"><i class="fas fa-file-import mr-2"></i> Importar JSON</button>
                                <input type="file" id="importJsonInput" accept=".json" class="file-upload-input" onchange="importData(this)">
                            </div>
                        </div>
                    </div>

                </div>
            </div>
        </main>
    </div>

    <!-- Panel flotante para impresión de cotizaciones -->
    <div id="quote-drawer" class="fixed right-0 bottom-6 sm:top-1/2 sm:bottom-auto sm:-translate-y-1/2 z-40 flex flex-col-reverse items-end gap-3 sm:flex-row-reverse sm:items-center">
        <div id="quoteDrawerPanel" aria-hidden="true" class="quote-drawer-panel bg-white dark:bg-gray-800 shadow-2xl transform translate-x-full transition-transform duration-300 border border-indigo-100/60 dark:border-indigo-500/20 flex flex-col">
            <div class="flex items-center justify-between px-5 py-4 border-b border-gray-200 dark:border-gray-700">
                <div>
                    <p class="text-xs font-semibold uppercase tracking-[0.35em] text-indigo-600 dark:text-indigo-400">Cotizaciones</p>
                    <h3 class="text-lg font-bold text-gray-800 dark:text-gray-100">Área de impresión</h3>
                </div>
                <button id="closeQuoteDrawer" class="text-gray-400 hover:text-gray-600 dark:text-gray-500 dark:hover:text-gray-200 transition" aria-label="Cerrar área de cotizaciones">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="flex-1 overflow-y-auto bg-gray-50 dark:bg-gray-900/70">
                <div id="print-area" class="p-6 bg-white dark:bg-gray-800">
                    <div class="text-sm text-gray-500 dark:text-gray-300">
                        <p class="font-medium">Genera una cotización para visualizarla aquí.</p>
                        <p class="mt-2 text-xs text-gray-400 dark:text-gray-400 leading-relaxed">Las cotizaciones se mostrarán en este panel sin afectar el diseño principal y podrás imprimirlas cuando lo necesites.</p>
                    </div>
                </div>
            </div>
        </div>
        <button id="toggleQuoteDrawer" aria-expanded="false" aria-controls="quoteDrawerPanel" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-5 rounded-l-2xl sm:rounded-l-3xl shadow-lg focus:outline-none focus:ring-2 focus:ring-indigo-400 transition flex flex-col items-center justify-center gap-2">
            <i id="quoteDrawerToggleIcon" class="fas fa-chevron-left text-lg"></i>
            <span class="uppercase text-xs tracking-widest font-semibold">Cotización</span>
        </button>
    </div>


    <script>
        // --- LÓGICA DE MODALES (General) ---
        function showQuickModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
            if (modalId === 'confirmation-modal') {
                activeImportData = null;
                const clientLoadBtn = document.getElementById('loadClientsBtnModal');
                const serviceLoadBtnModal = document.getElementById('loadServicesBtnModal');

                if (clientLoadBtn) {
                    clientLoadBtn.disabled = !clientLoadBtn.classList.contains('bg-green-600');
                }
                if (serviceLoadBtnModal) {
                    serviceLoadBtnModal.disabled = !serviceLoadBtnModal.classList.contains('bg-green-600');
                }
            }
        }

        // --- PANEL FLOTANTE DE COTIZACIONES ---
        const quoteDrawerPanel = document.getElementById('quoteDrawerPanel');
        const quoteDrawerContainer = document.getElementById('quote-drawer');
        const toggleQuoteDrawerBtn = document.getElementById('toggleQuoteDrawer');
        const quoteDrawerToggleIcon = document.getElementById('quoteDrawerToggleIcon');
        const closeQuoteDrawerBtn = document.getElementById('closeQuoteDrawer');
        let isQuoteDrawerOpen = false;

        function openQuoteDrawer() {
            if (!quoteDrawerPanel) return;
            quoteDrawerPanel.classList.remove('translate-x-full');
            quoteDrawerPanel.classList.add('translate-x-0');
            quoteDrawerPanel.setAttribute('aria-hidden', 'false');
            if (quoteDrawerContainer) quoteDrawerContainer.classList.add('drawer-open');
            if (toggleQuoteDrawerBtn) {
                toggleQuoteDrawerBtn.setAttribute('aria-expanded', 'true');
                toggleQuoteDrawerBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
                toggleQuoteDrawerBtn.classList.add('bg-indigo-700', 'hover:bg-indigo-800');
            }
            if (quoteDrawerToggleIcon) {
                quoteDrawerToggleIcon.classList.remove('fa-chevron-left');
                quoteDrawerToggleIcon.classList.add('fa-chevron-right');
            }
            isQuoteDrawerOpen = true;
        }

        function closeQuoteDrawer() {
            if (!quoteDrawerPanel) return;
            quoteDrawerPanel.classList.add('translate-x-full');
            quoteDrawerPanel.classList.remove('translate-x-0');
            quoteDrawerPanel.setAttribute('aria-hidden', 'true');
            if (quoteDrawerContainer) quoteDrawerContainer.classList.remove('drawer-open');
            if (toggleQuoteDrawerBtn) {
                toggleQuoteDrawerBtn.setAttribute('aria-expanded', 'false');
                toggleQuoteDrawerBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
                toggleQuoteDrawerBtn.classList.remove('bg-indigo-700', 'hover:bg-indigo-800');
            }
            if (quoteDrawerToggleIcon) {
                quoteDrawerToggleIcon.classList.add('fa-chevron-left');
                quoteDrawerToggleIcon.classList.remove('fa-chevron-right');
            }
            isQuoteDrawerOpen = false;
        }

        function toggleQuoteDrawer() {
            if (isQuoteDrawerOpen) {
                closeQuoteDrawer();
            } else {
                openQuoteDrawer();
            }
        }

        if (toggleQuoteDrawerBtn) {
            toggleQuoteDrawerBtn.addEventListener('click', toggleQuoteDrawer);
        }

        if (closeQuoteDrawerBtn) {
            closeQuoteDrawerBtn.addEventListener('click', closeQuoteDrawer);
        }

        document.addEventListener('keydown', (event) => {
            if (event.key === 'Escape' && isQuoteDrawerOpen) {
                closeQuoteDrawer();
            }
        });

        // --- LÓGICA DE ACCESO ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        
        const CORRECT_PASSWORD_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918';	

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function showApp() {
            loginOverlay.style.display = 'none';
            appContainer.style.display = 'block';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const enteredPassword = passwordInput.value;
            const enteredPasswordHash = await sha256(enteredPassword);

            if (enteredPasswordHash === CORRECT_PASSWORD_HASH) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
                initializeData();
            } else {
                loginError.style.display = 'block';
                loginError.textContent = 'Contraseña incorrecta. Inténtalo de nuevo.';
                passwordInput.value = '';
            }
        });
        // --- FIN LÓGICA DE ACCESO ---

        // Constantes y Estado de la Aplicación
        const IVA_RATE = 0.15;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let services = JSON.parse(localStorage.getItem('services')) || [];
        let quotesHistory = JSON.parse(localStorage.getItem('quotesHistory')) || [];
        let quoteItemsData = [];
        let quoteCounter = parseInt(localStorage.getItem('quoteCounter')) || 1;
        let companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
            name: 'Tu Empresa S.A.',
            address: 'Tu Dirección, Guayaquil',
            contact: 'tuemail@empresa.com',
            ruc: '1234567890001',
            repName: 'Andrés Nader',
            repTitle: 'Gerente General',
            logo: 'https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo',
            primaryColor: '#1a202c',
            accentColor: '#4f46e5',
            website: '',
            whatsapp: '',
            typography: 'Inter, sans-serif',
            colorScheme: 'light' // NUEVO
        };
        
        let activeImportData = null;
        let editingItemIndex = -1;
        
        let currentClientView = 'compact';
        let currentServiceView = 'compact';
        let historyClientFilterId = null;
        let currentHistoryFilter = 'all';
        let currentDashboardFilter = 'all'; // NUEVO

        let tsQuoteClient = null;
        let tsServiceSelect = null;
        let clientSearchTerm = '';
        let serviceSearchTerm = '';
        let visibleClientIds = [];
        let visibleServiceIds = [];
        let visibleQuoteIds = [];
        const selectedClients = new Set();
        const selectedServices = new Set();
        const selectedQuotes = new Set();
        
        // --- LÓGICA DE PESTAÑAS ---
        function changeTab(event, tabName, clientFilterId = null) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));

            const targetTab = document.getElementById(tabName);
            targetTab.classList.add('active');
            
            if (event && event.currentTarget) {
                event.currentTarget.classList.add('active');
            } else {
                const targetButton = document.querySelector(`.tab-button[onclick*="'${tabName}'"]`);
                if (targetButton) targetButton.classList.add('active');
            }
            
            if (tabName === 'dashboard') setDashboardFilter(currentDashboardFilter); // Usar setDashboardFilter para renderizar
            if (tabName === 'historial') {
                historyClientFilterId = clientFilterId;
                renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
            }
            if (tabName === 'clientes') {
                renderClients();
            }
            if (tabName === 'servicios') {
                renderServices();
            }

            if (tabName !== 'cotizador') {
                resetQuoteEditMode();
            }
        }

        function handleClientSearch(value) {
            clientSearchTerm = value;
            renderClients();
        }

        function handleServiceSearch(value) {
            serviceSearchTerm = value;
            renderServices();
        }

        function updateBulkActionState(section) {
            const config = {
                clients: { buttonId: 'bulkDeleteClientsBtn', count: selectedClients.size },
                services: { buttonId: 'bulkDeleteServicesBtn', count: selectedServices.size },
                quotes: { buttonId: 'bulkDeleteQuotesBtn', count: selectedQuotes.size }
            };
            const settings = config[section];
            if (!settings) return;
            const button = document.getElementById(settings.buttonId);
            if (!button) return;
            const label = button.querySelector('.label');
            const hasSelection = settings.count > 0;
            button.disabled = !hasSelection;
            button.classList.toggle('opacity-50', !hasSelection);
            button.classList.toggle('cursor-not-allowed', !hasSelection);
            if (label) {
                const baseText = label.getAttribute('data-base') || label.textContent;
                if (!label.getAttribute('data-base')) {
                    label.setAttribute('data-base', baseText);
                }
                label.textContent = hasSelection ? `${baseText} (${settings.count})` : baseText;
            }
        }

        function syncSelectAllCheckbox(section) {
            let checkboxId;
            let visibleIds;
            let selectedSet;
            switch (section) {
                case 'clients':
                    checkboxId = 'selectAllClients';
                    visibleIds = visibleClientIds;
                    selectedSet = selectedClients;
                    break;
                case 'services':
                    checkboxId = 'selectAllServices';
                    visibleIds = visibleServiceIds;
                    selectedSet = selectedServices;
                    break;
                case 'quotes':
                    checkboxId = 'selectAllQuotes';
                    visibleIds = visibleQuoteIds;
                    selectedSet = selectedQuotes;
                    break;
                default:
                    return;
            }
            const checkbox = document.getElementById(checkboxId);
            if (!checkbox) return;
            const totalVisible = visibleIds.length;
            const selectedCount = visibleIds.filter(id => selectedSet.has(id)).length;
            checkbox.disabled = totalVisible === 0;
            checkbox.checked = totalVisible > 0 && selectedCount === totalVisible;
            checkbox.indeterminate = selectedCount > 0 && selectedCount < totalVisible;
        }

        function toggleSelectAll(section, checked) {
            let visibleIds;
            let selectedSet;
            switch (section) {
                case 'clients':
                    visibleIds = visibleClientIds;
                    selectedSet = selectedClients;
                    break;
                case 'services':
                    visibleIds = visibleServiceIds;
                    selectedSet = selectedServices;
                    break;
                case 'quotes':
                    visibleIds = visibleQuoteIds;
                    selectedSet = selectedQuotes;
                    break;
                default:
                    return;
            }
            visibleIds.forEach(id => {
                if (checked) {
                    selectedSet.add(id);
                } else {
                    selectedSet.delete(id);
                }
            });

            if (section === 'clients') {
                renderClients();
            } else if (section === 'services') {
                renderServices();
            } else if (section === 'quotes') {
                renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
            }
        }

        function toggleClientSelection(id, checked, cardElement = null) {
            if (checked) {
                selectedClients.add(id);
            } else {
                selectedClients.delete(id);
            }
            if (cardElement) {
                cardElement.classList.toggle('selected', checked);
            }
            updateBulkActionState('clients');
            syncSelectAllCheckbox('clients');
        }

        function toggleServiceSelection(id, checked, cardElement = null) {
            if (checked) {
                selectedServices.add(id);
            } else {
                selectedServices.delete(id);
            }
            if (cardElement) {
                cardElement.classList.toggle('selected', checked);
            }
            updateBulkActionState('services');
            syncSelectAllCheckbox('services');
        }

        function toggleQuoteSelection(id, checked) {
            if (checked) {
                selectedQuotes.add(id);
            } else {
                selectedQuotes.delete(id);
            }
            updateBulkActionState('quotes');
            syncSelectAllCheckbox('quotes');
        }

        function bulkDeleteClients() {
            if (selectedClients.size === 0) return;
            if (!confirm(`¿Eliminar ${selectedClients.size} cliente(s) seleccionados?`)) return;
            const toRemove = new Set(selectedClients);
            clients = clients.filter(client => !toRemove.has(client.id));
            selectedClients.clear();
            localStorage.setItem('clients', JSON.stringify(clients));
            renderClients();
            showTemporaryMessage('Clientes seleccionados eliminados correctamente.', 'success');
        }

        function bulkDeleteServices() {
            if (selectedServices.size === 0) return;
            if (!confirm(`¿Eliminar ${selectedServices.size} servicio(s) seleccionados?`)) return;
            const toRemove = new Set(selectedServices);
            services = services.filter(service => !toRemove.has(service.id));
            selectedServices.clear();
            localStorage.setItem('services', JSON.stringify(services));
            renderServices();
            showTemporaryMessage('Servicios seleccionados eliminados correctamente.', 'success');
        }

        function bulkDeleteQuotes() {
            if (selectedQuotes.size === 0) return;
            if (!confirm(`¿Eliminar ${selectedQuotes.size} cotización(es) del historial?`)) return;
            const toRemove = new Set(selectedQuotes);
            quotesHistory = quotesHistory.filter(quote => !toRemove.has(quote.id));
            selectedQuotes.clear();
            localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
            renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
            renderDashboard();
            showTemporaryMessage('Cotizaciones seleccionadas eliminadas del historial.', 'success');
        }

        // --- FUNCIÓN DE AUTOGENERACIÓN DE CÓDIGO ---
        function generateClientCode(razonSocial) {
            if (!razonSocial) return '';
            let sanitized = razonSocial.toUpperCase().replace(/[^A-Z0-9\s]/g, '');
            let parts = sanitized.split(/\s+/).filter(p => p.length > 0);
            let code = '';
            
            if (parts.length > 0) {
                if (parts.length >= 3) {
                    code = parts.slice(0, 3).map(p => p[0]).join('');
                } else if (parts.length === 2) {
                    code = parts.slice(0, 2).map(p => p[0]).join('');
                } else {
                    code = parts[0].substring(0, 4);
                }
            } else {
                code = razonSocial.substring(0, 4);
            }
            if (code.length < 3 && parts.length > 0) {
                 code = parts[0].substring(0, 3);
            }
            return code.substring(0, 10).toUpperCase();
        }

        // --- LÓGICA DE CLIENTES ---
        const clientForm = document.getElementById('clientForm');
        const clientViewContent = document.getElementById('clientViewContent');
        const clientIdInput = document.getElementById('clientId');
        const clientCodeInput = document.getElementById('clientCode');
        const clientNameInput = document.getElementById('clientName');
        const clientRUCInput = document.getElementById('clientRUC');
        const clientContactInput = document.getElementById('clientContact');
        const clientPhoneInput = document.getElementById('clientPhone');
        const clientAddressInput = document.getElementById('clientAddress');
        const clientCityInput = document.getElementById('clientCity');
        const clientModalTitle = document.getElementById('clientModalTitle');
        const clientSubmitBtn = document.getElementById('clientSubmitBtn');
        const quoteClientSelect = document.getElementById('quoteClient');

        function showClientModal(mode, id = null) {
            clientForm.reset();
            clientIdInput.value = '';
            
            if (mode === 'create') {
                clientModalTitle.textContent = 'Crear Nuevo Cliente';
                clientSubmitBtn.textContent = 'Guardar Cliente';
                clientCodeInput.classList.add('bg-gray-100', 'dark:bg-gray-600');
                clientCodeInput.classList.remove('bg-white', 'dark:bg-gray-700');
            } else if (mode === 'edit' && id) {
                const client = clients.find(c => c.id === id);
                if (!client) return;
                
                clientModalTitle.textContent = `Editar Cliente: ${client.name}`;
                clientSubmitBtn.textContent = 'Actualizar Cliente';
                
                clientIdInput.value = client.id;
                clientCodeInput.value = client.code;
                clientNameInput.value = client.name;
                clientRUCInput.value = client.ruc;
                clientContactInput.value = client.contact;
                clientPhoneInput.value = client.phone;
                clientAddressInput.value = client.address;
                clientCityInput.value = client.city;
                
                clientCodeInput.classList.remove('bg-gray-100', 'dark:bg-gray-600');
                clientCodeInput.classList.add('bg-white', 'dark:bg-gray-700');
            }
            
            showQuickModal('clientFormModal');
        }

        function changeClientView(view) {
            currentClientView = view;
            document.getElementById('clientViewCompactBtn').classList.remove('bg-gray-100', 'dark:bg-gray-600');
            document.getElementById('clientViewDetailedBtn').classList.remove('bg-gray-100', 'dark:bg-gray-600');
            document.getElementById(`clientView${view.charAt(0).toUpperCase() + view.slice(1)}Btn`).classList.add('bg-gray-100', 'dark:bg-gray-600');
            renderClients();
        }

        function renderClients() {
            clientViewContent.innerHTML = '';

            for (const id of Array.from(selectedClients)) {
                if (!clients.find(c => c.id === id)) {
                    selectedClients.delete(id);
                }
            }

            const searchValue = clientSearchTerm.trim().toLowerCase();
            let filteredClients = clients.slice();
            if (searchValue) {
                filteredClients = filteredClients.filter(client => {
                    const fields = [client.name, client.code, client.ruc, client.contact, client.phone, client.city];
                    return fields.some(value => (value || '').toString().toLowerCase().includes(searchValue));
                });
            }

            visibleClientIds = filteredClients.map(client => client.id);

            const searchInput = document.getElementById('clientSearchInput');
            if (searchInput && searchInput.value !== clientSearchTerm) {
                searchInput.value = clientSearchTerm;
            }

            updateBulkActionState('clients');
            syncSelectAllCheckbox('clients');

            if (filteredClients.length === 0) {
                const message = clients.length === 0
                    ? 'No hay clientes registrados.'
                    : 'No se encontraron clientes que coincidan con el filtro.';
                clientViewContent.innerHTML = `<p class="text-center py-8 text-gray-500 dark:text-gray-400">${message}</p>`;
                updateClientDropdowns();
                return;
            }

            if (currentClientView === 'compact') {
                clientViewContent.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-600">
                                <tr>
                                    <th class="px-4 py-3 text-center w-12"><span class="sr-only">Seleccionar</span></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Código / RUC</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Razón Social / Contacto</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Ciudad / Teléfono</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="clientList" class="bg-white divide-y divide-gray-200 dark:bg-gray-700 dark:divide-gray-600 dark:text-gray-200"></tbody>
                        </table>
                    </div>
                `;
                const clientList = document.getElementById('clientList');
                filteredClients.forEach(client => {
                    const contact = client.contact || 'Sin contacto';
                    const phone = client.phone || 'N/A';
                    const city = client.city || 'N/A';
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="h-4 w-4 accent-indigo-600" ${selectedClients.has(client.id) ? 'checked' : ''} onchange="toggleClientSelection('${client.id}', this.checked)">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-sm">${client.code}<div class="text-xs text-gray-500 dark:text-gray-400">${client.ruc}</div></td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="font-semibold">${client.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${contact}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="font-medium">${city}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${phone}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="changeTab(null, 'historial', '${client.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2" title="Ver Historial"><i class="fas fa-history"></i></button>
                            <button onclick="showClientModal('edit', '${client.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteClient('${client.id}')" class="text-red-600 hover:text-red-900" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    clientList.appendChild(row);
                });
            } else {
                const cardGrid = document.createElement('div');
                cardGrid.className = 'client-card-grid';

                filteredClients.forEach(client => {
                    const contact = client.contact || 'Sin correo electrónico';
                    const phone = client.phone || 'Sin teléfono';
                    const address = client.address || 'Sin dirección';
                    const city = client.city || 'N/D';
                    const card = document.createElement('div');
                    card.className = 'client-card-detailed border border-gray-200 hover:shadow-lg transition duration-150 relative dark:border-gray-600';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4 gap-3">
                            <div class="max-w-[70%]">
                                <span class="text-xs font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full inline-block dark:bg-indigo-900/50 dark:text-indigo-300">${client.code}</span>
                                <h3 class="text-lg md:text-xl font-bold text-gray-800 mt-2 dark:text-white">${client.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">RUC/C.I.: ${client.ruc}</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <input type="checkbox" class="h-4 w-4 accent-indigo-600 mt-1" ${selectedClients.has(client.id) ? 'checked' : ''} onchange="toggleClientSelection('${client.id}', this.checked, this.closest('.client-card-detailed'))">
                                <div class="flex flex-col space-y-1">
                                    <button onclick="changeTab(null, 'historial', '${client.id}')" class="p-2 text-indigo-600 hover:bg-indigo-50 rounded-full dark:hover:bg-gray-600" title="Ver Historial"><i class="fas fa-history"></i></button>
                                    <button onclick="showClientModal('edit', '${client.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full dark:hover:bg-gray-600" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteClient('${client.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-full dark:hover:bg-gray-600" title="Eliminar"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="space-y-2 text-sm text-gray-600 dark:text-gray-300">
                            <div class="flex items-center gap-2"><i class="fas fa-envelope text-indigo-500"></i><span>${contact}</span></div>
                            <div class="flex items-center gap-2"><i class="fas fa-phone text-indigo-500"></i><span>${phone}</span></div>
                            <div class="flex items-start gap-2"><i class="fas fa-map-marker-alt text-indigo-500 mt-1"></i><span>${address} (${city})</span></div>
                        </div>
                    `;
                    if (selectedClients.has(client.id)) {
                        card.classList.add('selected');
                    }
                    cardGrid.appendChild(card);
                });
                clientViewContent.appendChild(cardGrid);
            }

            updateClientDropdowns();
            syncSelectAllCheckbox('clients');
        }

        clientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = clientIdInput.value;
            const isEditing = !!id;
            
            const clientData = {	
                code: clientCodeInput.value.toUpperCase(),	
                name: clientNameInput.value,
                ruc: clientRUCInput.value,	
                contact: clientContactInput.value,
                phone: clientPhoneInput.value,
                address: clientAddressInput.value,
                city: clientCityInput.value
            };
            
            let newId;
            if (isEditing) {
                const index = clients.findIndex(c => c.id === id);
                clients[index] = { ...clients[index], ...clientData };
                newId = id;
            } else {
                newId = `client_${new Date().getTime()}`;
                clientData.id = newId;
                clients.push(clientData);
            }
            localStorage.setItem('clients', JSON.stringify(clients));
            
            renderClients();
            clientForm.reset();
            closeModal('clientFormModal');
            
            if (document.getElementById('cotizador').classList.contains('active') && !isEditing) {
                if(tsQuoteClient) {
                    tsQuoteClient.setValue(newId);
                }
            }
            
            showTemporaryMessage(`Cliente ${clientData.name} ${isEditing ? 'actualizado' : 'guardado'} con éxito.`, 'success');
        });

        function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            if (confirm('¿Estás seguro de que quieres eliminar este cliente? Esto también puede afectar las cotizaciones asociadas.')) {
                clients = clients.filter(c => c.id !== id);
                localStorage.setItem('clients', JSON.stringify(clients));
                selectedClients.delete(id);
                renderClients();
                showTemporaryMessage(`Cliente ${client ? client.name : ''} eliminado correctamente.`, 'success');
            }
        }
        
        // --- LÓGICA DE SERVICIOS ---
        const serviceForm = document.getElementById('serviceForm');
        const serviceViewContent = document.getElementById('serviceViewContent');
        const serviceIdInput = document.getElementById('serviceId');
        const serviceCodeInput = document.getElementById('serviceCode');	
        const serviceNameInput = document.getElementById('serviceName');
        const serviceDescriptionInput = document.getElementById('serviceDescription');
        const servicePriceInput = document.getElementById('servicePrice');
        const serviceCategoryInput = document.getElementById('serviceCategory');
        const serviceCostInput = document.getElementById('serviceCost');
        const serviceModalTitle = document.getElementById('serviceModalTitle');
        const serviceSubmitBtn = document.getElementById('serviceSubmitBtn');
        const serviceSelect = document.getElementById('serviceSelect');
        
        function showServiceModal(mode, id = null) {
            serviceForm.reset();
            serviceIdInput.value = '';
            
            if (mode === 'create') {
                serviceModalTitle.textContent = 'Crear Nuevo Servicio';
                serviceSubmitBtn.textContent = 'Guardar Servicio';
            } else if (mode === 'edit' && id) {
                const service = services.find(s => s.id === id);
                if (!service) return;
                
                serviceModalTitle.textContent = `Editar Servicio: ${service.name}`;
                serviceSubmitBtn.textContent = 'Actualizar Servicio';
                
                serviceIdInput.value = service.id;
                serviceCodeInput.value = service.code;
                serviceNameInput.value = service.name;
                serviceDescriptionInput.value = service.description;
                servicePriceInput.value = service.price;
                serviceCategoryInput.value = service.category;
                serviceCostInput.value = service.cost;
            }
            
            showQuickModal('serviceFormModal');
        }

        function changeServiceView(view) {
            currentServiceView = view;
            document.getElementById('serviceViewCompactBtn').classList.remove('bg-gray-100', 'dark:bg-gray-600');
            document.getElementById('serviceViewDetailedBtn').classList.remove('bg-gray-100', 'dark:bg-gray-600');
            document.getElementById(`serviceView${view.charAt(0).toUpperCase() + view.slice(1)}Btn`).classList.add('bg-gray-100', 'dark:bg-gray-600');
            renderServices();
        }

        function renderServices() {
            serviceViewContent.innerHTML = '';

            for (const id of Array.from(selectedServices)) {
                if (!services.find(s => s.id === id)) {
                    selectedServices.delete(id);
                }
            }

            const searchValue = serviceSearchTerm.trim().toLowerCase();
            let filteredServices = services.slice();
            if (searchValue) {
                filteredServices = filteredServices.filter(service => {
                    const fields = [service.name, service.code, service.category, service.description];
                    return fields.some(value => (value || '').toString().toLowerCase().includes(searchValue));
                });
            }

            visibleServiceIds = filteredServices.map(service => service.id);

            const searchInput = document.getElementById('serviceSearchInput');
            if (searchInput && searchInput.value !== serviceSearchTerm) {
                searchInput.value = serviceSearchTerm;
            }

            updateBulkActionState('services');
            syncSelectAllCheckbox('services');

            if (filteredServices.length === 0) {
                const message = services.length === 0
                    ? 'No hay servicios registrados.'
                    : 'No se encontraron servicios que coincidan con el filtro.';
                serviceViewContent.innerHTML = `<p class="text-center py-8 text-gray-500 dark:text-gray-400">${message}</p>`;
                updateServiceDropdown();
                return;
            }

            if (currentServiceView === 'compact') {
                serviceViewContent.innerHTML = `
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-600">
                            <thead class="bg-gray-50 dark:bg-gray-600">
                                <tr>
                                    <th class="px-4 py-3 text-center w-12"><span class="sr-only">Seleccionar</span></th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Servicio / Código</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Precio / Costo</th>
                                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Categoría</th>
                                    <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase dark:text-gray-300">Acciones</th>
                                </tr>
                            </thead>
                            <tbody id="serviceList" class="bg-white divide-y divide-gray-200 dark:bg-gray-700 dark:divide-gray-600 dark:text-gray-200"></tbody>
                        </table>
                    </div>
                `;
                const serviceList = document.getElementById('serviceList');
                filteredServices.forEach(service => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="h-4 w-4 accent-indigo-600" ${selectedServices.has(service.id) ? 'checked' : ''} onchange="toggleServiceSelection('${service.id}', this.checked)">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="font-semibold">${service.name}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">${service.code}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <div class="font-semibold text-green-600 dark:text-green-400">$${parseFloat(service.price).toFixed(2)}</div>
                            <div class="text-xs text-gray-500 dark:text-gray-400">Costo: $${parseFloat(service.cost).toFixed(2)}</div>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap">${service.category || 'General'}</td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="showServiceModal('edit', '${service.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteService('${service.id}')" class="text-red-600 hover:text-red-900" title="Eliminar"><i class="fas fa-trash"></i></button>
                        </td>
                    `;
                    serviceList.appendChild(row);
                });
            } else {
                const cardGrid = document.createElement('div');
                cardGrid.className = 'client-card-grid';

                filteredServices.forEach(service => {
                    const card = document.createElement('div');
                    card.className = 'client-card-detailed border border-gray-200 hover:shadow-lg transition duration-150 relative dark:border-gray-600';
                    card.innerHTML = `
                        <div class="flex justify-between items-start mb-4 gap-3">
                            <div class="max-w-[65%]">
                                <span class="text-xs font-mono text-indigo-600 bg-indigo-50 px-2 py-0.5 rounded-full inline-block dark:bg-indigo-900/50 dark:text-indigo-300">${service.category || 'General'}</span>
                                <h3 class="text-lg md:text-xl font-bold text-gray-800 mt-2 dark:text-white">${service.name}</h3>
                                <p class="text-xs text-gray-500 dark:text-gray-400 font-mono mt-1">${service.code}</p>
                            </div>
                            <div class="flex items-start gap-2">
                                <input type="checkbox" class="h-4 w-4 accent-indigo-600 mt-1" ${selectedServices.has(service.id) ? 'checked' : ''} onchange="toggleServiceSelection('${service.id}', this.checked, this.closest('.client-card-detailed'))">
                                <div class="flex flex-col space-y-1">
                                    <button onclick="showServiceModal('edit', '${service.id}')" class="p-2 text-blue-600 hover:bg-blue-50 rounded-full dark:hover:bg-gray-600" title="Editar"><i class="fas fa-edit"></i></button>
                                    <button onclick="deleteService('${service.id}')" class="p-2 text-red-600 hover:bg-red-50 rounded-full dark:hover:bg-gray-600" title="Eliminar"><i class="fas fa-trash"></i></button>
                                </div>
                            </div>
                        </div>
                        <div class="flex flex-wrap justify-between items-center text-sm text-gray-600 dark:text-gray-300 mb-3">
                            <span class="font-semibold text-green-600 dark:text-green-400">$${parseFloat(service.price).toFixed(2)}</span>
                            <span class="text-xs text-gray-500 dark:text-gray-400">Costo interno: $${parseFloat(service.cost).toFixed(2)}</span>
                        </div>
                        <p class="text-sm text-gray-600 dark:text-gray-300 whitespace-pre-wrap border-t pt-3 mt-3 border-gray-200 dark:border-gray-600">${service.description || 'Sin descripción detallada.'}</p>
                    `;
                    if (selectedServices.has(service.id)) {
                        card.classList.add('selected');
                    }
                    cardGrid.appendChild(card);
                });
                serviceViewContent.appendChild(cardGrid);
            }

            updateServiceDropdown();
            syncSelectAllCheckbox('services');
        }

        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = serviceIdInput.value;
            const isEditing = !!id;

            const serviceData = {	
                code: serviceCodeInput.value.toUpperCase(),	
                name: serviceNameInput.value,	
                description: serviceDescriptionInput.value,	
                price: parseFloat(servicePriceInput.value),
                category: serviceCategoryInput.value,
                cost: parseFloat(serviceCostInput.value)
            };
            
            let newId;
            if (isEditing) {
                const index = services.findIndex(s => s.id === id);
                services[index] = { ...services[index], ...serviceData };
                newId = id;
            } else {
                newId = `service_${new Date().getTime()}`;
                serviceData.id = newId;
                services.push(serviceData);
            }
            localStorage.setItem('services', JSON.stringify(services));
            
            renderServices();
            serviceForm.reset();
            closeModal('serviceFormModal');
            
            if (document.getElementById('cotizador').classList.contains('active') && !isEditing) {
                if(tsServiceSelect) {
                    tsServiceSelect.setValue(newId);
                }
            }

            showTemporaryMessage(`Servicio ${serviceData.name} ${isEditing ? 'actualizado' : 'guardado'} con éxito.`, 'success');
        });

        function deleteService(id) {
            const service = services.find(s => s.id === id);
            if (confirm('¿Estás seguro de que quieres eliminar este servicio?')) {
                services = services.filter(s => s.id !== id);
                localStorage.setItem('services', JSON.stringify(services));
                selectedServices.delete(id);
                renderServices();
                showTemporaryMessage(`Servicio ${service ? service.name : ''} eliminado correctamente.`, 'success');
            }
        }
        
        // --- LÓGICA DEL COTIZADOR ---
        const quoteRUCInput = document.getElementById('quoteRUC');
        const quoteItemsBody = document.getElementById('quoteItems');
        const quoteNumberInput = document.getElementById('quoteNumber');
        const quoteNotesInput = document.getElementById('quoteNotes');
        
        const serviceCodePreview = document.getElementById('serviceCodePreview');
        const servicePricePreview = document.getElementById('servicePricePreview');
        const serviceDescriptionPreview = document.getElementById('serviceDescriptionPreview');
        const itemCustomDetail = document.getElementById('itemCustomDetail');
        const addServiceBtn = document.getElementById('addServiceBtn');
        const editItemIndexInput = document.getElementById('editItemIndex');


        function updateQuoteNumberPreview() {
            const selectedClientId = tsQuoteClient ? tsQuoteClient.getValue() : quoteClientSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            const clientCode = client ? client.code : 'CLIENTE';
            const sequential = quoteCounter.toString().padStart(4, '0');
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            quoteNumberInput.value = `${clientCode}-${dateStr}-${sequential}`;
        }

        function updateClientDropdowns() {
            if (tsQuoteClient) {
                tsQuoteClient.destroy();
                tsQuoteClient = null;
            }
            
            quoteClientSelect.innerHTML = '<option value="">Seleccione un cliente</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.id;
                option.textContent = `${client.name} (${client.code})`;
                quoteClientSelect.appendChild(option);
            });

            tsQuoteClient = new TomSelect(quoteClientSelect, {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: 'Buscar cliente por nombre o código...',
                controlClass: 'dark:bg-gray-600 dark:border-gray-500 dark:text-white',
            });
            
            tsQuoteClient.on('change', () => {
                const selectedClientId = tsQuoteClient.getValue();
                const client = clients.find(c => c.id === selectedClientId);
                quoteRUCInput.value = client ? client.ruc : '';
                updateQuoteNumberPreview();
            });
        }
        
        function updateServiceDropdown() {
            if (tsServiceSelect) {
                tsServiceSelect.destroy();
                tsServiceSelect = null;
            }

            serviceSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} (${service.code}) - $${parseFloat(service.price).toFixed(2)}`;
                serviceSelect.appendChild(option);
            });
            
            tsServiceSelect = new TomSelect(serviceSelect, {
                create: false,
                sortField: { field: "text", direction: "asc" },
                placeholder: 'Buscar servicio por nombre o código...',
                controlClass: 'dark:bg-gray-600 dark:border-gray-500 dark:text-white',
            });
            
            tsServiceSelect.on('change', updateServiceDetailPreview);

            updateServiceDetailPreview();	
        }

        function updateServiceDetailPreview() {
            const serviceId = tsServiceSelect ? tsServiceSelect.getValue() : serviceSelect.value;
            const itemCustomDetail = document.getElementById('itemCustomDetail');
            
            if (!serviceId) {
                serviceCodePreview.value = '';
                servicePricePreview.value = '';
                serviceDescriptionPreview.value = '';
                itemCustomDetail.value = '';
                addServiceBtn.disabled = true;
                return;
            }

            const service = services.find(s => s.id === serviceId);

            if (service) {
                serviceCodePreview.value = service.code || '';
                servicePricePreview.value = parseFloat(service.price).toFixed(2);	
                serviceDescriptionPreview.value = service.description || '';
                itemCustomDetail.value = '';
                addServiceBtn.disabled = false;
            } else {
                addServiceBtn.disabled = true;
            }
            
            if (editingItemIndex !== -1) {
                resetQuoteEditMode();
            }
        }
        
        function resetQuoteEditMode() {
            editingItemIndex = -1;
            editItemIndexInput.value = '';
            addServiceBtn.innerHTML = '<i class="fas fa-plus mr-2"></i>Añadir';
            addServiceBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            addServiceBtn.classList.add('bg-indigo-600', 'hover:bg-indigo-700');
            if (tsServiceSelect) {
                tsServiceSelect.enable(); 
                tsServiceSelect.clear();
            }
            updateServiceDetailPreview();
        }
        
        function loadQuoteItemForEdit(index) {
            const item = quoteItemsData[index];
            if (!item) return;

            editingItemIndex = index;
            editItemIndexInput.value = index;

            if (tsServiceSelect) {
                if (tsServiceSelect.getOption(item.id)) {
                     tsServiceSelect.setValue(item.id);
                } else {
                    tsServiceSelect.clear();
                }
                tsServiceSelect.disable(); 
            }
            
            serviceCodePreview.value = item.code || '';
            servicePricePreview.value = parseFloat(item.price).toFixed(2);
            
            let baseDesc = item.description;
            let customDetail = '';
            const detailMarker = 'DETALLE ADICIONAL: ';
            
            const detailIndex = item.description.lastIndexOf(detailMarker);
            if (detailIndex !== -1 && item.description.length > detailIndex + detailMarker.length) {
                customDetail = item.description.substring(detailIndex + detailMarker.length).trim();
                baseDesc = item.description.substring(0, detailIndex).trim().replace('\n\n', '');
            } else {
                baseDesc = item.description;
                customDetail = '';
            }
            
            serviceDescriptionPreview.value = baseDesc;
            itemCustomDetail.value = customDetail;
            
            addServiceBtn.innerHTML = '<i class="fas fa-save mr-2"></i>Actualizar Ítem';
            addServiceBtn.classList.remove('bg-indigo-600', 'hover:bg-indigo-700');
            addServiceBtn.classList.add('bg-green-600', 'hover:bg-green-700');
            addServiceBtn.disabled = false;
            
            document.getElementById('serviceSelect').scrollIntoView({ behavior: 'smooth', block: 'start' });
            showTemporaryMessage(`Editando ítem: ${item.name} (Índice ${index})`, 'info');
        }


        function addServiceToQuote() {
            const serviceId = tsServiceSelect ? tsServiceSelect.getValue() : serviceSelect.value;
            const customDetail = itemCustomDetail.value.trim();
            const adjustedPrice = parseFloat(servicePricePreview.value);
            
            if (!serviceId && editingItemIndex === -1) { showTemporaryMessage('Por favor, seleccione un servicio.', 'error'); return; }
            if (isNaN(adjustedPrice) || adjustedPrice < 0) { showTemporaryMessage('Precio unitario no válido.', 'error'); return; }

            const serviceMaster = services.find(s => s.id === serviceId);
            const baseDescription = serviceDescriptionPreview.value.trim();	
            
            let finalDescription = baseDescription || '';
            if (customDetail) {
                finalDescription = (finalDescription ? finalDescription + '\n\n' : '') + `DETALLE ADICIONAL: ${customDetail}`;
            }
            
            const newOrUpdatedItem = {	
                id: editingItemIndex !== -1 ? quoteItemsData[editingItemIndex].id : (serviceMaster ? serviceMaster.id : 'custom_edit'),
                name: editingItemIndex !== -1 ? quoteItemsData[editingItemIndex].name : (serviceMaster ? serviceMaster.name : 'Artículo Personalizado'),
                code: serviceCodePreview.value.toUpperCase() || 'CUSTOM',
                description: finalDescription,	
                price: adjustedPrice,	
                quantity: 1,	
                category: serviceMaster ? serviceMaster.category : '',
                cost: serviceMaster ? serviceMaster.cost : 0.00
            };
            
            if (editingItemIndex !== -1) {
                const originalQuantity = quoteItemsData[editingItemIndex].quantity;
                quoteItemsData[editingItemIndex] = { ...newOrUpdatedItem, quantity: originalQuantity };
                
                showTemporaryMessage(`Ítem actualizado con éxito.`, 'success');
                resetQuoteEditMode();

            } else {
                const isCustomItem = !serviceMaster;
                if (!isCustomItem) {
                    const isPriceAltered = adjustedPrice !== serviceMaster.price;	
                    const isCustomDetailUsed = customDetail.length > 0;
                    
                    const existingItemIndex = quoteItemsData.findIndex(item => item.id === serviceId);

                    const canMerge = existingItemIndex > -1 && !isPriceAltered && !isCustomDetailUsed;

                    if (canMerge) {
                        quoteItemsData[existingItemIndex].quantity++;
                    } else {
                        quoteItemsData.push(newOrUpdatedItem);
                    }
                } else {
                    quoteItemsData.push(newOrUpdatedItem);
                }
                
                itemCustomDetail.value = '';
                if(tsServiceSelect) tsServiceSelect.clear();
                updateServiceDetailPreview();
                showTemporaryMessage(`Servicio añadido a la cotización.`, 'success');
            }
            
            renderQuoteItems();
        }
        
        function renderQuoteItems() {
            quoteItemsBody.innerHTML = '';
            if (quoteItemsData.length === 0) {
                quoteItemsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500 dark:text-gray-400">Añada servicios a la cotización.</td></tr>`;
            } else {
                quoteItemsData.forEach((item, index) => {
                    const itemDisplay = `<div class="font-medium text-gray-800 dark:text-white">${item.name} (${item.code})</div><div class="text-xs text-gray-500 mt-1 whitespace-pre-wrap dark:text-gray-400">${item.description || ''}</div>`;
                    
                    const row = document.createElement('tr');
                    const quantityInput = `<input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)" class="w-20 p-1 border border-gray-300 rounded-md text-center dark:bg-gray-600 dark:border-gray-500 dark:text-white">`;
                    const priceInput = `<input type="number" step="0.01" min="0" value="${item.price.toFixed(2)}" onchange="updatePrice(${index}, this.value)" class="w-24 p-1 border border-gray-300 rounded-md text-right dark:bg-gray-600 dark:border-gray-500 dark:text-white">`;
                    
                    row.innerHTML = `<td class="px-4 py-3 whitespace-normal align-top">${itemDisplay}</td><td class="px-4 py-3 align-top">${quantityInput}</td><td class="px-4 py-3 whitespace-nowrap align-top">${priceInput}</td><td class="px-4 py-3 whitespace-nowrap font-medium align-top">$${(item.price * item.quantity).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-right align-top"><button onclick="loadQuoteItemForEdit(${index})" class="text-blue-600 hover:text-blue-900 mr-2" title="Editar ítem"><i class="fas fa-pencil-alt"></i></button><button onclick="removeQuoteItem(${index})" class="text-red-600 hover:text-red-900" title="Eliminar ítem"><i class="fas fa-trash"></i></button></td>`;
                    quoteItemsBody.appendChild(row);
                });
            }
            calculateTotals();
        }

        function updateQuantity(index, quantity) {
            quoteItemsData[index].quantity = parseInt(quantity) || 1;
            renderQuoteItems();
        }

        function updatePrice(index, price) {
            const newPrice = parseFloat(price);
            if (isNaN(newPrice) || newPrice < 0) {
                quoteItemsData[index].price = 0;	
            } else {
                quoteItemsData[index].price = newPrice;
            }
            renderQuoteItems();
        }

        function removeQuoteItem(index) {
            quoteItemsData.splice(index, 1);
            
            if (editingItemIndex === index) {
                resetQuoteEditMode();
            } else if (editingItemIndex > index) {
                editingItemIndex--;
                editItemIndexInput.value = editingItemIndex;
            }
            
            renderQuoteItems();
        }

        function calculateTotals() {
            const subtotal = quoteItemsData.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const iva = parseFloat((subtotal * IVA_RATE).toFixed(2));
            const total = parseFloat((subtotal + iva).toFixed(2));
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // --- LÓGICA DE CONFIGURACIÓN (ACTUALIZADA con Theme) ---
        const configForm = document.getElementById('configForm');
        const companyNameInput = document.getElementById('companyName');
        const companyAddressInput = document.getElementById('companyAddress');
        const companyContactInput = document.getElementById('companyContact');
        const companyWebsiteInput = document.getElementById('companyWebsite');
        const companyWhatsappInput = document.getElementById('companyWhatsapp');
        const logoUploadInput = document.getElementById('logoUpload');
        const logoPreview = document.getElementById('logoPreview');
        const primaryColorInput = document.getElementById('primaryColor');
        const accentColorInput = document.getElementById('accentColor');
        const typographyInput = document.getElementById('typography');
        const colorSchemeInput = document.getElementById('colorScheme'); // NUEVO

        function applyThemePreference(theme) {
            const htmlEl = document.documentElement;
            
            htmlEl.classList.remove('light', 'dark'); // Limpiar clases
            
            if (theme === 'system') {
                if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
                    htmlEl.classList.add('dark');
                } else {
                    htmlEl.classList.remove('dark');
                }
            } else if (theme === 'dark') {
                htmlEl.classList.add('dark');
            } else {
                htmlEl.classList.remove('dark');
            }
            companySettings.colorScheme = theme;
        }

        function loadSettings() {
            companyNameInput.value = companySettings.name;
            companyAddressInput.value = companySettings.address;
            companyContactInput.value = companySettings.contact;
            companyWebsiteInput.value = companySettings.website || '';
            companyWhatsappInput.value = companySettings.whatsapp || '';
            logoPreview.src = companySettings.logo;
            primaryColorInput.value = companySettings.primaryColor;
            accentColorInput.value = companySettings.accentColor;
            typographyInput.value = companySettings.typography;
            colorSchemeInput.value = companySettings.colorScheme || 'light'; // Cargar esquema
            
            // Aplicar configuración a la interfaz
            applyThemePreference(companySettings.colorScheme || 'light'); // Aplicar tema al cargar
            document.getElementById('headerLogo').src = companySettings.logo;
            document.getElementById('headerCompanyName').textContent = companySettings.name;
            document.getElementById('total-label').style.color = companySettings.accentColor;
            document.getElementById('total').style.color = companySettings.accentColor;
            document.body.style.fontFamily = companySettings.typography;
        }
        
        logoUploadInput.onchange = function() { previewLogo(this, 'logoPreview'); };

        configForm.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newLogo = logoUploadInput.getAttribute('data-new-logo');

            companySettings.name = companyNameInput.value;
            companySettings.address = companyAddressInput.value;
            companySettings.contact = companyContactInput.value;
            companySettings.website = companyWebsiteInput.value;
            companySettings.whatsapp = companyWhatsappInput.value;
            companySettings.primaryColor = primaryColorInput.value;
            companySettings.accentColor = accentColorInput.value;
            companySettings.typography = typographyInput.value;
            companySettings.colorScheme = colorSchemeInput.value; // Guardar nuevo esquema
            
            if (newLogo) {
                companySettings.logo = newLogo;
                logoUploadInput.removeAttribute('data-new-logo');
            }

            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            loadSettings();	
            showTemporaryMessage('Configuración guardada exitosamente.', 'success');
        });

        // Event listener para el selector de tema en configuración
        colorSchemeInput.addEventListener('change', (e) => {
            applyThemePreference(e.target.value);
        });

        // --- LÓGICA DE HISTORIAL (ACTUALIZADA con Buscador) ---
        const quotesHistoryList = document.getElementById('quotesHistoryList');
        const historyClientFilterEl = document.getElementById('historyClientFilter');
        const historySearchInput = document.getElementById('historySearchInput'); // NUEVO

        function setHistoryFilter(filterType) {
            currentHistoryFilter = filterType;
            document.querySelectorAll('#historial .no-print button').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
            });
            const activeBtn = document.getElementById(`filter-${filterType}`);
            if (activeBtn) {
                 activeBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
                 activeBtn.classList.add('bg-indigo-600', 'text-white');
            }
            renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
        }

        function renderQuotesHistory(filterId = null, filterTime = 'all') {
            quotesHistoryList.innerHTML = '';

            for (const id of Array.from(selectedQuotes)) {
                if (!quotesHistory.find(q => q.id === id)) {
                    selectedQuotes.delete(id);
                }
            }

            let filteredQuotes = quotesHistory;
            historyClientFilterEl.textContent = '';

            const searchTerm = historySearchInput.value.toLowerCase().trim(); // NUEVO: Obtener término de búsqueda

            // 1. Filtrar por Cliente
            if (filterId) {
                filteredQuotes = filteredQuotes.filter(q => q.client.id === filterId);
                const client = clients.find(c => c.id === filterId);
                if (client) {
                    historyClientFilterEl.textContent = `(Filtrando por: ${client.name})`;
                }
            }

            // 2. Filtrar por Tiempo
            if (filterTime !== 'all') {
                const now = new Date();
                let cutoffDate = new Date(now);

                if (filterTime === 'last30days') {
                    cutoffDate.setDate(now.getDate() - 30);
                } else if (filterTime === 'last90days') {
                    cutoffDate.setDate(now.getDate() - 90);
                } else if (filterTime === 'lastyear') {
                    cutoffDate.setFullYear(now.getFullYear() - 1);
                }
                
                filteredQuotes = filteredQuotes.filter(quote => {
                    const parts = quote.issueDate.split('/');
                    if (parts.length === 3) {
                        const quoteDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00Z`);
                        return quoteDate >= cutoffDate;
                    }
                    return false;
                });
            }
            
            // 3. Filtrar por Búsqueda General (NUEVO)
            if (searchTerm) {
                filteredQuotes = filteredQuotes.filter(quote => {
                    const clientNameMatch = quote.client.name.toLowerCase().includes(searchTerm);
                    const quoteNumberMatch = quote.number.toLowerCase().includes(searchTerm);
                    const itemsMatch = quote.items.some(item => item.name.toLowerCase().includes(searchTerm));
                    
                    return clientNameMatch || quoteNumberMatch || itemsMatch;
                });
            }


            const orderedQuotes = [...filteredQuotes].reverse();
            visibleQuoteIds = orderedQuotes.map(quote => quote.id);

            updateBulkActionState('quotes');
            syncSelectAllCheckbox('quotes');

            if (orderedQuotes.length === 0) {
                quotesHistoryList.innerHTML = `<tr><td colspan="7" class="text-center py-4 text-gray-500 dark:text-gray-400">No hay cotizaciones en el historial ${filterId ? 'para este cliente' : ''} que coincidan con el filtro.</td></tr>`;
            } else {
                orderedQuotes.forEach(quote => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 text-center">
                            <input type="checkbox" class="h-4 w-4 accent-indigo-600" ${selectedQuotes.has(quote.id) ? 'checked' : ''} onchange="toggleQuoteSelection('${quote.id}', this.checked)">
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-xs">${quote.number}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${quote.client.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${quote.issueDate}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-semibold">$${quote.total.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <select onchange="updateQuoteStatus('${quote.id}', this.value)" class="p-1 rounded-md border-gray-300 text-xs focus:ring-indigo-500 focus:border-indigo-500 status-${quote.status} dark:bg-gray-600 dark:border-gray-500">
                                <option value="Pendiente" ${quote.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Aceptada" ${quote.status === 'Aceptada' ? 'selected' : ''}>Aceptada</option>
                                <option value="Rechazada" ${quote.status === 'Rechazada' ? 'selected' : ''}>Rechazada</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="loadQuoteForEdit('${quote.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Cargar para Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="reprintQuote('${quote.id}')" class="text-indigo-600 hover:text-indigo-900 mr-2" title="Ver / Reimprimir"><i class="fas fa-eye"></i></button>
                            <button onclick="promptDeleteQuote('${quote.id}', '${quote.number}', '${quote.client.name}')" class="text-red-600 hover:text-red-900" title="Eliminar Cotización"><i class="fas fa-trash"></i></button>
                        </td>`;
                    quotesHistoryList.appendChild(row);
                });
            }
        }
        
        function promptDeleteQuote(quoteId, quoteNumber, clientName) {
            document.getElementById('quoteIdToDelete').value = quoteId;
            document.getElementById('quoteToDeleteDetails').textContent = `Cotización N° ${quoteNumber} del cliente ${clientName}.`;
            showQuickModal('deleteQuoteConfirmationModal');
        }

        function deleteConfirmedQuote() {
            const quoteId = document.getElementById('quoteIdToDelete').value;
            quotesHistory = quotesHistory.filter(q => q.id !== quoteId);
            localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
            selectedQuotes.delete(quoteId);

            closeModal('deleteQuoteConfirmationModal');
            renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
            renderDashboard();
            showTemporaryMessage('Cotización eliminada permanentemente.', 'success');
        }

        function updateQuoteStatus(quoteId, newStatus) {
            const quoteIndex = quotesHistory.findIndex(q => q.id === quoteId);
            if (quoteIndex > -1) {
                quotesHistory[quoteIndex].status = newStatus;
                localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
                renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
                renderDashboard();
            }
        }
        
        function loadQuoteForEdit(quoteId) {
            const quote = quotesHistory.find(q => q.id === quoteId);
            if (quote) {
                quotesHistory = quotesHistory.filter(q => q.id !== quoteId);
                localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
                selectedQuotes.delete(quoteId);

                if (tsQuoteClient) { tsQuoteClient.setValue(quote.client.id); }

                quoteItemsData = quote.items.map(item => ({
                    id: item.id, name: item.name, description: item.description,
                    price: item.price, quantity: item.quantity,
                    category: item.category, cost: item.cost
                }));

                quoteNotesInput.value = quote.notes || '';
                
                renderQuoteItems();
                changeTab(null, 'cotizador');
                showTemporaryMessage(`Cotización ${quote.number} cargada para crear una nueva versión. La versión anterior fue eliminada del historial.`, 'info');
            }
        }

        // --- LÓGICA DEL DASHBOARD (ACTUALIZADA con Filtro de Tiempo) ---
        function setDashboardFilter(filterType) {
            currentDashboardFilter = filterType;
            // Actualizar botones visualmente
            document.querySelectorAll('#dashboard .no-print button').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
            });
            const activeBtn = document.getElementById(`dash-filter-${filterType}`);
            if (activeBtn) {
                 activeBtn.classList.remove('bg-gray-200', 'text-gray-800', 'hover:bg-gray-300', 'dark:bg-gray-600', 'dark:text-gray-200', 'dark:hover:bg-gray-500');
                 activeBtn.classList.add('bg-indigo-600', 'text-white');
            }
            renderDashboard();
        }


        function renderDashboard() {
            // 1. Filtrar por Tiempo
            let acceptedQuotes = quotesHistory.filter(q => q.status === 'Aceptada');
            
            if (currentDashboardFilter !== 'all') {
                const now = new Date();
                let cutoffDate = new Date(now);

                if (currentDashboardFilter === 'last30days') {
                    cutoffDate.setDate(now.getDate() - 30);
                } else if (currentDashboardFilter === 'last90days') {
                    cutoffDate.setDate(now.getDate() - 90);
                } else if (currentDashboardFilter === 'lastyear') {
                    cutoffDate.setFullYear(now.getFullYear() - 1);
                }
                
                acceptedQuotes = acceptedQuotes.filter(quote => {
                    const parts = quote.issueDate.split('/');
                    if (parts.length === 3) {
                        const quoteDate = new Date(`${parts[2]}-${parts[1]}-${parts[0]}T00:00:00Z`);
                        return quoteDate >= cutoffDate;
                    }
                    return false;
                });
            }
            
            // 2. Calcular métricas
            const totalSales = acceptedQuotes.reduce((sum, q) => sum + q.total, 0);
            const averageSale = acceptedQuotes.length > 0 ? totalSales / acceptedQuotes.length : 0;

            document.getElementById('total-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('average-sale').textContent = `$${averageSale.toFixed(2)}`;
            document.getElementById('total-quotes').textContent = quotesHistory.length;

            // Best Seller Logic
            const salesByProduct = {};
            acceptedQuotes.forEach(q => {
                q.items.forEach(item => {
                    if (!salesByProduct[item.name]) {
                        salesByProduct[item.name] = 0;
                    }
                    salesByProduct[item.name] += item.quantity;
                });
            });

            let bestSeller = '-';
            let maxQuantity = 0;
            for (const productName in salesByProduct) {
                if (salesByProduct[productName] > maxQuantity) {
                    maxQuantity = salesByProduct[productName];
                    bestSeller = productName;
                }
            }
            document.getElementById('best-seller').textContent = bestSeller;

            // Sales by month chart logic
            const salesByMonth = {};
            acceptedQuotes.forEach(q => {
                const parts = q.issueDate.split('/');
                if (parts.length === 3) {
                    const [day, month, year] = parts;
                    const monthYear = `${year}-${month}`;
                    if (!salesByMonth[monthYear]) salesByMonth[monthYear] = 0;
                    salesByMonth[monthYear] += q.total;
                }
            });

            const chartData = Object.keys(salesByMonth).map(key => ({
                month: key,
                sales: salesByMonth[key]
            })).sort((a, b) => new Date(a.month) - new Date(b.month));
            
            drawSalesChart(chartData);
        }

        function drawSalesChart(data) {
            const container = d3.select("#sales-chart-container");
            container.selectAll("*").remove();	

            if (data.length === 0) {
                container.append("div").attr("class", "flex items-center justify-center h-full text-gray-500 dark:text-gray-400").text("No hay ventas aceptadas para mostrar en el gráfico.");
                return;
            }

            const margin = {top: 20, right: 20, bottom: 70, left: 80};
            const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = container.node().getBoundingClientRect().height - margin.top - margin.bottom;

            const svg = container.append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleBand().range([0, width]).domain(data.map(d => d.month)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end").attr("fill", document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563'); // Dark/Light Axis Text
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.sales)]).range([height, 0]);
            svg.append("g").call(d3.axisLeft(y).tickFormat(d => `$${d.toLocaleString('es-EC')}`)).selectAll("text").attr("fill", document.documentElement.classList.contains('dark') ? '#d1d5db' : '#4b5563'); // Dark/Light Axis Text
            svg.selectAll("mybar").data(data).enter().append("rect").attr("x", d => x(d.month)).attr("y", d => y(d.sales)).attr("width", x.bandwidth()).attr("height", d => height - y(d.sales)).attr("fill", companySettings.accentColor);
        }
        
                function generatePrintableQuote() {
            if (quoteItemsData.length === 0 || !tsQuoteClient.getValue()) {
                showTemporaryMessage('Debe seleccionar un cliente y añadir al menos un servicio.', 'error');
                return;
            }

            const quoteData = {
                id: `quote_${new Date().getTime()}`,
                number: quoteNumberInput.value,
                issueDate: new Date().toLocaleDateString('es-EC', { day: '2-digit', month: '2-digit', year: 'numeric' }),
                validityDate: document.getElementById('quoteDate').value,
                client: clients.find(c => c.id === tsQuoteClient.getValue()),
                items: quoteItemsData.map(item => ({ ...item })),
                notes: quoteNotesInput.value,
                subtotal: parseFloat(document.getElementById('subtotal').textContent.replace('$', '')),
                iva: parseFloat(document.getElementById('iva').textContent.replace('$', '')),
                total: parseFloat(document.getElementById('total').textContent.replace('$', '')),
                status: 'Pendiente'
            };

            quotesHistory.push(quoteData);
            localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
            localStorage.setItem('quoteCounter', ++quoteCounter);

            // Resetear Cotizador
            quoteItemsData = [];
            quoteNotesInput.value = '';
            tsQuoteClient.clear(true);
            renderQuoteItems();

            // Imprimir
            const printContent = buildPrintableHtml(quoteData);
            document.getElementById('print-area').innerHTML = printContent;
            openQuoteDrawer();
            window.print();

            renderQuotesHistory(historyClientFilterId, currentHistoryFilter);
            renderDashboard();
            showTemporaryMessage(`Cotización ${quoteData.number} guardada e impresa.`, 'success');
        }

        function reprintQuote(quoteId) {
            const quoteData = quotesHistory.find(q => q.id === quoteId);
            if (!quoteData) {
                showTemporaryMessage('Error: Cotización no encontrada.', 'error');
                return;
            }
            const printContent = buildPrintableHtml(quoteData);
            document.getElementById('print-area').innerHTML = printContent;
            openQuoteDrawer();
            window.print();
            showTemporaryMessage(`Reimprimiendo Cotización ${quoteData.number}.`, 'info');
        }

        function buildPrintableHtml(quoteData) {
            const client = quoteData.client || {};
            const itemsHtml = quoteData.items.map(item => `
                <tr style="border-bottom: 1px solid #eee;">
                    <td style="padding: 8px; width: 5%; text-align: center;">${item.quantity}</td>
                    <td style="padding: 8px; width: 45%;">
                        <span style="font-weight: bold;">${item.name} (${item.code})</span><br>
                        <span style="font-size: 0.85em; white-space: pre-wrap;">${item.description || ''}</span>
                    </td>
                    <td style="padding: 8px; width: 20%; text-align: right;">$${item.price.toFixed(2)}</td>
                    <td style="padding: 8px; width: 30%; text-align: right; font-weight: bold;">$${(item.price * item.quantity).toFixed(2)}</td>
                </tr>
            `).join('');

            const logoHtml = companySettings.logo ? `<img src="${companySettings.logo}" alt="Logo" style="max-height: 80px; width: auto; object-fit: contain;">` : '';
            const validityDate = quoteData.validityDate ? new Date(quoteData.validityDate).toLocaleDateString('es-EC') : 'N/A';
            const issueDate = quoteData.issueDate || 'N/A';
            const accentColor = companySettings.accentColor || '#4f46e5';

            return `
                <div style="font-family: ${companySettings.typography || 'Inter, sans-serif'}; font-size: 10pt; line-height: 1.5; color: #333; max-width: 800px; margin: 0 auto; padding: 20px;">
                    <!-- Header Section -->
                    <table style="width: 100%; margin-bottom: 20px;">
                        <tr>
                            <td style="width: 50%; vertical-align: top;">
                                ${logoHtml}
                                <h1 style="font-size: 1.5em; margin: 5px 0 2px 0; color: ${accentColor};">${companySettings.name}</h1>
                                <p style="margin: 0; font-size: 0.9em;">${companySettings.address}</p>
                                <p style="margin: 0; font-size: 0.9em;">${companySettings.contact}</p>
                                <p style="margin: 0; font-size: 0.9em;">${companySettings.website || 'Web: N/A'}</p>
                            </td>
                            <td style="width: 50%; text-align: right; vertical-align: top;">
                                <div style="background-color: #f3f4f6; padding: 10px; border-radius: 5px; border-left: 5px solid ${accentColor};">
                                    <h2 style="font-size: 1.8em; margin: 0 0 5px 0; color: ${accentColor};">COTIZACIÓN N° ${quoteData.number}</h2>
                                    <p style="margin: 0; font-weight: bold;">Fecha de Emisión: ${issueDate}</p>
                                    <p style="margin: 0;">Válido hasta: ${validityDate}</p>
                                </div>
                            </td>
                        </tr>
                    </table>

                    <!-- Client Details -->
                    <div style="margin-bottom: 20px; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                        <p style="margin: 0; font-weight: bold; color: ${accentColor};">CLIENTE:</p>
                        <p style="margin: 0; font-size: 1.1em; font-weight: bold;">${client.name || 'Cliente Desconocido'}</p>
                        <p style="margin: 0; font-size: 0.9em;">RUC/C.I.: ${client.ruc || 'N/A'}</p>
                        <p style="margin: 0; font-size: 0.9em;">Dir.: ${client.address || 'N/A'} (${client.city || 'N/A'})</p>
                        <p style="margin: 0; font-size: 0.9em;">Contacto: ${client.contact || 'N/A'}</p>
                    </div>

                    <!-- Items Table -->
                    <table class="quote-item-table" style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                        <thead style="background-color: #f3f4f6; border-bottom: 2px solid ${accentColor};">
                            <tr>
                                <th style="padding: 8px; text-align: center; width: 5%;">Cant.</th>
                                <th style="padding: 8px; text-align: left; width: 45%;">Descripción del Servicio/Producto</th>
                                <th style="padding: 8px; text-align: right; width: 20%;">P. Unitario</th>
                                <th style="padding: 8px; text-align: right; width: 30%;">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${itemsHtml}
                        </tbody>
                    </table>

                    <!-- Totals and Notes -->
                    <div style="display: flex; justify-content: flex-end;">
                        <div style="width: 40%;">
                            <table class="quote-footer-table" style="width: 100%; border-collapse: collapse;">
                                <tr>
                                    <td style="padding: 5px 0;">Subtotal:</td>
                                    <td style="text-align: right; padding: 5px 0;">$${quoteData.subtotal.toFixed(2)}</td>
                                </tr>
                                <tr>
                                    <td style="padding: 5px 0;">IVA (15%):</td>
                                    <td style="text-align: right; padding: 5px 0;">$${quoteData.iva.toFixed(2)}</td>
                                </tr>
                                <tr class="total-row" style="font-size: 1.2em; font-weight: bold; color: ${accentColor};">
                                    <td style="padding: 10px 0; border-top: 2px solid #000;">TOTAL:</td>
                                    <td style="text-align: right; padding: 10px 0; border-top: 2px solid #000;">$${quoteData.total.toFixed(2)}</td>
                                </tr>
                            </table>
                        </div>
                    </div>

                    <!-- Notes Section -->
                    <div style="margin-top: 20px; border-top: 1px solid #ddd; padding-top: 10px;">
                        <p style="font-weight: bold; margin-bottom: 5px; color: ${accentColor};">NOTAS ADICIONALES:</p>
                        <p style="white-space: pre-wrap; font-size: 0.9em;">${quoteData.notes || 'No hay notas adicionales especificadas.'}</p>
                    </div>
                </div>
            `;
        }

        // Mapeo de cabeceras de CSV a la estructura interna de la App
        const CSV_MAPPINGS = {
            clients: {
                'identificacionno': 'ruc',
                'razonsocial': 'name',
                'nombrecomercial': 'code',
                'direccion': 'address',
                'telefono': 'phone',
                'email': 'contact',
            },
            services: {
                'code': 'code',
                'nombre': 'name', // Cambiado a 'nombre' ya que 'code' es el campo de la app
                'description': 'description',
                'price': 'price',
                'category': 'category',
                'costointerno': 'cost'
            }
        };

        function previewLogo(input, previewId) {
            const file = input.files[0];
            const previewEl = document.getElementById(previewId);
            
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    previewEl.src = event.target.result;
                    input.setAttribute('data-new-logo', event.target.result);
                };
                reader.readAsDataURL(file);
            } else {
                previewEl.src = companySettings.logo;
                input.removeAttribute('data-new-logo');
            }
        }

        function downloadFile(filename, text) {
            const element = document.createElement('a');
            element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
            element.setAttribute('download', filename);
            element.style.display = 'none';
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
        }

        function parseCSV(csvText) {
            const rows = csvText.trim().split('\n').map(row => row.trim()).filter(row => row.length > 0);
            if (rows.length === 0) return { rawHeaders: [], normalizedHeaders: [], data: [] };

            // Improved CSV parsing for quoting support
            const rawHeaders = [];
            const normalizedHeaders = [];
            let headerRow = rows[0];
            let inQuotes = false;
            let currentHeader = '';

            for (let i = 0; i < headerRow.length; i++) {
                const char = headerRow[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    const cleanHeader = currentHeader.trim().replace(/^"|"$/g, '');
                    rawHeaders.push(cleanHeader);
                    normalizedHeaders.push(cleanHeader.toLowerCase().replace(/[^a-z0-9]/g, ''));
                    currentHeader = '';
                } else {
                    currentHeader += char;
                }
            }
            if (currentHeader.length > 0 || rawHeaders.length === 0) {
                const cleanHeader = currentHeader.trim().replace(/^"|"$/g, '');
                rawHeaders.push(cleanHeader);
                normalizedHeaders.push(cleanHeader.toLowerCase().replace(/[^a-z0-9]/g, ''));
            }

            const data = [];
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                const rowData = {};
                let currentValue = '';
                inQuotes = false;
                let colIndex = 0;

                for (let j = 0; j < row.length; j++) {
                    const char = row[j];

                    if (char === '"') {
                        inQuotes = !inQuotes;
                    } else if (char === ',' && !inQuotes) {
                        const header = normalizedHeaders[colIndex];
                        rowData[header] = currentValue.trim().replace(/^"|"$/g, '');
                        currentValue = '';
                        colIndex++;
                    } else {
                        currentValue += char;
                    }
                }
                
                if (colIndex < normalizedHeaders.length) {
                    const header = normalizedHeaders[colIndex];
                    rowData[header] = currentValue.trim().replace(/^"|"$/g, '');
                }

                if (Object.keys(rowData).length > 0) {
                    data.push(rowData);
                }
            }

            return { rawHeaders, normalizedHeaders, data };
        }

        function downloadCsvTemplate(dataType) {
            const mappings = CSV_MAPPINGS[dataType];
            if (!mappings) return;

            const headers = Object.keys(mappings).map(key => {
                if (key === 'identificacionno') return 'IdentificacionNo';
                if (key === 'razonsocial') return 'RazonSocial';
                if (key === 'nombrecomercial') return 'NombreComercial';
                if (key === 'costointerno') return 'CostoInterno';
                return key.charAt(0).toUpperCase() + key.slice(1);
            }).join(',');

            const filename = `Plantilla_${dataType.charAt(0).toUpperCase() + dataType.slice(1)}.csv`;
            downloadFile(filename, headers + '\n');
            showTemporaryMessage(`Plantilla de ${dataType} descargada. Ábrela y llénala para importar.`, 'info');
        }

        function handleFileChange(input, dataType) {
            const isClient = dataType === 'clients';
            const loadBtnId = isClient ? 'loadClientsBtnModal' : 'loadServicesBtnModal';
            const fileStatusElId = isClient ? 'client-selected-file-modal' : 'service-selected-file-modal';
            const statusBoxElId = isClient ? 'client-structure-status-modal' : 'service-structure-status-modal';
            const statusMsgElId = isClient ? 'client-status-message-modal' : 'service-status-message-modal';
            const uploadIconElId = isClient ? 'client-upload-icon-modal' : 'service-upload-icon-modal';
            const importBtnId = isClient ? 'importClientsBtnModal' : 'importServicesBtnModal';
            
            const loadBtn = document.getElementById(loadBtnId);
            const fileStatusEl = document.getElementById(fileStatusElId);
            const statusBoxEl = document.getElementById(statusBoxElId);
            const statusMsgEl = document.getElementById(statusMsgElId);
            const uploadIconEl = document.getElementById(uploadIconElId);
            const importBtn = document.getElementById(importBtnId);
            const file = input.files[0];

            loadBtn.disabled = true;
            loadBtn.classList.remove('bg-green-600', 'hover:bg-green-700');
            loadBtn.classList.add('bg-gray-400');
            statusBoxEl.classList.add('hidden');
            importBtn.classList.remove('btn-load-pending');
            importBtn.classList.add('bg-amber-500', 'hover:bg-amber-600');	
            uploadIconEl.classList.remove('fa-file-alt');
            uploadIconEl.classList.add('fa-upload');
            
            if (!file) {
                fileStatusEl.textContent = 'Ninguno';
                return;
            }

            fileStatusEl.textContent = file.name;
            importBtn.classList.remove('bg-amber-500', 'hover:bg-amber-600');
            importBtn.classList.add('btn-load-pending');

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const csvContent = e.target.result;
                    const parseResult = parseCSV(csvContent);
                    const validRecords = parseResult.data.length;
                    
                    activeImportData = { type: dataType, data: parseResult.data };

                    const requiredHeaders = Object.keys(CSV_MAPPINGS[dataType]);
                    const hasAllHeaders = requiredHeaders.every(h => parseResult.normalizedHeaders.includes(h.toLowerCase().replace(/[^a-z0-9]/g, '')));
                    
                    let statusClass = 'bg-yellow-100 text-yellow-800 dark:bg-yellow-900/50 dark:text-yellow-300';
                    let statusIcon = 'fas fa-exclamation-triangle';
                    let message = `Archivo seleccionado: ${file.name}. `;
                    
                    if (!hasAllHeaders) {
                        message += `ERROR: Faltan cabeceras clave. Se requieren: ${requiredHeaders.join(', ')}. Registros encontrados: ${validRecords}.`;
                        loadBtn.disabled = true;
                        statusClass = 'bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300';
                        statusIcon = 'fas fa-times-circle';
                    } else if (validRecords === 0) {
                        message += `ADVERTENCIA: Archivo sin registros de datos válidos (solo cabeceras).`;
                        loadBtn.disabled = true;
                    } else {
                        statusIcon = 'fas fa-check-circle';
                        
                        const firstRecord = parseResult.data[0] || {};
                        const clientNameKey = CSV_MAPPINGS.clients.razonsocial.toLowerCase().replace(/[^a-z0-9]/g, '');
                        const serviceNameKey = CSV_MAPPINGS.services.nombre.toLowerCase().replace(/[^a-z0-9]/g, '');

                        if (dataType === 'clients') {
                            const name = firstRecord[clientNameKey] || 'N/A';
                            message += `Se encontraron ${validRecords} clientes. Previsualización: RUC: ${firstRecord[CSV_MAPPINGS.clients.identificacionno.toLowerCase().replace(/[^a-z0-9]/g, '')] || 'N/A'}, Nombre: ${name}`;
                        } else if (dataType === 'services') {
                            const serviceName = firstRecord[serviceNameKey] || 'N/A';
                            message += `Se encontraron ${validRecords} servicios. Previsualización: Nombre: ${serviceName}, Precio: ${firstRecord[CSV_MAPPINGS.services.price.toLowerCase().replace(/[^a-z0-9]/g, '')] || 'N/A'}`;
                        }
                        
                        loadBtn.disabled = false;
                        loadBtn.classList.remove('bg-gray-400');
                        loadBtn.classList.add('bg-green-600', 'hover:bg-green-700');
                        uploadIconEl.classList.remove('fa-upload');
                        uploadIconEl.classList.add('fa-file-alt');
                    }
                    
                    statusBoxEl.className = `mt-2 p-2 ${statusClass} rounded-md`;
                    statusMsgEl.innerHTML = `<i class="${statusIcon} mr-2"></i> ${message}`;
                    statusBoxEl.classList.remove('hidden');

                } catch (error) {
                    console.error("Error parsing CSV:", error);
                    statusBoxEl.className = `mt-2 p-2 bg-red-100 text-red-800 dark:bg-red-900/50 dark:text-red-300 rounded-md`;
                    statusMsgEl.innerHTML = `<i class="fas fa-times-circle mr-2"></i> ERROR CRÍTICO al leer el archivo. Verifique el formato de las celdas (especialmente las comillas dobles).`;
                    statusBoxEl.classList.remove('hidden');
                    loadBtn.disabled = true;
                    activeImportData = null;
                }
            };
            reader.readAsText(file);
            
            if (dataType === 'services') {
                document.getElementById('importServicesCsvInputModal').value = null;
            }
        }

        function importCsvData(dataType) {
            if (!activeImportData || activeImportData.type !== dataType) {
                showTemporaryMessage('Por favor, seleccione un archivo CSV primero y espere la validación.', 'error');
                return;
            }

            const loadBtnId = dataType === 'clients' ? 'loadClientsBtnModal' : 'loadServicesBtnModal';
            const loadBtn = document.getElementById(loadBtnId);
            loadBtn.disabled = true;

            const recordsToImport = activeImportData.data;
            const mappings = CSV_MAPPINGS[dataType];
            
            const modalTitle = document.getElementById('modal-title');
            const modalContent = document.getElementById('modal-content');
            const modalConfirmBtn = document.getElementById('modal-confirm-btn');
            
            modalTitle.textContent = `Confirmar Importación de ${dataType.charAt(0).toUpperCase() + dataType.slice(1)}`;
            modalContent.innerHTML = `
                <p>Está a punto de importar <strong>${recordsToImport.length}</strong> registros de ${dataType}.</p>
                <p class="font-semibold text-red-600 dark:text-red-300">ADVERTENCIA: La importación reemplazará los datos existentes si encuentra un código o RUC duplicado, o añadirá nuevos registros.</p>
                <div class="mt-4 p-3 bg-gray-50 border rounded-lg dark:bg-gray-600 dark:border-gray-500">
                    <p class="font-medium">Previsualización del primer registro:</p>
                    ${dataType === 'clients' ? `
                        <p class="text-xs mt-1">RUC: ${recordsToImport[0][mappings.identificacionno.toLowerCase().replace(/[^a-z0-9]/g, '')]}</p>
                        <p class="text-xs">Razón Social: ${recordsToImport[0][mappings.razonsocial.toLowerCase().replace(/[^a-z0-9]/g, '')]}</p>
                    ` : `
                        <p class="text-xs mt-1">Código: ${recordsToImport[0][mappings.code.toLowerCase().replace(/[^a-z0-9]/g, '')]}</p>
                        <p class="text-xs">Nombre: ${recordsToImport[0][mappings.nombre.toLowerCase().replace(/[^a-z0-9]/g, '')]}</p>
                        <p class="text-xs truncate max-w-full">Precio: ${recordsToImport[0][mappings.price.toLowerCase().replace(/[^a-z0-9]/g, '')]}</p>
                    `}
                </div>
            `;
            
            modalConfirmBtn.onclick = () => {
                closeModal('confirmation-modal');
                processConfirmedImport(dataType, recordsToImport, mappings);
            };

            document.getElementById('confirmation-modal').classList.remove('hidden');
        }

        function processConfirmedImport(dataType, recordsToImport, mappings) {
            let existingData = dataType === 'clients' ? clients : services;
            let importCount = 0;
            
            recordsToImport.forEach(record => {
                let newData = {};
                let isNew = true;

                for (const csvKey in mappings) {
                    const appKey = mappings[csvKey];
                    const normalizedCsvKey = csvKey.toLowerCase().replace(/[^a-z0-9]/g, '');
                    let value = record[normalizedCsvKey] || '';
                    
                    if (appKey === 'price' || appKey === 'cost') {
                        value = parseFloat(String(value).replace('$', '').replace(',', '.')) || 0.00;
                    }
                    if (appKey === 'code') {
                        value = value.toUpperCase();
                    }

                    newData[appKey] = value;
                }

                if (dataType === 'clients') {
                    const ruc = newData.ruc;
                    if (ruc) {
                        const existingIndex = existingData.findIndex(item => item.ruc === ruc);
                        if (existingIndex > -1) {
                            existingData[existingIndex] = { ...existingData[existingIndex], ...newData };
                            isNew = false;
                        }
                    }
                    if (!newData.code) {
                        newData.code = generateClientCode(newData.name);
                    }
                } else if (dataType === 'services') {
                    const code = newData.code;
                    if (code) {
                        const existingIndex = existingData.findIndex(item => item.code === code);
                        if (existingIndex > -1) {
                            existingData[existingIndex] = { ...existingData[existingIndex], ...newData };
                            isNew = false;
                        }
                    }
                }

                if (isNew) {
                    newData.id = `${dataType}_${new Date().getTime()}_${Math.random().toString(16).slice(2)}`;
                    existingData.push(newData);
                }
                importCount++;
            });

            if (dataType === 'clients') {
                clients = existingData;
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClients();
                closeModal('clientImportModal');
            } else if (dataType === 'services') {
                services = existingData;
                localStorage.setItem('services', JSON.stringify(services));
                renderServices();
                closeModal('serviceImportModal');
            }

            activeImportData = null;
            if (dataType === 'clients') {
                document.getElementById('loadClientsBtnModal').disabled = true;
                document.getElementById('client-structure-status-modal').classList.add('hidden');
                document.getElementById('client-selected-file-modal').textContent = 'Ninguno';
                document.getElementById('importClientsBtnModal').classList.remove('btn-load-pending');
                document.getElementById('importClientsBtnModal').classList.add('bg-amber-500', 'hover:bg-amber-600');
                document.getElementById('client-upload-icon-modal').classList.remove('fa-file-alt');
                document.getElementById('client-upload-icon-modal').classList.add('fa-upload');
            } else if (dataType === 'services') {
                document.getElementById('loadServicesBtnModal').disabled = true;
                document.getElementById('service-structure-status-modal').classList.add('hidden');
                document.getElementById('service-selected-file-modal').textContent = 'Ninguno';
                document.getElementById('importServicesBtnModal').classList.remove('btn-load-pending');
                document.getElementById('importServicesBtnModal').classList.add('bg-amber-500', 'hover:bg-amber-600');	
                document.getElementById('service-upload-icon-modal').classList.remove('fa-file-alt');
                document.getElementById('service-upload-icon-modal').classList.add('fa-upload');
            }


            showTemporaryMessage(`¡Importación CSV exitosa! Se procesaron ${importCount} registros de ${dataType}.`, 'success');
        }

        function exportData() {
            const dataToExport = {
                __ameizin_version: 'v1.0',
                clients: clients,
                services: services,
                quotesHistory: quotesHistory,
                quoteCounter: quoteCounter,
                companySettings: companySettings
            };
            const json = JSON.stringify(dataToExport, null, 2);
            const now = new Date().toISOString().slice(0, 10);
            downloadFile(`Ameizin_Backup_${now}.json`, json);
            showTemporaryMessage('Datos exportados a JSON para respaldo.', 'success');
        }

        function importData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    if (importedData.__ameizin_version !== 'v1.0') {
                        showTemporaryMessage('Error: El archivo JSON no es compatible con esta versión del cotizador.', 'error');
                        return;
                    }

                    clients = importedData.clients || [];
                    services = importedData.services || [];
                    quotesHistory = importedData.quotesHistory || [];
                    quoteCounter = importedData.quoteCounter || 1;
                    companySettings = { ...companySettings, ...importedData.companySettings };

                    localStorage.setItem('clients', JSON.stringify(clients));
                    localStorage.setItem('services', JSON.stringify(services));
                    localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
                    localStorage.setItem('quoteCounter', quoteCounter.toString());
                    localStorage.setItem('companySettings', JSON.stringify(companySettings));

                    selectedClients.clear();
                    selectedServices.clear();
                    selectedQuotes.clear();

                    initializeData();
                    showTemporaryMessage('Importación de datos completa y exitosa.', 'success');

                } catch (error) {
                    showTemporaryMessage('Error al procesar el archivo JSON. Asegúrese de que el formato sea correcto.', 'error');
                    console.error('JSON Import Error:', error);
                }
            };
            reader.readAsText(file);
            input.value = null;	
        }


        // --- UTILIDADES GLOBALES (Notificación) ---
        let messageTimeout;
        function showTemporaryMessage(message, type = 'info') {
            const el = document.getElementById('login-error');
            el.textContent = message;
            el.style.display = 'block';
            el.classList.remove('text-red-500', 'text-green-500', 'text-blue-500', 'bg-green-100', 'p-2', 'rounded-lg', 'dark:text-red-300', 'dark:bg-red-900/50', 'dark:text-green-300', 'dark:bg-green-900/50', 'dark:text-indigo-300', 'dark:bg-indigo-900/50');
            
            if (type === 'error') {
                el.classList.add('text-red-500', 'dark:text-red-300', 'dark:bg-red-900/50', 'p-2', 'rounded-lg');
            } else if (type === 'success') {
                el.classList.add('text-green-600', 'bg-green-100', 'p-2', 'rounded-lg', 'dark:text-green-300', 'dark:bg-green-900/50');
            } else {
                el.classList.add('text-indigo-500', 'dark:text-indigo-300', 'dark:bg-indigo-900/50', 'p-2', 'rounded-lg');
            }
            
            clearTimeout(messageTimeout);
            messageTimeout = setTimeout(() => {
                el.style.display = 'none';
                el.classList.remove('bg-green-100', 'p-2', 'rounded-lg', 'dark:bg-red-900/50', 'dark:bg-green-900/50', 'dark:bg-indigo-900/50');
            }, 5000);
        }

        // --- INICIALIZACIÓN ---
        function initializeData() {
            // Aplicar el tema primero antes de renderizar
            loadSettings(); 

            changeClientView('compact');
            changeServiceView('compact');
            
            renderClients();
            renderServices();

            renderQuoteItems();
            updateQuoteNumberPreview();
            
            setHistoryFilter(currentHistoryFilter); 
            setDashboardFilter(currentDashboardFilter); // Usar el nuevo setDashboardFilter

            document.querySelectorAll('.tab-button')[0].classList.add('active');
            document.querySelectorAll('.tab-content')[0].classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            // Detección de tema oscuro preferido para el modo "system"
            if (window.matchMedia) {
                window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', event => {
                    if (companySettings.colorScheme === 'system') {
                        applyThemePreference('system');
                    }
                });
            }

            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
                initializeData();
                setHistoryFilter('all');
                setDashboardFilter('all'); // Inicializar el filtro de dashboard
            }
            const clientLoadBtnModal = document.getElementById('loadClientsBtnModal');
            if (clientLoadBtnModal) clientLoadBtnModal.disabled = true;
            const serviceLoadBtnModal = document.getElementById('loadServicesBtnModal');
            if (serviceLoadBtnModal) serviceLoadBtnModal.disabled = true;

            document.getElementById('payment1Pct').oninput = validatePaymentSum;
            document.getElementById('payment2Pct').oninput = validatePaymentSum;
            document.getElementById('payment3Pct').oninput = validatePaymentSum;
        });

    </script>
</body>
</html>
