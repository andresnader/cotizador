<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Herramienta de Cotización v10</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        .tab-button.active {
            border-color: #4f46e5;
            color: #4f46e5;
            background-color: #eef2ff;
        }
        #logoPreview {
            max-width: 200px;
            max-height: 100px;
            border: 1px solid #ddd;
            border-radius: 0.5rem;
        }
        input[type="color"] {
        	-webkit-appearance: none;
        	border: none;
        	width: 40px;
        	height: 40px;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="color"]::-webkit-color-swatch-wrapper {
        	padding: 0;
            border-radius: 50%;
        }
        input[type="color"]::-webkit-color-swatch {
        	border: 1px solid #ddd;
            border-radius: 50%;
        }
        .status-badge {
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .status-Aceptada { background-color: #dcfce7; color: #166534; }
        .status-Pendiente { background-color: #fef9c3; color: #854d0e; }
        .status-Rechazada { background-color: #fee2e2; color: #991b1b; }
        @media print {
            body * {
                visibility: hidden;
            }
            #print-area, #print-area * {
                visibility: visible;
            }
            #print-area {
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
            }
            .no-print {
                display: none;
            }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <!-- Pantalla de Bloqueo -->
    <div id="login-overlay" class="fixed inset-0 bg-gray-900 bg-opacity-80 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-xl shadow-2xl w-full max-w-sm">
            <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Acceso Protegido</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="password-input" class="block text-sm font-medium text-gray-700 mb-2">Contraseña</label>
                    <input type="password" id="password-input" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                </div>
                <p id="login-error" class="text-red-500 text-sm text-center mb-4" style="display: none;">Contraseña incorrecta. Inténtalo de nuevo.</p>
                <button type="submit" class="w-full bg-indigo-600 text-white py-3 rounded-lg hover:bg-indigo-700 transition duration-300 font-semibold">Entrar</button>
            </form>
        </div>
    </div>

    <!-- Contenido Principal de la App (inicialmente oculto) -->
    <div id="app-container" class="container mx-auto p-4 md:p-8" style="display: none;">
        <header class="text-center mb-8">
            <h1 class="text-4xl font-bold text-gray-900">Herramienta de Cotización y Gestión</h1>
            <p class="text-lg text-gray-600 mt-2">Gestiona tus clientes, ventas y contratos de forma eficiente.</p>
        </header>

        <!-- Pestañas de Navegación -->
        <div class="mb-6 border-b border-gray-200 no-print">
            <nav class="flex flex-wrap -mb-px space-x-2 md:space-x-4" aria-label="Tabs">
                <button class="tab-button active text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'cotizador')"><i class="fas fa-file-invoice-dollar mr-2"></i>Cotizador</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'dashboard')"><i class="fas fa-chart-line mr-2"></i>Dashboard</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'historial')"><i class="fas fa-history mr-2"></i>Historial</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'contratos')"><i class="fas fa-file-signature mr-2"></i>Contratos</button>
                 <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'portal')"><i class="fas fa-user-check mr-2"></i>Portal Cliente</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'clientes')"><i class="fas fa-users mr-2"></i>Clientes</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'servicios')"><i class="fas fa-concierge-bell mr-2"></i>Servicios</button>
                <button class="tab-button text-sm md:text-base py-2 px-3 md:px-4 rounded-t-lg border-b-2" onclick="changeTab(event, 'configuracion')"><i class="fas fa-cog mr-2"></i>Configuración</button>
            </nav>
        </div>

        <!-- Contenido de las Pestañas -->
        <main>
            <!-- Pestaña: Cotizador -->
            <div id="cotizador" class="tab-content active">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Crear Nueva Cotización</h2>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                            <div><label for="quoteClient" class="block text-sm font-medium text-gray-700 mb-1">Seleccionar Cliente</label><select id="quoteClient" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <div><label for="quoteRUC" class="block text-sm font-medium text-gray-700 mb-1">RUC / C.I.</label><input type="text" id="quoteRUC" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                            <div><label for="quoteNumber" class="block text-sm font-medium text-gray-700 mb-1">Nº Cotización (previsualización)</label><input type="text" id="quoteNumber" class="w-full p-2 bg-gray-100 border border-gray-300 rounded-lg" readonly></div>
                            <div><label for="quoteDate" class="block text-sm font-medium text-gray-700 mb-1">Fecha de Validez</label><input type="date" id="quoteDate" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></div>
                        </div>
                        <div class="flex flex-col md:flex-row md:items-end gap-4 mb-6">
                            <div class="flex-grow"><label for="serviceSelect" class="block text-sm font-medium text-gray-700 mb-1">Añadir Servicio</label><select id="serviceSelect" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500"></select></div>
                            <button onclick="addServiceToQuote()" class="w-full md:w-auto bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition duration-300 shadow-sm"><i class="fas fa-plus mr-2"></i>Añadir</button>
                        </div>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Servicio / Descripción</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-24">Cantidad</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">P. Unitario</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Total</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Acción</th></tr></thead><tbody id="quoteItems" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                        <div class="mt-6">
                            <label for="quoteNotes" class="block text-sm font-medium text-gray-700">Notas Adicionales para esta Cotización</label>
                            <textarea id="quoteNotes" rows="3" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-indigo-500 focus:border-indigo-500" placeholder="Ej: Términos y condiciones, detalles específicos del proyecto..."></textarea>
                        </div>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-lg h-fit">
                        <h2 class="text-2xl font-bold mb-4 border-b pb-2">Resumen</h2>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600">Subtotal:</span><span id="subtotal" class="font-semibold text-gray-900">$0.00</span></div>
                            <div class="flex justify-between items-center text-lg"><span class="font-medium text-gray-600">IVA (15%):</span><span id="iva" class="font-semibold text-gray-900">$0.00</span></div>
                            <hr>
                            <div class="flex justify-between items-center text-2xl font-bold"><span id="total-label" class="text-indigo-600">TOTAL:</span><span id="total" class="text-indigo-600">$0.00</span></div>
                        </div>
                        <div class="mt-8"><button onclick="generatePrintableQuote()" class="w-full bg-green-600 text-white px-4 py-3 rounded-lg hover:bg-green-700 transition duration-300 shadow-lg text-lg font-semibold"><i class="fas fa-print mr-2"></i>Generar y Imprimir</button></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Dashboard -->
            <div id="dashboard" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-6">Dashboard de Ventas</h2>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                        <div class="bg-green-100 p-4 rounded-lg text-center"><p class="text-sm text-green-800 font-semibold">VENTAS (ACEPTADAS)</p><p id="total-sales" class="text-3xl font-bold text-green-600">$0.00</p></div>
                        <div class="bg-blue-100 p-4 rounded-lg text-center"><p class="text-sm text-blue-800 font-semibold">TICKET PROMEDIO</p><p id="average-sale" class="text-3xl font-bold text-blue-600">$0.00</p></div>
                        <div class="bg-yellow-100 p-4 rounded-lg text-center"><p class="text-sm text-yellow-800 font-semibold">PRODUCTO MÁS VENDIDO</p><p id="best-seller" class="text-xl md:text-2xl font-bold text-yellow-600">-</p></div>
                        <div class="bg-indigo-100 p-4 rounded-lg text-center"><p class="text-sm text-indigo-800 font-semibold">COTIZACIONES TOTALES</p><p id="total-quotes" class="text-3xl font-bold text-indigo-600">0</p></div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold mb-4">Ventas por Mes</h3>
                        <div id="sales-chart-container" class="w-full h-80 bg-gray-50 p-4 rounded-lg"></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Historial -->
            <div id="historial" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Historial de Cotizaciones</h2>
                    <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nº Cotización</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Cliente</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Total</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="quotesHistoryList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                </div>
            </div>

            <!-- Pestaña: Contratos -->
            <div id="contratos" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Gestión de Contratos</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div class="md:col-span-1">
                            <label for="contract-client-select" class="block text-sm font-medium text-gray-700 mb-1">1. Seleccione un Cliente</label>
                            <select id="contract-client-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                            <label for="contract-quote-select" class="block text-sm font-medium text-gray-700 mt-4 mb-1">2. Seleccione Cotización Aceptada</label>
                            <select id="contract-quote-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                        </div>
                        <div class="md:col-span-2">
                             <label for="contract-text" class="block text-sm font-medium text-gray-700 mb-1">3. Redacte o pegue el contrato</label>
                             <textarea id="contract-text" rows="10" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Contenido del contrato..."></textarea>
                             <button id="save-contract-btn" class="mt-4 w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition" disabled>Guardar Contrato</button>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Pestaña: Portal Cliente -->
            <div id="portal" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4">Vista Portal Cliente</h2>
                    <div class="max-w-md mb-6">
                        <label for="portal-client-select" class="block text-sm font-medium text-gray-700 mb-1">Seleccione un cliente para ver su portal</label>
                        <select id="portal-client-select" class="w-full p-2 border border-gray-300 rounded-lg shadow-sm"></select>
                    </div>
                    <div id="client-portal-content" class="mt-4 border-t pt-4">
                        <p class="text-gray-500">Seleccione un cliente para empezar.</p>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Clientes -->
            <div id="clientes" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Añadir Cliente</h2>
                        <form id="clientForm" class="space-y-4"><input type="hidden" id="clientId">
                            <div><label for="clientCode" class="block text-sm font-medium text-gray-700">Código de Cliente</label><input type="text" id="clientCode" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="Ej: INDUMASTER"></div>
                            <div><label for="clientName" class="block text-sm font-medium text-gray-700">Nombre del Cliente</label><input type="text" id="clientName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <div><label for="clientRUC" class="block text-sm font-medium text-gray-700">RUC / C.I.</label><input type="text" id="clientRUC" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <div><label for="clientContact" class="block text-sm font-medium text-gray-700">Contacto (Email/Teléfono)</label><input type="text" id="clientContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                            <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Cliente</button>
                        </form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Lista de Clientes</h2>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Código</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Nombre</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">RUC / C.I.</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Contacto</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="clientList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Servicios -->
            <div id="servicios" class="tab-content">
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div class="lg:col-span-1 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Añadir Servicio</h2>
                        <form id="serviceForm" class="space-y-4"><input type="hidden" id="serviceId"><div><label for="serviceName" class="block text-sm font-medium text-gray-700">Nombre del Servicio</label><input type="text" id="serviceName" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div><div><label for="serviceDescription" class="block text-sm font-medium text-gray-700">Descripción</label><textarea id="serviceDescription" rows="4" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></textarea></div><div><label for="servicePrice" class="block text-sm font-medium text-gray-700">Precio Unitario ($)</label><input type="number" step="0.01" id="servicePrice" required class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div><button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Servicio</button></form>
                    </div>
                    <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold mb-4">Lista de Servicios</h2>
                        <div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Servicio</th><th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Precio</th><th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Acciones</th></tr></thead><tbody id="serviceList" class="bg-white divide-y divide-gray-200"></tbody></table></div>
                    </div>
                </div>
            </div>

            <!-- Pestaña: Configuración -->
            <div id="configuracion" class="tab-content">
                <div class="bg-white p-6 rounded-xl shadow-lg max-w-2xl mx-auto">
                    <h2 class="text-2xl font-bold mb-4">Configuración de la Empresa y Cotización</h2>
                    <form id="configForm" class="space-y-6">
                        <div><label for="companyName" class="block text-sm font-medium text-gray-700">Nombre de la Empresa</label><input type="text" id="companyName" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyAddress" class="block text-sm font-medium text-gray-700">Dirección</label><input type="text" id="companyAddress" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyContact" class="block text-sm font-medium text-gray-700">Contacto (Email/Teléfono)</label><input type="text" id="companyContact" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm"></div>
                        <div><label for="companyWebsite" class="block text-sm font-medium text-gray-700">Sitio Web (URL)</label><input type="url" id="companyWebsite" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="https://www.suempresa.com"></div>
                        <div><label for="companyWhatsapp" class="block text-sm font-medium text-gray-700">Número de WhatsApp</label><input type="tel" id="companyWhatsapp" class="mt-1 w-full p-2 border border-gray-300 rounded-lg shadow-sm" placeholder="593991234567"><p class="text-xs text-gray-500 mt-1">Incluir el código de país, sin el signo '+'. Ej: 593991234567</p></div>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="logoUpload" class="block text-sm font-medium text-gray-700">Logo de la Empresa</label>
                                <input type="file" id="logoUpload" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700">Vista Previa</label>
                                <img id="logoPreview" src="https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo" alt="Vista previa del logo" class="mt-2 object-contain bg-gray-50 p-2">
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Colores Corporativos</label>
                            <div class="flex items-center gap-4 mt-2">
                                <div>
                                    <label for="primaryColor" class="block text-xs font-medium text-gray-500">Primario</label>
                                    <input type="color" id="primaryColor">
                                </div>
                                <div>
                                    <label for="accentColor" class="block text-xs font-medium text-gray-500">Acento</label>
                                    <input type="color" id="accentColor">
                                </div>
                            </div>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white px-4 py-2 rounded-lg hover:bg-indigo-700 transition">Guardar Configuración</button>
                    </form>
                </div>
            </div>
        </main>
    </div>

    <!-- Área de Impresión (oculta por defecto) -->
    <div id="print-area" class="p-10 bg-white"></div>


    <script>
        // --- LÓGICA DE ACCESO ---
        const loginOverlay = document.getElementById('login-overlay');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginError = document.getElementById('login-error');
        
        const CORRECT_PASSWORD_HASH = '8c6976e5b5410415bde908bd4dee15dfb167a9c873fc4bb8a81f6f2ab448a918'; 

        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
            return hashHex;
        }

        function showApp() {
            loginOverlay.style.display = 'none';
            appContainer.style.display = 'block';
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const enteredPassword = passwordInput.value;
            const enteredPasswordHash = await sha256(enteredPassword);

            if (enteredPasswordHash === CORRECT_PASSWORD_HASH) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
                initializeData();
            } else {
                loginError.style.display = 'block';
                passwordInput.value = '';
            }
        });
        // --- FIN LÓGICA DE ACCESO ---

        // Constantes y Estado de la Aplicación
        const IVA_RATE = 0.15;
        let clients = JSON.parse(localStorage.getItem('clients')) || [];
        let services = JSON.parse(localStorage.getItem('services')) || [];
        let quotesHistory = JSON.parse(localStorage.getItem('quotesHistory')) || [];
        let contracts = JSON.parse(localStorage.getItem('contracts')) || [];
        let quoteItemsData = [];
        let quoteCounter = parseInt(localStorage.getItem('quoteCounter')) || 1;
        let companySettings = JSON.parse(localStorage.getItem('companySettings')) || {
            name: 'Tu Empresa S.A.',
            address: 'Tu Dirección, Guayaquil',
            contact: 'tuemail@empresa.com',
            logo: 'https://placehold.co/200x100/eef2ff/4f46e5?text=Tu+Logo',
            primaryColor: '#1a202c',
            accentColor: '#4f46e5',
            website: '',
            whatsapp: ''
        };

        // --- LÓGICA DE PESTAÑAS ---
        function changeTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');
            if (tabName === 'dashboard') renderDashboard();
            if (tabName === 'contratos') renderContractsPage();
            if (tabName === 'portal') renderClientPortalPage();
        }
        
        // --- LÓGICA DE CLIENTES ---
        const clientForm = document.getElementById('clientForm');
        const clientList = document.getElementById('clientList');
        const clientIdInput = document.getElementById('clientId');
        const clientCodeInput = document.getElementById('clientCode');
        const clientNameInput = document.getElementById('clientName');
        const clientRUCInput = document.getElementById('clientRUC');
        const clientContactInput = document.getElementById('clientContact');

        function renderClients() {
            clientList.innerHTML = '';
            if (clients.length === 0) {
                clientList.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">No hay clientes registrados.</td></tr>`;
            } else {
                clients.forEach(client => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-4 py-3 whitespace-nowrap font-mono text-sm">${client.code}</td><td class="px-4 py-3 whitespace-nowrap">${client.name}</td><td class="px-4 py-3 whitespace-nowrap">${client.ruc}</td><td class="px-4 py-3 whitespace-nowrap">${client.contact}</td><td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium"><button onclick="editClient('${client.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteClient('${client.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button></td>`;
                    clientList.appendChild(row);
                });
            }
            updateClientDropdowns();
        }

        clientForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = clientIdInput.value;
            const clientData = { 
                code: clientCodeInput.value.toUpperCase(), 
                name: clientNameInput.value, 
                ruc: clientRUCInput.value, 
                contact: clientContactInput.value 
            };
            if (id) {
                const index = clients.findIndex(c => c.id === id);
                clients[index] = { ...clients[index], ...clientData };
            } else {
                clientData.id = `client_${new Date().getTime()}`;
                clients.push(clientData);
            }
            localStorage.setItem('clients', JSON.stringify(clients));
            renderClients();
            clientForm.reset();
            clientIdInput.value = '';
        });

        function editClient(id) {
            const client = clients.find(c => c.id === id);
            clientIdInput.value = client.id;
            clientCodeInput.value = client.code;
            clientNameInput.value = client.name;
            clientRUCInput.value = client.ruc;
            clientContactInput.value = client.contact;
            changeTab({currentTarget: document.querySelector('.tab-button[onclick*="clientes"]')}, 'clientes');
            document.getElementById('clientCode').focus();
        }

        function deleteClient(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este cliente?')) {
                clients = clients.filter(c => c.id !== id);
                localStorage.setItem('clients', JSON.stringify(clients));
                renderClients();
            }
        }

        // --- LÓGICA DE SERVICIOS ---
        const serviceForm = document.getElementById('serviceForm');
        const serviceList = document.getElementById('serviceList');
        const serviceIdInput = document.getElementById('serviceId');
        const serviceNameInput = document.getElementById('serviceName');
        const serviceDescriptionInput = document.getElementById('serviceDescription');
        const servicePriceInput = document.getElementById('servicePrice');

        function renderServices() {
            serviceList.innerHTML = '';
             if (services.length === 0) {
                serviceList.innerHTML = `<tr><td colspan="3" class="text-center py-4 text-gray-500">No hay servicios registrados.</td></tr>`;
            } else {
                services.forEach(service => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-4 py-3 whitespace-nowrap">${service.name}</td><td class="px-4 py-3 whitespace-nowrap">$${parseFloat(service.price).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium"><button onclick="editService('${service.id}')" class="text-indigo-600 hover:text-indigo-900 mr-3"><i class="fas fa-edit"></i></button><button onclick="deleteService('${service.id}')" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button></td>`;
                    serviceList.appendChild(row);
                });
            }
            updateServiceDropdown();
        }

        serviceForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const id = serviceIdInput.value;
            const serviceData = { name: serviceNameInput.value, description: serviceDescriptionInput.value, price: parseFloat(servicePriceInput.value) };
            if (id) {
                const index = services.findIndex(s => s.id === id);
                services[index] = { ...services[index], ...serviceData };
            } else {
                serviceData.id = `service_${new Date().getTime()}`;
                services.push(serviceData);
            }
            localStorage.setItem('services', JSON.stringify(services));
            renderServices();
            serviceForm.reset();
            serviceIdInput.value = '';
        });

        function editService(id) {
            const service = services.find(s => s.id === id);
            serviceIdInput.value = service.id;
            serviceNameInput.value = service.name;
            serviceDescriptionInput.value = service.description;
            servicePriceInput.value = service.price;
            changeTab({currentTarget: document.querySelector('.tab-button[onclick*="servicios"]')}, 'servicios');
            document.getElementById('serviceName').focus();
        }

        function deleteService(id) {
            if (confirm('¿Estás seguro de que quieres eliminar este servicio?')) {
                services = services.filter(s => s.id !== id);
                localStorage.setItem('services', JSON.stringify(services));
                renderServices();
            }
        }
        
        // --- LÓGICA DEL COTIZADOR ---
        const quoteClientSelect = document.getElementById('quoteClient');
        const quoteRUCInput = document.getElementById('quoteRUC');
        const serviceSelect = document.getElementById('serviceSelect');
        const quoteItemsBody = document.getElementById('quoteItems');
        const quoteNumberInput = document.getElementById('quoteNumber');
        const quoteNotesInput = document.getElementById('quoteNotes');

        function updateQuoteNumberPreview() {
            const selectedClientId = quoteClientSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            const clientCode = client ? client.code : 'CLIENTE';
            const sequential = quoteCounter.toString().padStart(4, '0');
            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            quoteNumberInput.value = `${clientCode}-${dateStr}-${sequential}`;
        }

        function updateClientDropdowns() {
            const selects = [quoteClientSelect, document.getElementById('contract-client-select'), document.getElementById('portal-client-select')];
            selects.forEach(select => {
                select.innerHTML = '<option value="">Seleccione un cliente</option>';
                clients.forEach(client => {
                    const option = document.createElement('option');
                    option.value = client.id;
                    option.textContent = `${client.name} (${client.code})`;
                    select.appendChild(option);
                });
            });
        }
        
        quoteClientSelect.addEventListener('change', () => {
            const selectedClientId = quoteClientSelect.value;
            const client = clients.find(c => c.id === selectedClientId);
            quoteRUCInput.value = client ? client.ruc : '';
            updateQuoteNumberPreview();
        });
        
        function updateServiceDropdown() {
            serviceSelect.innerHTML = '<option value="">Seleccione un servicio</option>';
            services.forEach(service => {
                const option = document.createElement('option');
                option.value = service.id;
                option.textContent = `${service.name} - $${parseFloat(service.price).toFixed(2)}`;
                serviceSelect.appendChild(option);
            });
        }

        function addServiceToQuote() {
            const serviceId = serviceSelect.value;
            if (!serviceId) { alert('Por favor, seleccione un servicio.'); return; }
            const service = services.find(s => s.id === serviceId);
            const existingItem = quoteItemsData.find(item => item.id === serviceId);
            if (existingItem) {
                existingItem.quantity++;
            } else {
                quoteItemsData.push({ id: service.id, name: service.name, description: service.description, price: service.price, quantity: 1 });
            }
            renderQuoteItems();
        }
        
        function renderQuoteItems() {
            quoteItemsBody.innerHTML = '';
            if (quoteItemsData.length === 0) {
                quoteItemsBody.innerHTML = `<tr><td colspan="5" class="text-center py-4 text-gray-500">Añada servicios a la cotización.</td></tr>`;
            } else {
                quoteItemsData.forEach((item, index) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td class="px-4 py-3 whitespace-normal align-top"><div class="font-medium text-gray-800">${item.name}</div><div class="text-xs text-gray-500 mt-1">${item.description || ''}</div></td><td class="px-4 py-3 align-top"><input type="number" min="1" value="${item.quantity}" onchange="updateQuantity(${index}, this.value)" class="w-20 p-1 border border-gray-300 rounded-md"></td><td class="px-4 py-3 whitespace-nowrap align-top">$${item.price.toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap font-medium align-top">$${(item.price * item.quantity).toFixed(2)}</td><td class="px-4 py-3 whitespace-nowrap text-right align-top"><button onclick="removeQuoteItem(${index})" class="text-red-600 hover:text-red-900"><i class="fas fa-trash"></i></button></td>`;
                    quoteItemsBody.appendChild(row);
                });
            }
            calculateTotals();
        }

        function updateQuantity(index, quantity) {
            quoteItemsData[index].quantity = parseInt(quantity) || 1;
            renderQuoteItems();
        }

        function removeQuoteItem(index) {
            quoteItemsData.splice(index, 1);
            renderQuoteItems();
        }

        function calculateTotals() {
            const subtotal = quoteItemsData.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const iva = parseFloat((subtotal * IVA_RATE).toFixed(2));
            const total = parseFloat((subtotal + iva).toFixed(2));
            document.getElementById('subtotal').textContent = `$${subtotal.toFixed(2)}`;
            document.getElementById('iva').textContent = `$${iva.toFixed(2)}`;
            document.getElementById('total').textContent = `$${total.toFixed(2)}`;
        }

        // --- LÓGICA DE CONFIGURACIÓN ---
        const configForm = document.getElementById('configForm');
        const companyNameInput = document.getElementById('companyName');
        const companyAddressInput = document.getElementById('companyAddress');
        const companyContactInput = document.getElementById('companyContact');
        const companyWebsiteInput = document.getElementById('companyWebsite');
        const companyWhatsappInput = document.getElementById('companyWhatsapp');
        const logoUploadInput = document.getElementById('logoUpload');
        const logoPreview = document.getElementById('logoPreview');
        const primaryColorInput = document.getElementById('primaryColor');
        const accentColorInput = document.getElementById('accentColor');

        function loadSettings() {
            companyNameInput.value = companySettings.name;
            companyAddressInput.value = companySettings.address;
            companyContactInput.value = companySettings.contact;
            companyWebsiteInput.value = companySettings.website || '';
            companyWhatsappInput.value = companySettings.whatsapp || '';
            logoPreview.src = companySettings.logo;
            primaryColorInput.value = companySettings.primaryColor;
            accentColorInput.value = companySettings.accentColor;
            
            document.getElementById('total-label').style.color = companySettings.accentColor;
            document.getElementById('total').style.color = companySettings.accentColor;
        }

        logoUploadInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    const logoBase64 = event.target.result;
                    logoPreview.src = logoBase64;
                    companySettings.logo = logoBase64;
                    localStorage.setItem('companySettings', JSON.stringify(companySettings));
                };
                reader.readAsDataURL(file);
            }
        });

        configForm.addEventListener('submit', (e) => {
            e.preventDefault();
            companySettings.name = companyNameInput.value;
            companySettings.address = companyAddressInput.value;
            companySettings.contact = companyContactInput.value;
            companySettings.website = companyWebsiteInput.value;
            companySettings.whatsapp = companyWhatsappInput.value;
            companySettings.primaryColor = primaryColorInput.value;
            companySettings.accentColor = accentColorInput.value;
            localStorage.setItem('companySettings', JSON.stringify(companySettings));
            loadSettings();
            alert('Configuración guardada exitosamente.');
        });

        // --- LÓGICA DE HISTORIAL ---
        const quotesHistoryList = document.getElementById('quotesHistoryList');

        function renderQuotesHistory() {
            quotesHistoryList.innerHTML = '';
            if (quotesHistory.length === 0) {
                quotesHistoryList.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-gray-500">No hay cotizaciones en el historial.</td></tr>`;
            } else {
                [...quotesHistory].reverse().forEach(quote => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td class="px-4 py-3 whitespace-nowrap font-mono text-xs">${quote.number}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${quote.client.name}</td>
                        <td class="px-4 py-3 whitespace-nowrap">${quote.issueDate}</td>
                        <td class="px-4 py-3 whitespace-nowrap font-semibold">$${quote.total.toFixed(2)}</td>
                        <td class="px-4 py-3 whitespace-nowrap">
                            <select onchange="updateQuoteStatus('${quote.id}', this.value)" class="p-1 rounded-md border-gray-300 text-xs focus:ring-indigo-500 focus:border-indigo-500 status-${quote.status}">
                                <option value="Pendiente" ${quote.status === 'Pendiente' ? 'selected' : ''}>Pendiente</option>
                                <option value="Aceptada" ${quote.status === 'Aceptada' ? 'selected' : ''}>Aceptada</option>
                                <option value="Rechazada" ${quote.status === 'Rechazada' ? 'selected' : ''}>Rechazada</option>
                            </select>
                        </td>
                        <td class="px-4 py-3 whitespace-nowrap text-right text-sm font-medium">
                            <button onclick="loadQuoteForEdit('${quote.id}')" class="text-blue-600 hover:text-blue-900 mr-2" title="Cargar para Editar"><i class="fas fa-pencil-alt"></i></button>
                            <button onclick="reprintQuote('${quote.id}')" class="text-indigo-600 hover:text-indigo-900" title="Ver / Reimprimir"><i class="fas fa-eye"></i></button>
                        </td>`;
                    quotesHistoryList.appendChild(row);
                });
            }
        }

        function updateQuoteStatus(quoteId, newStatus) {
            const quoteIndex = quotesHistory.findIndex(q => q.id === quoteId);
            if (quoteIndex > -1) {
                quotesHistory[quoteIndex].status = newStatus;
                localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
                renderQuotesHistory();
                renderDashboard();
            }
        }
        
        function loadQuoteForEdit(quoteId) {
            const quote = quotesHistory.find(q => q.id === quoteId);
            if (quote) {
                quoteClientSelect.value = quote.client.id;
                quoteItemsData = [...quote.items];
                quoteNotesInput.value = quote.notes || '';
                
                const event = new Event('change');
                quoteClientSelect.dispatchEvent(event);
                
                renderQuoteItems();
                changeTab({currentTarget: document.querySelector('.tab-button[onclick*="cotizador"]')}, 'cotizador');
                alert(`Cotización ${quote.number} cargada. Puede modificarla y generar una nueva versión.`);
            }
        }

        // --- LÓGICA DEL DASHBOARD ---
        function renderDashboard() {
            const acceptedQuotes = quotesHistory.filter(q => q.status === 'Aceptada');
            const totalSales = acceptedQuotes.reduce((sum, q) => sum + q.total, 0);
            const averageSale = acceptedQuotes.length > 0 ? totalSales / acceptedQuotes.length : 0;

            document.getElementById('total-sales').textContent = `$${totalSales.toFixed(2)}`;
            document.getElementById('average-sale').textContent = `$${averageSale.toFixed(2)}`;
            document.getElementById('total-quotes').textContent = quotesHistory.length;

            // Best Seller Logic
            const salesByProduct = {};
            acceptedQuotes.forEach(q => {
                q.items.forEach(item => {
                    if (!salesByProduct[item.name]) {
                        salesByProduct[item.name] = 0;
                    }
                    salesByProduct[item.name] += item.quantity;
                });
            });

            let bestSeller = '-';
            let maxQuantity = 0;
            for (const productName in salesByProduct) {
                if (salesByProduct[productName] > maxQuantity) {
                    maxQuantity = salesByProduct[productName];
                    bestSeller = productName;
                }
            }
            document.getElementById('best-seller').textContent = bestSeller;

            // Sales by month chart logic
            const salesByMonth = {};
            acceptedQuotes.forEach(q => {
                const [day, month, year] = q.issueDate.split('/');
                const monthYear = `${year}-${month}`;
                if (!salesByMonth[monthYear]) salesByMonth[monthYear] = 0;
                salesByMonth[monthYear] += q.total;
            });

            const chartData = Object.keys(salesByMonth).map(key => ({
                month: key,
                sales: salesByMonth[key]
            })).sort((a, b) => new Date(a.month) - new Date(b.month));
            
            drawSalesChart(chartData);
        }

        function drawSalesChart(data) {
            const container = d3.select("#sales-chart-container");
            container.selectAll("*").remove(); 

            if (data.length === 0) {
                container.append("div").attr("class", "flex items-center justify-center h-full text-gray-500").text("No hay ventas aceptadas para mostrar en el gráfico.");
                return;
            }

            const margin = {top: 20, right: 20, bottom: 70, left: 80};
            const width = container.node().getBoundingClientRect().width - margin.left - margin.right;
            const height = container.node().getBoundingClientRect().height - margin.top - margin.bottom;

            const svg = container.append("svg").attr("width", width + margin.left + margin.right).attr("height", height + margin.top + margin.bottom).append("g").attr("transform", `translate(${margin.left},${margin.top})`);
            const x = d3.scaleBand().range([0, width]).domain(data.map(d => d.month)).padding(0.2);
            svg.append("g").attr("transform", `translate(0,${height})`).call(d3.axisBottom(x)).selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");
            const y = d3.scaleLinear().domain([0, d3.max(data, d => d.sales)]).range([height, 0]);
            svg.append("g").call(d3.axisLeft(y).tickFormat(d => `$${d.toLocaleString('es-EC')}`));
            svg.selectAll("mybar").data(data).enter().append("rect").attr("x", d => x(d.month)).attr("y", d => y(d.sales)).attr("width", x.bandwidth()).attr("height", d => height - y(d.sales)).attr("fill", companySettings.accentColor);
        }
        
        // --- LÓGICA DE CONTRATOS ---
        const contractClientSelect = document.getElementById('contract-client-select');
        const contractQuoteSelect = document.getElementById('contract-quote-select');
        const contractText = document.getElementById('contract-text');
        const saveContractBtn = document.getElementById('save-contract-btn');

        function renderContractsPage() {
            contractClientSelect.dispatchEvent(new Event('change'));
        }

        contractClientSelect.addEventListener('change', () => {
            const clientId = contractClientSelect.value;
            contractQuoteSelect.innerHTML = '<option value="">Seleccione una cotización</option>';
            contractText.value = '';
            saveContractBtn.disabled = true;

            if (clientId) {
                const clientQuotes = quotesHistory.filter(q => q.client.id === clientId && q.status === 'Aceptada');
                clientQuotes.forEach(q => {
                    const option = document.createElement('option');
                    option.value = q.id;
                    option.textContent = q.number;
                    contractQuoteSelect.appendChild(option);
                });
            }
        });

        contractQuoteSelect.addEventListener('change', () => {
            const quoteId = contractQuoteSelect.value;
            contractText.value = '';
            saveContractBtn.disabled = !quoteId;

            if (quoteId) {
                const contract = contracts.find(c => c.quoteId === quoteId);
                if (contract) {
                    contractText.value = contract.text;
                }
            }
        });

        saveContractBtn.addEventListener('click', () => {
            const quoteId = contractQuoteSelect.value;
            const text = contractText.value;
            if (!quoteId) return;

            const contractIndex = contracts.findIndex(c => c.quoteId === quoteId);
            if (contractIndex > -1) {
                contracts[contractIndex].text = text;
            } else {
                contracts.push({ quoteId, text });
            }
            localStorage.setItem('contracts', JSON.stringify(contracts));
            alert('Contrato guardado exitosamente.');
        });

        // --- LÓGICA PORTAL CLIENTE ---
        const portalClientSelect = document.getElementById('portal-client-select');
        const clientPortalContent = document.getElementById('client-portal-content');

        function renderClientPortalPage() {
            portalClientSelect.dispatchEvent(new Event('change'));
        }
        
        portalClientSelect.addEventListener('change', () => {
            const clientId = portalClientSelect.value;
            if (!clientId) {
                clientPortalContent.innerHTML = '<p class="text-gray-500">Seleccione un cliente para empezar.</p>';
                return;
            }

            const clientQuotes = quotesHistory.filter(q => q.client.id === clientId);
            if (clientQuotes.length === 0) {
                clientPortalContent.innerHTML = '<p class="text-gray-500">Este cliente no tiene cotizaciones en el historial.</p>';
                return;
            }
            
            let contentHtml = '';
            [...clientQuotes].reverse().forEach(quote => {
                const contract = contracts.find(c => c.quoteId === quote.id);
                contentHtml += `
                    <div class="mb-6 pb-4 border-b">
                        <div class="flex justify-between items-center">
                            <h3 class="text-lg font-bold">${quote.number}</h3>
                            <span class="status-badge status-${quote.status}">${quote.status}</span>
                        </div>
                        <p class="text-sm text-gray-600">Fecha: ${quote.issueDate} | Total: <b>$${quote.total.toFixed(2)}</b></p>
                        ${contract ? `
                            <div class="mt-4 p-4 bg-gray-50 rounded-lg">
                                <h4 class="font-semibold text-sm">Contrato Asociado</h4>
                                <p class="text-xs text-gray-700 mt-2 whitespace-pre-wrap">${contract.text}</p>
                            </div>
                        ` : ''}
                    </div>
                `;
            });
            clientPortalContent.innerHTML = contentHtml;
        });

        // --- LÓGICA DE IMPRESIÓN ---
        function buildPrintableHtml(quoteData) {
            const { companySettings: cs, client, items, number, issueDate, validityDate, subtotal, iva, total, notes } = quoteData;
            const logoHtml = cs.logo ? `<img src="${cs.logo}" alt="Logo de la empresa" style="max-height: 80px; width: auto;">` : '';
            const itemsHtml = items.map(item => `<tr class="border-b"><td class="py-3 px-4 align-top"><p class="font-semibold">${item.name}</p><p class="text-sm text-gray-600 pl-2 mt-1">${item.description || ''}</p></td><td class="py-3 px-4 text-center align-top">${item.quantity}</td><td class="py-3 px-4 text-right align-top">$${item.price.toFixed(2)}</td><td class="py-3 px-4 text-right align-top">$${(item.price * item.quantity).toFixed(2)}</td></tr>`).join('');
            const notesHtml = notes ? `<div class="mt-10 pt-4 border-t"><h4 class="font-bold text-sm mb-2">Notas:</h4><p class="text-xs text-gray-600 whitespace-pre-wrap">${notes}</p></div>` : '';

            let footerLinksHtml = '';
            if (cs.website || cs.whatsapp) {
                const websiteLink = cs.website ? `<a href="${cs.website}" target="_blank" class="text-sm" style="color: ${cs.primaryColor}; text-decoration: none;">${cs.website.replace(/^(https?:\/\/)?(www\.)?/, '')}</a>` : '';
                const whatsappLink = cs.whatsapp ? `<a href="https://wa.me/${cs.whatsapp}" target="_blank" class="text-sm" style="color: ${cs.primaryColor}; text-decoration: none;"><i class="fab fa-whatsapp"></i> ${cs.whatsapp}</a>` : '';
                footerLinksHtml = `<div class="mb-4 text-center">${websiteLink}${websiteLink && whatsappLink ? '<span class="mx-2">|</span>' : ''}${whatsappLink}</div>`;
            }

            return `
                <div class="p-8 max-w-4xl mx-auto bg-white font-sans">
                    <header class="flex justify-between items-start mb-10 pb-4 border-b"><div class="w-1/2">${logoHtml}</div><div class="w-1/2 text-right"><h1 class="text-3xl font-bold" style="color: ${cs.primaryColor};">COTIZACIÓN</h1><p class="text-gray-600 mt-1">Nº: ${number}</p></div></header>
                    <div class="grid grid-cols-2 gap-8 mb-10">
                        <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-bold text-gray-700 mb-2 uppercase text-sm">Cliente:</h3><p class="font-semibold">${client.name}</p><p>RUC/C.I.: ${client.ruc}</p><p>${client.contact}</p></div>
                        <div class="bg-gray-50 p-4 rounded-lg"><h3 class="font-bold text-gray-700 mb-2 uppercase text-sm">De:</h3><p class="font-semibold">${cs.name}</p><p>${cs.address}</p><p>${cs.contact}</p></div>
                    </div>
                    <div class="grid grid-cols-2 gap-8 mb-10"><div><h3 class="font-bold text-gray-700 mb-2 uppercase text-sm">Fechas:</h3><p>Fecha de Emisión: ${issueDate}</p><p>Válida hasta: ${validityDate}</p></div></div>
                    <table class="w-full mb-8"><thead style="background-color: ${cs.primaryColor}; color: white;"><tr><th class="py-2 px-4 text-left font-semibold">Descripción</th><th class="py-2 px-4 text-center font-semibold">Cantidad</th><th class="py-2 px-4 text-right font-semibold">P. Unitario</th><th class="py-2 px-4 text-right font-semibold">Total</th></tr></thead><tbody>${itemsHtml}</tbody></table>
                    <div class="flex justify-end"><div class="w-full md:w-1/2 lg:w-2/5"><div class="flex justify-between py-2"><span class="font-medium">Subtotal:</span><span>$${subtotal.toFixed(2)}</span></div><div class="flex justify-between py-2"><span class="font-medium">IVA (15%):</span><span>$${iva.toFixed(2)}</span></div><div class="flex justify-between py-3 mt-2 border-t-2" style="border-color: ${cs.primaryColor};"><span class="font-bold text-xl" style="color: ${cs.accentColor};">TOTAL:</span><span class="font-bold text-xl" style="color: ${cs.accentColor};">$${total.toFixed(2)}</span></div></div></div>
                    ${notesHtml}
                    <footer class="mt-16 text-center text-gray-500">
                        ${footerLinksHtml}
                        <p class="text-sm">Gracias por su preferencia.</p>
                        <p class="text-xs">Esta es una cotización generada por sistema y no requiere firma.</p>
                    </footer>
                </div>
            `;
        }

        function reprintQuote(quoteId) {
            const quoteData = quotesHistory.find(q => q.id === quoteId);
            if (quoteData) {
                document.getElementById('print-area').innerHTML = buildPrintableHtml(quoteData);
                setTimeout(() => { window.print(); }, 500);
            }
        }

        function generatePrintableQuote() {
            const client = clients.find(c => c.id === quoteClientSelect.value);
            if (!client) { alert('Por favor, seleccione un cliente.'); return; }
            if (quoteItemsData.length === 0) { alert('Por favor, añada al menos un servicio a la cotización.'); return; }

            const now = new Date();
            const dateStr = `${now.getFullYear()}${(now.getMonth() + 1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}`;
            const timeStr = `${now.getHours().toString().padStart(2, '0')}${now.getMinutes().toString().padStart(2, '0')}`;
            const sequential = quoteCounter.toString().padStart(4, '0');
            const finalQuoteNumber = `${client.code}-${dateStr}${timeStr}-${sequential}`;

            const quoteDate = document.getElementById('quoteDate').value;
            const validityDate = quoteDate ? new Date(quoteDate + 'T00:00:00').toLocaleDateString('es-EC') : 'N/A';
            const issueDate = now.toLocaleDateString('es-EC');

            const subtotal = quoteItemsData.reduce((acc, item) => acc + (item.price * item.quantity), 0);
            const iva = parseFloat((subtotal * IVA_RATE).toFixed(2));
            const total = parseFloat((subtotal + iva).toFixed(2));
            
            const quoteRecord = {
                id: `quote_${new Date().getTime()}`, number: finalQuoteNumber, issueDate: issueDate, validityDate: validityDate, client: { ...client }, items: [...quoteItemsData], subtotal: subtotal, iva: iva, total: total, notes: quoteNotesInput.value, status: 'Pendiente', companySettings: { ...companySettings }
            };

            document.getElementById('print-area').innerHTML = buildPrintableHtml(quoteRecord);
            
            setTimeout(() => {
                window.print();
                quotesHistory.push(quoteRecord);
                localStorage.setItem('quotesHistory', JSON.stringify(quotesHistory));
                renderQuotesHistory();
                quoteCounter++;
                localStorage.setItem('quoteCounter', quoteCounter.toString());
                updateQuoteNumberPreview();
                quoteItemsData = [];
                quoteNotesInput.value = '';
                renderQuoteItems();
            }, 500);
        }

        // --- INICIALIZACIÓN ---
        function initializeData() {
            renderClients();
            renderServices();
            renderQuoteItems();
            updateQuoteNumberPreview();
            loadSettings();
            renderQuotesHistory();
            renderDashboard();
            document.querySelectorAll('.tab-button')[0].classList.add('active');
            document.querySelectorAll('.tab-content')[0].classList.add('active');
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (sessionStorage.getItem('isLoggedIn') === 'true') {
                showApp();
                initializeData();
            }
        });
    </script>
</body>
</html>
